import{_ as K,a as j,b as A}from"./TaskListItemPopupMenu.vue_vue_type_script_setup_true_lang-1y900fcK.js";import{d as S,u as E,a as z,r as k,c as x,b as H,o as r,e as c,f as e,g as _,h as b,w as B,i as N,t as h,j as R,k as q,n as U,l as M,m as T,p as F,q as W,T as G,s as O,v as Y,x as J,F as D,y as L,z as P,A as Q,B as X,C as Z,D as ee,E as te}from"./index-8GM9p_88.js";import{C as V}from"./ContenteditableBlock-gxQLz-3T.js";import"./rangy-5rxgwlWZ.js";const se={key:0,class:"tw-hidden group-hover:tw-block"},ae={class:"smaller tw-flex tw-items-center tw-gap-2"},oe={key:0},le={class:"icon userpic"},ne=["src"],re={key:1,class:"tw-truncate"},ie={class:"tw-whitespace-nowrap opacity-60"},ce={key:2,class:"opacity-60"},ue=S({__name:"TaskInfoChatItem",props:{message:{}},setup(g){const l=g,w=E(),s=z(),n=k(),i=k(!1),a=x(()=>l.message.contact_id===H.contact_id),p=x(()=>w.getItemById(l.message.contact_id)),y=async()=>{confirm("Are You sure?")&&await s.deleteItem(l.message)},t=async()=>{i.value=!0,await M(),n.value.focus()},f=async m=>{await s.updateItem(l.message,{comment:m})};return(m,u)=>{var $;return r(),c("div",{class:U(["tw-group tw-flex tw-gap-2",{"tw-justify-end":a.value}])},[a.value?(r(),c("div",se,[e("div",{class:"gray tw-cursor-pointer hover:tw-opacity-60 tw-transition-all",onClick:y},u[2]||(u[2]=[e("i",{class:"fas fa-trash-alt"},null,-1)])),e("div",{class:"gray tw-cursor-pointer hover:tw-opacity-60 tw-transition-all",onClick:t},u[3]||(u[3]=[e("i",{class:"fas fa-edit"},null,-1)]))])):_("",!0),e("div",{class:U(["blank box rounded tw-flex-none tw-w-[80%] tw-flex tw-flex-col tw-gap-2",{"tw-bg-[var(--accent-color)] text-white":a.value}])},[b(V,{ref_key:"contenteditableRef",ref:n,editable:i.value,focusable:!0,value:l.message.comment||"",tag:"div",class:"small",onBlur:u[0]||(u[0]=I=>i.value=!1),onUpdate:f,onKeydown:u[1]||(u[1]=B(N(I=>{var o,d;return(d=(o=I.target)==null?void 0:o.blur)==null?void 0:d.call(o)},["stop"]),["esc"]))},null,8,["editable","value"]),e("div",ae,[p.value&&!a.value?(r(),c("div",oe,[e("span",le,[e("img",{src:($=p.value)==null?void 0:$.photo_url,alt:""},null,8,ne)])])):_("",!0),p.value&&!a.value?(r(),c("div",re,h(p.value.name),1)):_("",!0),e("div",ie,h(R(q)(l.message.create_datetime).format("ll")),1),typeof l.message.id=="number"?(r(),c("div",ce,u[4]||(u[4]=[e("i",{class:"fas fa-check fa-xs"},null,-1)]))):_("",!0)])],2)],2)}}}),de={class:"tw-flex tw-flex-col tw-h-full"},pe={class:"tw-flex-auto tw-flex tw-flex-col tw-gap-3"},me={class:"tw-flex-none tw-sticky tw-bottom-0 custom-py-12 pl-chat-input"},fe={class:"state-with-inner-icon right width-100"},ve=["placeholder"],we=S({__name:"TaskInfoChat",props:{taskId:{}},emits:["update"],setup(g,{emit:l}){const w=l,s=g,n=z(),i=k(),a=k(""),p=x(()=>n.getComentsByTaskId(s.taskId));T(()=>s.taskId,t=>J(t)&&n.fetch({item_id:t}),{immediate:!0}),T(p,async()=>{p.value.length&&(await M(),w("update"))},{immediate:!0}),F(()=>{i.value.focus()}),T(()=>s.taskId,()=>{i.value.focus()});const y=async()=>{if(!a.value)return;const t=await n.insert(s.taskId);t&&(n.updateItem(t,{comment:a.value}),a.value="",i.value.focus())};return(t,f)=>(r(),c("div",de,[e("div",pe,[b(G,{name:"list"},{default:W(()=>[(r(!0),c(D,null,L(p.value,m=>(r(),P(ue,{key:m.uuid||m.id,message:m},null,8,["message"]))),128))]),_:1})]),e("div",me,[e("div",fe,[O(e("input",{ref_key:"inputRef",ref:i,"onUpdate:modelValue":f[0]||(f[0]=m=>a.value=m),type:"text",placeholder:t.$t("Message"),class:"width-100 blank",onKeydown:B(y,["enter"])},null,40,ve),[[Y,a.value,void 0,{trim:!0}]]),e("button",{class:"icon",onClick:y},f[1]||(f[1]=[e("i",{class:"fas fa-arrow-right"},null,-1)]))])])]))}});function _e(g){const l=g.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"),w=/(https?:\/\/[^\s<"']+|ftp:\/\/[^\s<"']+|www\.[^\s<"']+\.[^\s<"']+|[\w.+-]+@[a-z\d-]+\.[a-z]+(?:\.[a-z]+)*)/gi;return l.replace(w,s=>{let n=s,i=s;return s.includes("@")?s.startsWith("mailto:")||(n=`mailto:${s}`):s.match(/^https?:\/\/|^ftp:\/\//)||(n=`https://${s}`,i=s.replace(/^www\./,"")),`<a href="${n.replace(/"/g,"%22").replace(/'/g,"%27").replace(/</g,"%3C").replace(/>/g,"%3E")}" target="_blank" rel="noopener noreferrer nofollow">${i}</a>`})}const ge={key:0,class:"tw-h-full tw-flex tw-flex-col"},he={class:"pl-bg-block tw-flex-none custom-px-20 custom-pt-16"},ke={class:"custom-mb-24"},ye={key:0,class:"custom-mb-12"},be={class:"flexbox middle space-8 wrap",title:"{{ $t('Created by') }}"},xe={class:"wide"},$e={class:"small"},Ie={key:0,class:"hint custom-ml-4 tw-whitespace-nowrap"},Ce={class:"custom-mb-12"},Te={key:1,class:"custom-mb-12"},Re=["href"],Se=["src"],Be=["href"],Me={class:"hint custom-ml-4"},De=S({__name:"TaskInfo",props:{taskId:{}},setup(g){const l=g,w=Q(),s=k(),n=X(),i=E(),a=k(!1),p=k(),y=async()=>{a.value=!0,await M(),p.value.focus()},t=x(()=>n.getItemById(l.taskId)),f=x(()=>i.getItemById(t.value.contact_id));Z(document,"keydown",o=>{o.code==="Escape"&&m()});const m=()=>{var d;const o=(d=[...w.currentRoute.value.matched].reverse().find(C=>C.meta.isListView))==null?void 0:d.name;o?w.push({name:o}):console.error("Cant find back route")},u=()=>{setTimeout(()=>{s.value.scrollTo({top:s.value.scrollHeight})},100)},$=async o=>{await n.updateItem(l.taskId,{note:o.trim()})};function I(o){return new URL(Object.assign({"../assets/apps/shop.svg":j,"../assets/apps/tasks.svg":A})[`../assets/apps/${o}.svg`],import.meta.url).href}return(o,d)=>{var C;return t.value?(r(),c("div",ge,[e("div",{class:"tw-flex-none custom-p-12"},[e("a",{class:"back larger",onClick:m},d[2]||(d[2]=[e("i",{class:"fas fa-arrow-circle-left"},null,-1)]))]),e("div",he,[e("h3",null,h(t.value.name),1),e("div",ke,[b(V,{ref_key:"testRef",ref:p,tag:"div",value:a.value?t.value.note||"":t.value.note?R(_e)(t.value.note):o.$t("addNote"),placeholder:o.$t("addNote"),editable:a.value,focusable:!0,class:"hint",onClick:y,onBlur:d[0]||(d[0]=v=>a.value=!1),onUpdate:$,onKeydown:d[1]||(d[1]=B(N(v=>{v.target.blur()},["stop"]),["esc"]))},null,8,["value","placeholder","editable"])]),f.value?(r(),c("div",ye,[e("div",be,[e("span",{class:"icon userpic userpic-20",style:ee({backgroundImage:`url(${f.value.photo_url})`})},null,4),e("span",xe,[e("span",$e,h(f.value.name),1),t.value.create_datetime?(r(),c("span",Ie,h(R(te)(t.value.create_datetime)),1)):_("",!0)])])])):_("",!0),e("div",Ce,[b(K,{task:t.value},null,8,["task"])]),(C=t.value.external_links)!=null&&C.length?(r(),c("div",Te,[(r(!0),c(D,null,L(t.value.external_links,v=>(r(),c("div",{key:v.id},[e("a",{href:v.entity_link,class:"icon size-20",target:"_blank"},[e("img",{src:I(v.app)},null,8,Se)],8,Re),e("a",{class:"custom-ml-4",href:v.entity_link},h(v.entity_title),9,Be),e("span",Me,h(v.app),1)]))),128))])):_("",!0)]),e("div",{ref_key:"containerRef",ref:s,class:"tw-flex-auto custom-p-12 custom-pb-0 tw-overflow-scroll hide-scrollbar"},[b(we,{"task-id":o.taskId,onUpdate:u},null,8,["task-id"])],512)])):_("",!0)}}});export{De as default};
