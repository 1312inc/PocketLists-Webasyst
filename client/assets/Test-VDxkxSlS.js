import{d as E,u as U,a as V,f as M,l as N,b as q,c as k,_ as K,e as O,g as j,h as y,i as z,r as h,o as _,j as g,k as e,w as b,t as x,m as C,O as G,n as I,p as B,q as H,T as Q,s as J,v as P,x as W,y as X,F as Y,z as Z,A as L,B as ee}from"./index-q0Rk444w.js";import{C as te}from"./ContenteditableBlock-znpTQAtp.js";import"./rangy-5rxgwlWZ.js";const $=E("comments",()=>{const u=U(),t=V(M(N(()=>q.comments.toArray())),{initialValue:[]}),a=k(()=>t.value.filter(d=>!d.deleted)),l=k(()=>d=>a.value.find(o=>o.id===d)),s=k(()=>d=>{const o=u.getItemById(d);return K.sortBy(a.value.filter(c=>c.item_id===(o==null?void 0:o.uuid)||c.item_id===(o==null?void 0:o.id)),["create_datetime"])}),{defineFetch:n,defineFetchAdd:m,defineFetchUpdate:r,defineFetchDelete:i,commit:w,updateItem:f,deleteItem:p}=O("comments"),S=n("pocketlists.comment.getList"),T=m("pocketlists.comment.add"),A=r("pocketlists.comment.update"),R=i("pocketlists.comment.delete"),D=(d,o)=>{const c=j(d,o);c&&w(c)};return u.$onAction(({name:d,after:o})=>{d==="fetchAdd"&&o(c=>{c==null||c.forEach(v=>{v.uuid&&s.value(v.uuid).forEach(F=>{f(F,{item_id:v.id},{quietly:!0})})})}),d==="deleteItem"&&o(c=>{s.value(c).forEach(v=>{p(v,{force:!0})})})}),{allItems:t,items:a,getItemById:l,getComentsByTaskId:s,insert:D,updateItem:f,deleteItem:p,fetch:S,fetchAdd:T,fetchUpdate:A,fetchDelete:R}}),se={class:"tw-flex tw-flex-col tw-gap-2 tw-bg-background tw-p-4 tw-rounded-lg tw-rounded-tl-0 tw-text-sm tw-mr-4"},oe={class:"tw-flex"},ae={class:"tw-flex tw-gap-2"},ne={class:"tw-truncate"},le={class:"hint"},ie={class:"hint"},ce=y({__name:"TaskChatItem",props:{message:{}},setup(u){const t=u,a=z(),l=$(),s=h(!1),n=()=>{l.deleteItem(t.message)},m=r=>{l.updateItem(t.message,{comment:r})};return(r,i)=>{var w;return _(),g("div",se,[e("div",oe,[e("a",{onClick:b(n,["prevent"])},i[1]||(i[1]=[e("i",{class:"fas fa-times"},null,-1)])),e("a",{onClick:i[0]||(i[0]=b(f=>s.value=!0,["prevent"]))},i[2]||(i[2]=[e("i",{class:"fas fa-edit"},null,-1)]))]),e("div",ae,[e("div",ne,x((w=C(a).getItemById(t.message.contact_id))==null?void 0:w.name),1),e("div",le,x(C(G)(t.message.create_datetime).format("ll")),1)]),I(te,{editable:s.value,focusable:!0,value:t.message.comment,tag:"div",onUpdate:m},null,8,["editable","value"]),e("div",ie,x(typeof t.message=="number"?"delivered":"not delivered"),1)])}}}),de={class:"tw-h-full tw-flex tw-flex-col"},re={class:"tw-flex-none tw-sticky tw-py-3 pl-bg-block"},ue={class:"state-with-inner-icon right tw-w-full"},me=y({__name:"TaskChat",props:{taskId:{}},setup(u){const t=u,a=$(),l=h(),s=h(),n=k(()=>a.getComentsByTaskId(t.taskId)),m=h(!1),r=h("");B(()=>t.taskId,w=>{a.fetch({item_id:w})},{immediate:!0}),B(n,async()=>{await X(),l.value&&(l.value.scrollTop=l.value.scrollHeight),m.value=!0});const i=async()=>{await a.insert(t.taskId,r.value),r.value="",s.value.focus()};return(w,f)=>(_(),g("div",de,[e("div",{ref_key:"chatContainerRef",ref:l,class:"tw-flex-auto tw-flex tw-flex-col tw-gap-3 tw-overflow-x-hidden tw-overflow-y-auto"},[I(Q,{name:"slide-right",css:m.value},{default:H(()=>[(_(!0),g(Y,null,Z(n.value,p=>(_(),L(ce,{key:p.id,message:p},null,8,["message"]))),128))]),_:1},8,["css"])],512),e("div",re,[e("div",ue,[J(e("input",{ref_key:"inputRef",ref:s,"onUpdate:modelValue":f[0]||(f[0]=p=>r.value=p),type:"text",placeholder:"Type a message",class:"tw-w-full",onKeydown:W(i,["enter"])},null,544),[[P,r.value]]),e("button",{class:"icon",onClick:i},f[1]||(f[1]=[e("i",{class:"fas fa-arrow-right"},null,-1)]))])])]))}}),fe={class:"pl-bg-block tw-rounded-xl lg:tw-rounded-r-0 tw-h-full tw-h-full tw-flex tw-flex-col"},we={class:"tw-flex-auto tw-flex tw-flex-col tw-gap-4 tw-overflow-hidden tw-p-3 tw-pb-0"},pe={class:"tw-flex-auto tw-min-h-0"},ke=y({__name:"Test",props:{taskId:{}},setup(u){const t=u,a=ee(),l=()=>{var n;const s=(n=a.currentRoute.value.matched.find(m=>m.meta.isListView))==null?void 0:n.name;s?a.push({name:s}):console.error("Cant find back route")};return(s,n)=>(_(),g("div",fe,[e("div",{class:"tw-flex-none tw-p-3"},[e("button",{class:"circle gray",onClick:l},n[0]||(n[0]=[e("i",{class:"fas fa-times"},null,-1)]))]),e("div",we,[e("div",pe,[I(me,{"task-id":t.taskId},null,8,["task-id"])])])]))}});export{ke as default};
