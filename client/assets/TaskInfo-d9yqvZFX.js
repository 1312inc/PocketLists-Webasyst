import{d as U,u as $,a as V,f as M,l as q,b as K,c as k,_ as L,e as j,g as z,h as T,i as G,r as g,o as y,j as I,k as e,w as S,t as b,m as C,n as H,p as O,q as B,s as D,v as Q,T as J,x as P,y as W,z as X,A as Y,B as Z,F as ee,C as te,D as se,E as ae}from"./index-U5l9bTvj.js";import{C as oe}from"./ContenteditableBlock-4-7Lhzdz.js";import"./rangy-5rxgwlWZ.js";const A=U("comment",()=>{const u=$(),s=V(M(q(()=>K.comments.toArray())),{initialValue:[]}),l=k(()=>s.value.filter(d=>!d.deleted)),n=k(()=>d=>l.value.find(o=>o.id===d)),t=k(()=>d=>L.sortBy(l.value.filter(o=>o.item_id===d),[o=>Date.parse(o.create_datetime)])),{defineFetch:a,defineFetchAdd:c,defineFetchUpdate:m,defineFetchDelete:i,commit:r,updateItem:p,deleteItem:w,deleteItems:v}=j({tableName:"comments",entityName:"comment"}),f=a("pocketlists.comments.get"),R=c("pocketlists.comments.add"),F=m("pocketlists.comments.update"),E=i("pocketlists.comments.delete"),N=async d=>{const o=z({item_id:d});if(o)return await r(o),o};return u.$onAction(({name:d,after:o})=>{d==="fetchAdd"&&o(h=>{h&&h.forEach(_=>{_.uuid&&t.value(_.uuid).forEach(x=>{p(x,{item_id:_.id},{quietly:!0})})})}),d==="deleteItem"&&o(h=>{if(!h)return;const _=t.value(h.id).map(({id:x})=>x);v(_)})}),{allItems:s,items:l,getItemById:n,getComentsByTaskId:t,commit:r,insert:N,updateItem:p,deleteItem:w,fetch:f,fetchAdd:R,fetchUpdate:F,fetchDelete:E}}),ne={class:"tw-flex tw-flex-col tw-gap-2 tw-bg-background custom-p-16 tw-rounded-lg tw-rounded-tl-0 small custom-mr-16"},ie={class:"tw-flex tw-gap-2"},le={class:"tw-flex tw-gap-2"},ce={class:"tw-truncate"},re={class:"hint"},de={class:"hint"},ue=T({__name:"TaskInfoChatItem",props:{message:{}},setup(u){const s=u,l=G(),n=A(),t=g(!1),a=()=>{n.deleteItem(s.message)},c=m=>{n.updateItem(s.message,{comment:m})};return(m,i)=>{var r;return y(),I("div",ne,[e("div",ie,[e("a",{onClick:S(a,["prevent"])},i[1]||(i[1]=[e("i",{class:"fas fa-times"},null,-1)])),e("a",{onClick:i[0]||(i[0]=S(p=>t.value=!0,["prevent"]))},i[2]||(i[2]=[e("i",{class:"fas fa-edit"},null,-1)]))]),e("div",le,[e("div",ce,b((r=C(l).getItemById(s.message.contact_id))==null?void 0:r.name),1),e("div",re,b(C(H)(C(O)(s.message)).format("ll")),1)]),B(oe,{editable:t.value,focusable:!0,value:s.message.comment,tag:"div",onUpdate:c},null,8,["editable","value"]),e("div",de,b(typeof s.message.id=="number"?"delivered":"not delivered"),1)])}}}),me={class:"tw-h-full tw-flex tw-flex-col"},fe={class:"tw-flex-none tw-sticky custom-py-12 pl-bg-block"},pe={class:"state-with-inner-icon right width-100"},ve=T({__name:"TaskInfoChat",props:{taskId:{}},setup(u){const s=u,l=$(),n=A(),t=k(()=>l.getItemById(s.taskId)),a=k(()=>t.value?n.getComentsByTaskId(t.value.id):[]),c=g(),m=g(),i=g(!1),r=g("");D(()=>s.taskId,()=>{t.value&&Y(t.value)&&n.fetch({item_id:t.value.id})},{immediate:!0}),D(a,async()=>{await Z(),c.value&&(c.value.scrollTop=c.value.scrollHeight),i.value=!0});const p=async()=>{if(t.value){const w=await n.insert(t.value.id);w&&n.updateItem(w,{comment:r.value}),r.value="",m.value.focus()}};return(w,v)=>(y(),I("div",me,[e("div",{ref_key:"chatContainerRef",ref:c,class:"tw-flex-auto tw-flex tw-flex-col tw-gap-3 tw-overflow-x-hidden tw-overflow-y-auto"},[B(J,{name:"slide-right",css:i.value},{default:Q(()=>[(y(!0),I(ee,null,te(a.value,f=>(y(),se(ue,{key:f.uuid||f.id,message:f},null,8,["message"]))),128))]),_:1},8,["css"])],512),e("div",fe,[e("div",pe,[P(e("input",{ref_key:"inputRef",ref:m,"onUpdate:modelValue":v[0]||(v[0]=f=>r.value=f),type:"text",placeholder:"Type a message",class:"width-100",onKeydown:X(p,["enter"])},null,544),[[W,r.value]]),e("button",{class:"icon",onClick:p},v[1]||(v[1]=[e("i",{class:"fas fa-arrow-right"},null,-1)]))])])]))}}),we={class:"pl-bg-block tw-h-full tw-flex tw-flex-col"},he={class:"tw-flex-auto custom-p-12 custom-pb-0"},ye=T({__name:"TaskInfo",props:{taskId:{}},setup(u){const s=u,l=ae(),n=()=>{var a;const t=(a=[...l.currentRoute.value.matched].reverse().find(c=>c.meta.isListView))==null?void 0:a.name;t?l.push({name:t}):console.error("Cant find back route")};return(t,a)=>(y(),I("div",we,[e("div",{class:"tw-flex-none custom-p-12"},[e("button",{class:"circle gray",onClick:n},a[0]||(a[0]=[e("i",{class:"fas fa-times"},null,-1)]))]),e("div",he,[B(ve,{"task-id":s.taskId},null,8,["task-id"])])]))}});export{ye as default};
