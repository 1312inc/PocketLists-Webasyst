import{d as U,u as D,a as V,f as M,l as q,b as K,c as g,_ as L,e as j,g as z,h as C,i as G,r as _,o as k,j as x,k as e,w as S,t as I,m as b,n as H,p as O,q as T,s as $,v as Q,T as J,x as P,y as W,z as X,A as Y,B as Z,F as ee,C as te,D as se,E as ae}from"./index-KJ87pi7j.js";import{C as oe}from"./ContenteditableBlock-s974Dy0Q.js";import"./rangy-5rxgwlWZ.js";const A=U("comment",()=>{const m=D(),s=V(M(q(()=>K.comments.toArray())),{initialValue:[]}),n=g(()=>s.value.filter(d=>!d.deleted)),l=g(()=>d=>n.value.find(r=>r.id===d)),t=g(()=>d=>L.sortBy(n.value.filter(r=>r.item_id===d),[r=>Date.parse(r.create_datetime)])),{defineFetch:a,defineFetchAdd:i,defineFetchUpdate:f,defineFetchDelete:o,commit:c,updateItem:v,deleteItem:B,deleteItems:w}=j({tableName:"comments",entityName:"comment"}),p=a("pocketlists.comments.get"),R=i("pocketlists.comments.add"),F=f("pocketlists.comments.update"),E=o("pocketlists.comments.delete"),N=async(d,r)=>{const u=z(d,r);if(u&&await c(u))return u};return m.$onAction(({name:d,after:r})=>{d==="fetchAdd"&&r(u=>{u&&u.forEach(h=>{h.uuid&&t.value(h.uuid).forEach(y=>{v(y,{item_id:h.id},{quietly:!0})})})}),d==="deleteItem"&&r(u=>{if(!u)return;const h=t.value(u.id).map(({id:y})=>y);w(h)})}),{allItems:s,items:n,getItemById:l,getComentsByTaskId:t,commit:c,insert:N,updateItem:v,deleteItem:B,fetch:p,fetchAdd:R,fetchUpdate:F,fetchDelete:E}}),ne={class:"tw-flex tw-flex-col tw-gap-2 tw-bg-background custom-p-16 tw-rounded-lg tw-rounded-tl-0 small custom-mr-16"},le={class:"tw-flex tw-gap-2"},ie={class:"tw-flex tw-gap-2"},ce={class:"tw-truncate"},de={class:"hint"},re={class:"hint"},ue=C({__name:"TaskInfoChatItem",props:{message:{}},setup(m){const s=m,n=G(),l=A(),t=_(!1),a=()=>{l.deleteItem(s.message)},i=f=>{l.updateItem(s.message,{comment:f})};return(f,o)=>{var c;return k(),x("div",ne,[e("div",le,[e("a",{onClick:S(a,["prevent"])},o[1]||(o[1]=[e("i",{class:"fas fa-times"},null,-1)])),e("a",{onClick:o[0]||(o[0]=S(v=>t.value=!0,["prevent"]))},o[2]||(o[2]=[e("i",{class:"fas fa-edit"},null,-1)]))]),e("div",ie,[e("div",ce,I((c=b(n).getItemById(s.message.contact_id))==null?void 0:c.name),1),e("div",de,I(b(H)(b(O)(s.message)).format("ll")),1)]),T(oe,{editable:t.value,focusable:!0,value:s.message.comment,tag:"div",onUpdate:i},null,8,["editable","value"]),e("div",re,I(typeof s.message.id=="number"?"delivered":"not delivered"),1)])}}}),me={class:"tw-h-full tw-flex tw-flex-col"},fe={class:"tw-flex-none tw-sticky custom-py-12 pl-bg-block"},pe={class:"state-with-inner-icon right width-100"},ve=C({__name:"TaskInfoChat",props:{taskId:{}},setup(m){const s=m,n=D(),l=A(),t=g(()=>n.getItemById(s.taskId)),a=g(()=>t.value?l.getComentsByTaskId(t.value.id):[]),i=_(),f=_(),o=_(!1),c=_("");$(()=>s.taskId,()=>{t.value&&Y(t.value)&&l.fetch({item_id:t.value.id})},{immediate:!0}),$(a,async()=>{await Z(),i.value&&(i.value.scrollTop=i.value.scrollHeight),o.value=!0});const v=async()=>{t.value&&(await l.insert(t.value.id,c.value),c.value="",f.value.focus())};return(B,w)=>(k(),x("div",me,[e("div",{ref_key:"chatContainerRef",ref:i,class:"tw-flex-auto tw-flex tw-flex-col tw-gap-3 tw-overflow-x-hidden tw-overflow-y-auto"},[T(J,{name:"slide-right",css:o.value},{default:Q(()=>[(k(!0),x(ee,null,te(a.value,p=>(k(),se(ue,{key:p.uuid||p.id,message:p},null,8,["message"]))),128))]),_:1},8,["css"])],512),e("div",fe,[e("div",pe,[P(e("input",{ref_key:"inputRef",ref:f,"onUpdate:modelValue":w[0]||(w[0]=p=>c.value=p),type:"text",placeholder:"Type a message",class:"width-100",onKeydown:X(v,["enter"])},null,544),[[W,c.value]]),e("button",{class:"icon",onClick:v},w[1]||(w[1]=[e("i",{class:"fas fa-arrow-right"},null,-1)]))])])]))}}),we={class:"pl-bg-block tw-rounded-xl lg:tw-rounded-r-0 tw-h-full tw-h-full tw-flex tw-flex-col"},he={class:"tw-flex-auto tw-flex tw-flex-col tw-gap-4 tw-overflow-hidden custom-p-12 custom-pb-0"},_e={class:"tw-flex-auto tw-min-h-0"},ye=C({__name:"TaskInfo",props:{taskId:{}},setup(m){const s=m,n=ae(),l=()=>{var a;const t=(a=n.currentRoute.value.matched.find(i=>i.meta.isListView))==null?void 0:a.name;t?n.push({name:t}):console.error("Cant find back route")};return(t,a)=>(k(),x("div",we,[e("div",{class:"tw-flex-none custom-p-12"},[e("button",{class:"circle gray",onClick:l},a[0]||(a[0]=[e("i",{class:"fas fa-times"},null,-1)]))]),e("div",he,[e("div",_e,[T(ve,{"task-id":s.taskId},null,8,["task-id"])])])]))}});export{ye as default};
