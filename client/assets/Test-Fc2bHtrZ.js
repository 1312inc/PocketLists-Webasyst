import{d as E,u as U,a as V,f as M,l as N,b as q,c as k,_ as K,e as O,g as j,h as y,i as z,r as h,o as _,j as g,k as e,w as b,t as x,m as C,O as G,n as I,p as B,q as H,T as Q,s as J,v as P,x as W,y as X,F as Y,z as Z,A as L,B as ee}from"./index-i_ZjAD-A.js";import{C as te}from"./ContenteditableBlock-7bI7kWgX.js";import"./rangy-5rxgwlWZ.js";const $=E("comments",()=>{const u=U(),t=V(M(N(()=>q.comments.toArray())),{initialValue:[]}),n=k(()=>t.value.filter(d=>!d.deleted)),i=k(()=>d=>n.value.find(o=>o.id===d)),s=k(()=>d=>{const o=u.getItemById(d);return K.sortBy(n.value.filter(a=>a.item_id===(o==null?void 0:o.uuid)||a.item_id===(o==null?void 0:o.id)),[a=>Date.parse(a.create_datetime)])}),{defineFetch:l,defineFetchAdd:m,defineFetchUpdate:r,defineFetchDelete:c,commit:f,updateItem:w,deleteItem:p}=O("comments"),S=l("pocketlists.comment.getList"),T=m("pocketlists.comment.add"),A=r("pocketlists.comment.update"),D=c("pocketlists.comment.delete"),R=(d,o)=>{const a=j(d,o);a&&f(a)};return u.$onAction(({name:d,after:o})=>{d==="fetchAdd"&&o(a=>{a==null||a.forEach(v=>{v.uuid&&s.value(v.uuid).forEach(F=>{w(F,{item_id:v.id},{quietly:!0})})})}),d==="deleteItem"&&o(a=>{s.value(a).forEach(v=>{p(v,{force:!0})})})}),{allItems:t,items:n,getItemById:i,getComentsByTaskId:s,commit:f,insert:R,updateItem:w,deleteItem:p,fetch:S,fetchAdd:T,fetchUpdate:A,fetchDelete:D}}),se={class:"tw-flex tw-flex-col tw-gap-2 tw-bg-background tw-p-4 tw-rounded-lg tw-rounded-tl-0 tw-text-sm tw-mr-4"},oe={class:"tw-flex tw-gap-2"},ae={class:"tw-flex tw-gap-2"},ne={class:"tw-truncate"},le={class:"hint"},ie={class:"hint"},ce=y({__name:"TaskChatItem",props:{message:{}},setup(u){const t=u,n=z(),i=$(),s=h(!1),l=()=>{i.deleteItem(t.message)},m=r=>{i.updateItem(t.message,{comment:r})};return(r,c)=>{var f;return _(),g("div",se,[e("div",oe,[e("a",{onClick:b(l,["prevent"])},c[1]||(c[1]=[e("i",{class:"fas fa-times"},null,-1)])),e("a",{onClick:c[0]||(c[0]=b(w=>s.value=!0,["prevent"]))},c[2]||(c[2]=[e("i",{class:"fas fa-edit"},null,-1)]))]),e("div",ae,[e("div",ne,x((f=C(n).getItemById(t.message.contact_id))==null?void 0:f.name),1),e("div",le,x(C(G)(t.message.create_datetime).format("ll")),1)]),I(te,{editable:s.value,focusable:!0,value:t.message.comment,tag:"div",onUpdate:m},null,8,["editable","value"]),e("div",ie,x(typeof t.message.id=="number"?"delivered":"not delivered"),1)])}}}),de={class:"tw-h-full tw-flex tw-flex-col"},re={class:"tw-flex-none tw-sticky tw-py-3 pl-bg-block"},ue={class:"state-with-inner-icon right tw-w-full"},me=y({__name:"TaskChat",props:{taskId:{}},setup(u){const t=u,n=$(),i=h(),s=h(),l=k(()=>n.getComentsByTaskId(t.taskId)),m=h(!1),r=h("");B(()=>t.taskId,f=>{n.fetch({item_id:f})},{immediate:!0}),B(l,async()=>{await X(),i.value&&(i.value.scrollTop=i.value.scrollHeight),m.value=!0});const c=async()=>{await n.insert(t.taskId,r.value),r.value="",s.value.focus()};return(f,w)=>(_(),g("div",de,[e("div",{ref_key:"chatContainerRef",ref:i,class:"tw-flex-auto tw-flex tw-flex-col tw-gap-3 tw-overflow-x-hidden tw-overflow-y-auto"},[I(Q,{name:"slide-right",css:m.value},{default:H(()=>[(_(!0),g(Y,null,Z(l.value,p=>(_(),L(ce,{key:p.uuid||p.id,message:p},null,8,["message"]))),128))]),_:1},8,["css"])],512),e("div",re,[e("div",ue,[J(e("input",{ref_key:"inputRef",ref:s,"onUpdate:modelValue":w[0]||(w[0]=p=>r.value=p),type:"text",placeholder:"Type a message",class:"tw-w-full",onKeydown:W(c,["enter"])},null,544),[[P,r.value]]),e("button",{class:"icon",onClick:c},w[1]||(w[1]=[e("i",{class:"fas fa-arrow-right"},null,-1)]))])])]))}}),fe={class:"pl-bg-block tw-rounded-xl lg:tw-rounded-r-0 tw-h-full tw-h-full tw-flex tw-flex-col"},we={class:"tw-flex-auto tw-flex tw-flex-col tw-gap-4 tw-overflow-hidden tw-p-3 tw-pb-0"},pe={class:"tw-flex-auto tw-min-h-0"},ke=y({__name:"Test",props:{taskId:{}},setup(u){const t=u,n=ee(),i=()=>{var l;const s=(l=n.currentRoute.value.matched.find(m=>m.meta.isListView))==null?void 0:l.name;s?n.push({name:s}):console.error("Cant find back route")};return(s,l)=>(_(),g("div",fe,[e("div",{class:"tw-flex-none tw-p-3"},[e("button",{class:"circle gray",onClick:i},l[0]||(l[0]=[e("i",{class:"fas fa-times"},null,-1)]))]),e("div",we,[e("div",pe,[I(me,{"task-id":t.taskId},null,8,["task-id"])])])]))}});export{ke as default};
