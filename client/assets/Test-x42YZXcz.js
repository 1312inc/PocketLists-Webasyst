import{d as U,u as $,a as V,f as M,l as N,b as q,c as k,_ as K,e as j,g as z,h as b,i as G,r as _,o as g,j as x,k as e,w as B,t as I,m as S,n as H,p as C,q as T,s as O,T as Q,v as J,x as P,y as W,z as X,A as Y,F as Z,B as L,C as ee,D as te}from"./index-yOkBT4ll.js";import{C as se}from"./ContenteditableBlock-LpToYXGE.js";import"./rangy-5rxgwlWZ.js";const D=U("comments",()=>{const m=$(),s=V(M(N(()=>q.comments.toArray())),{initialValue:[]}),i=k(()=>s.value.filter(u=>!u.deleted)),c=k(()=>u=>i.value.find(o=>o.id===u)),t=k(()=>u=>{const o=m.getItemById(u);return K.sortBy(i.value.filter(a=>a.item_id===(o==null?void 0:o.uuid)||a.item_id===(o==null?void 0:o.id)),[a=>Date.parse(a.create_datetime)])}),{defineFetch:n,defineFetchAdd:d,defineFetchUpdate:f,defineFetchDelete:l,commit:r,updateItem:p,deleteItem:y}=j("comments"),v=n("pocketlists.comment.getList"),w=d("pocketlists.comment.add"),A=f("pocketlists.comment.update"),R=l("pocketlists.comment.delete"),F=async(u,o)=>{const a=z(u,o);if(a&&await r(a))return a};return m.$onAction(({name:u,after:o})=>{u==="fetchAdd"&&o(a=>{a==null||a.forEach(h=>{h.uuid&&t.value(h.uuid).forEach(E=>{p(E,{item_id:h.id},{quietly:!0})})})}),u==="deleteItem"&&o(a=>{t.value(a).forEach(h=>{y(h,{force:!0})})})}),{allItems:s,items:i,getItemById:c,getComentsByTaskId:t,commit:r,insert:F,updateItem:p,deleteItem:y,fetch:v,fetchAdd:w,fetchUpdate:A,fetchDelete:R}}),ae={class:"tw-flex tw-flex-col tw-gap-2 tw-bg-background tw-p-4 tw-rounded-lg tw-rounded-tl-0 tw-text-sm tw-mr-4"},oe={class:"tw-flex tw-gap-2"},ne={class:"tw-flex tw-gap-2"},le={class:"tw-truncate"},ie={class:"hint"},ce={class:"hint"},de=b({__name:"TaskChatItem",props:{message:{}},setup(m){const s=m,i=G(),c=D(),t=_(!1),n=()=>{c.deleteItem(s.message)},d=f=>{c.updateItem(s.message,{comment:f})};return(f,l)=>{var r;return g(),x("div",ae,[e("div",oe,[e("a",{onClick:B(n,["prevent"])},l[1]||(l[1]=[e("i",{class:"fas fa-times"},null,-1)])),e("a",{onClick:l[0]||(l[0]=B(p=>t.value=!0,["prevent"]))},l[2]||(l[2]=[e("i",{class:"fas fa-edit"},null,-1)]))]),e("div",ne,[e("div",le,I((r=S(i).getItemById(s.message.contact_id))==null?void 0:r.name),1),e("div",ie,I(S(H)(s.message.create_datetime).format("ll")),1)]),C(se,{editable:t.value,focusable:!0,value:s.message.comment,tag:"div",onUpdate:d},null,8,["editable","value"]),e("div",ce,I(typeof s.message.id=="number"?"delivered":"not delivered"),1)])}}}),re={class:"tw-h-full tw-flex tw-flex-col"},ue={class:"tw-flex-none tw-sticky tw-py-3 pl-bg-block"},me={class:"state-with-inner-icon right tw-w-full"},fe=b({__name:"TaskChat",props:{taskId:{}},setup(m){const s=m,i=$(),c=D(),t=k(()=>i.getItemById(s.taskId)),n=k(()=>t.value?c.getComentsByTaskId(t.value.id):[]),d=_(),f=_(),l=_(!1),r=_("");T(()=>s.taskId,()=>{t.value&&X(t.value)&&c.fetch({item_id:t.value.id})},{immediate:!0}),T(n,async()=>{await Y(),d.value&&(d.value.scrollTop=d.value.scrollHeight),l.value=!0});const p=async()=>{t.value&&(await c.insert(t.value.id,r.value),r.value="",f.value.focus())};return(y,v)=>(g(),x("div",re,[e("div",{ref_key:"chatContainerRef",ref:d,class:"tw-flex-auto tw-flex tw-flex-col tw-gap-3 tw-overflow-x-hidden tw-overflow-y-auto"},[C(Q,{name:"slide-right",css:l.value},{default:O(()=>[(g(!0),x(Z,null,L(n.value,w=>(g(),ee(de,{key:w.uuid||w.id,message:w},null,8,["message"]))),128))]),_:1},8,["css"])],512),e("div",ue,[e("div",me,[J(e("input",{ref_key:"inputRef",ref:f,"onUpdate:modelValue":v[0]||(v[0]=w=>r.value=w),type:"text",placeholder:"Type a message",class:"tw-w-full",onKeydown:W(p,["enter"])},null,544),[[P,r.value]]),e("button",{class:"icon",onClick:p},v[1]||(v[1]=[e("i",{class:"fas fa-arrow-right"},null,-1)]))])])]))}}),we={class:"pl-bg-block tw-rounded-xl lg:tw-rounded-r-0 tw-h-full tw-h-full tw-flex tw-flex-col"},pe={class:"tw-flex-auto tw-flex tw-flex-col tw-gap-4 tw-overflow-hidden tw-p-3 tw-pb-0"},ve={class:"tw-flex-auto tw-min-h-0"},ge=b({__name:"Test",props:{taskId:{}},setup(m){const s=m,i=te(),c=()=>{var n;const t=(n=i.currentRoute.value.matched.find(d=>d.meta.isListView))==null?void 0:n.name;t?i.push({name:t}):console.error("Cant find back route")};return(t,n)=>(g(),x("div",we,[e("div",{class:"tw-flex-none tw-p-3"},[e("button",{class:"circle gray",onClick:c},n[0]||(n[0]=[e("i",{class:"fas fa-times"},null,-1)]))]),e("div",pe,[e("div",ve,[C(fe,{"task-id":s.taskId},null,8,["task-id"])])])]))}});export{ge as default};
