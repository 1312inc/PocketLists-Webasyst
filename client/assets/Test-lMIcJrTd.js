import{d as U,u as $,a as V,f as M,l as N,b as q,c as g,_ as K,e as j,g as z,h as C,i as G,r as _,o as k,j as x,k as e,w as T,t as I,m as b,n as H,p as O,q as B,s as S,v as Q,T as J,x as P,y as W,z as X,A as Y,B as Z,F as L,C as ee,D as te,E as se}from"./index-o9NLMk75.js";import{C as ae}from"./ContenteditableBlock-0VsbjvZh.js";import"./rangy-5rxgwlWZ.js";const D=U("comments",()=>{const m=$(),s=V(M(N(()=>q.comments.toArray())),{initialValue:[]}),i=g(()=>s.value.filter(u=>!u.deleted)),c=g(()=>u=>i.value.find(o=>o.id===u)),t=g(()=>u=>{const o=m.getItemById(u);return K.sortBy(i.value.filter(a=>a.item_id===(o==null?void 0:o.uuid)||a.item_id===(o==null?void 0:o.id)),[a=>Date.parse(a.create_datetime)])}),{defineFetch:n,defineFetchAdd:d,defineFetchUpdate:f,defineFetchDelete:l,commit:r,updateItem:p,deleteItem:y}=j("comments"),v=n("pocketlists.comment.getList"),w=d("pocketlists.comment.add"),A=f("pocketlists.comment.update"),R=l("pocketlists.comment.delete"),E=async(u,o)=>{const a=z(u,o);if(a&&await r(a))return a};return m.$onAction(({name:u,after:o})=>{u==="fetchAdd"&&o(a=>{a==null||a.forEach(h=>{h.uuid&&t.value(h.uuid).forEach(F=>{p(F,{item_id:h.id},{quietly:!0})})})}),u==="deleteItem"&&o(a=>{t.value(a).forEach(h=>{y(h,{force:!0})})})}),{allItems:s,items:i,getItemById:c,getComentsByTaskId:t,commit:r,insert:E,updateItem:p,deleteItem:y,fetch:v,fetchAdd:w,fetchUpdate:A,fetchDelete:R}}),oe={class:"tw-flex tw-flex-col tw-gap-2 tw-bg-background tw-p-4 tw-rounded-lg tw-rounded-tl-0 tw-text-sm tw-mr-4"},ne={class:"tw-flex tw-gap-2"},le={class:"tw-flex tw-gap-2"},ie={class:"tw-truncate"},ce={class:"hint"},de={class:"hint"},re=C({__name:"TaskChatItem",props:{message:{}},setup(m){const s=m,i=G(),c=D(),t=_(!1),n=()=>{c.deleteItem(s.message)},d=f=>{c.updateItem(s.message,{comment:f})};return(f,l)=>{var r;return k(),x("div",oe,[e("div",ne,[e("a",{onClick:T(n,["prevent"])},l[1]||(l[1]=[e("i",{class:"fas fa-times"},null,-1)])),e("a",{onClick:l[0]||(l[0]=T(p=>t.value=!0,["prevent"]))},l[2]||(l[2]=[e("i",{class:"fas fa-edit"},null,-1)]))]),e("div",le,[e("div",ie,I((r=b(i).getItemById(s.message.contact_id))==null?void 0:r.name),1),e("div",ce,I(b(H)(b(O)(s.message)).format("ll")),1)]),B(ae,{editable:t.value,focusable:!0,value:s.message.comment,tag:"div",onUpdate:d},null,8,["editable","value"]),e("div",de,I(typeof s.message.id=="number"?"delivered":"not delivered"),1)])}}}),ue={class:"tw-h-full tw-flex tw-flex-col"},me={class:"tw-flex-none tw-sticky tw-py-3 pl-bg-block"},fe={class:"state-with-inner-icon right tw-w-full"},we=C({__name:"TaskChat",props:{taskId:{}},setup(m){const s=m,i=$(),c=D(),t=g(()=>i.getItemById(s.taskId)),n=g(()=>t.value?c.getComentsByTaskId(t.value.id):[]),d=_(),f=_(),l=_(!1),r=_("");S(()=>s.taskId,()=>{t.value&&Y(t.value)&&c.fetch({item_id:t.value.id})},{immediate:!0}),S(n,async()=>{await Z(),d.value&&(d.value.scrollTop=d.value.scrollHeight),l.value=!0});const p=async()=>{t.value&&(await c.insert(t.value.id,r.value),r.value="",f.value.focus())};return(y,v)=>(k(),x("div",ue,[e("div",{ref_key:"chatContainerRef",ref:d,class:"tw-flex-auto tw-flex tw-flex-col tw-gap-3 tw-overflow-x-hidden tw-overflow-y-auto"},[B(J,{name:"slide-right",css:l.value},{default:Q(()=>[(k(!0),x(L,null,ee(n.value,w=>(k(),te(re,{key:w.uuid||w.id,message:w},null,8,["message"]))),128))]),_:1},8,["css"])],512),e("div",me,[e("div",fe,[P(e("input",{ref_key:"inputRef",ref:f,"onUpdate:modelValue":v[0]||(v[0]=w=>r.value=w),type:"text",placeholder:"Type a message",class:"tw-w-full",onKeydown:X(p,["enter"])},null,544),[[W,r.value]]),e("button",{class:"icon",onClick:p},v[1]||(v[1]=[e("i",{class:"fas fa-arrow-right"},null,-1)]))])])]))}}),pe={class:"pl-bg-block tw-rounded-xl lg:tw-rounded-r-0 tw-h-full tw-h-full tw-flex tw-flex-col"},ve={class:"tw-flex-auto tw-flex tw-flex-col tw-gap-4 tw-overflow-hidden tw-p-3 tw-pb-0"},he={class:"tw-flex-auto tw-min-h-0"},xe=C({__name:"Test",props:{taskId:{}},setup(m){const s=m,i=se(),c=()=>{var n;const t=(n=i.currentRoute.value.matched.find(d=>d.meta.isListView))==null?void 0:n.name;t?i.push({name:t}):console.error("Cant find back route")};return(t,n)=>(k(),x("div",pe,[e("div",{class:"tw-flex-none tw-p-3"},[e("button",{class:"circle gray",onClick:c},n[0]||(n[0]=[e("i",{class:"fas fa-times"},null,-1)]))]),e("div",ve,[e("div",he,[B(we,{"task-id":s.taskId},null,8,["task-id"])])])]))}});export{xe as default};
