import{d as M,u as I,f as b,l as C,a as B,c as _,_ as D,b as E,g as F,e as y,h as N,o as v,i as x,j as e,w as q,t as g,k as T,O as K,r as k,m as S,n as $,p as O,T as U,q as j,v as z,s as G,x as H,F as Q,y as J,z as P,A as W}from"./index-6jBivM5l.js";import{u as X}from"./task-8-1Z1YFP.js";const A=M("comments",()=>{const u=X(),t=I(b(C(()=>B.comments.toArray())),{initialValue:[]}),o=_(()=>t.value.filter(n=>!n.deleted)),i=_(()=>n=>o.value.find(s=>s.id===n)),c=_(()=>n=>I(b(C(()=>B.comments.where({item_id:n}).sortBy("create_datetime"))),{initialValue:[]})),a=_(()=>n=>{const s=u.getItemById(n);return D.sortBy(o.value.filter(l=>l.item_id===(s==null?void 0:s.uuid)||l.item_id===(s==null?void 0:s.id)),["create_datetime"])}),{defineFetch:r,defineFetchAdd:d,commit:h,deleteItem:w}=E("comments"),m=r("pocketlists.comment.getList"),f=d("pocketlists.comment.add"),R=(n,s)=>{const l=F(n,s);l&&h(l)};return u.$onAction(({name:n,after:s})=>{n==="fetchAdd"&&s(l=>{l==null||l.forEach(p=>{p.uuid&&a.value(p.uuid).forEach(V=>{updateItem(V,{item_id:p.id},{quietly:!0})})})}),n==="deleteItem"&&s(l=>{a.value(l).forEach(p=>{w(p,{force:!0})})})}),{allItems:t,items:o,getItemById:i,getMessgesByTaskId:c,insert:R,deleteItem:w,fetch:m,fetchAdd:f}}),Y={class:"tw-flex tw-flex-col tw-gap-2 tw-bg-background tw-p-4 tw-rounded-lg tw-rounded-tl-0 tw-text-sm tw-mr-4"},Z={class:"tw-flex tw-gap-2"},L={class:"tw-truncate"},ee={class:"hint"},te={class:"hint"},se=y({__name:"TaskChatItem",props:{message:{}},setup(u){const t=u,o=N(),i=A(),c=()=>{i.deleteItem(t.message)};return(a,r)=>{var d;return v(),x("div",Y,[e("a",{onClick:q(c,["prevent"])},r[0]||(r[0]=[e("i",{class:"fas fa-times"},null,-1)])),e("div",Z,[e("div",L,g((d=T(o).getItemById(t.message.contact_id))==null?void 0:d.name),1),e("div",ee,g(T(K)(t.message.create_datetime).format("ll")),1)]),e("div",null,g(t.message.comment),1),e("div",te,g(typeof t.message=="number"?"delivered":"not delivered"),1)])}}}),oe={class:"tw-h-full tw-flex tw-flex-col"},ae={class:"tw-flex-none tw-sticky tw-py-3 pl-bg-block"},ne={class:"state-with-inner-icon right tw-w-full"},le=y({__name:"TaskChat",props:{taskId:{}},setup(u){const t=u,o=A(),i=k(),c=k(),a=_(()=>o.getMessgesByTaskId(t.taskId)),r=k(!1),d=k("");S(()=>t.taskId,w=>{o.fetch({item_id:w})},{immediate:!0}),S(a.value,async()=>{await H(),i.value&&(i.value.scrollTop=i.value.scrollHeight),r.value=!0});const h=async()=>{await o.insert(t.taskId,d.value),d.value="",c.value.focus()};return(w,m)=>(v(),x("div",oe,[e("div",{ref_key:"chatContainerRef",ref:i,class:"tw-flex-auto tw-flex tw-flex-col tw-gap-3 tw-overflow-x-hidden tw-overflow-y-auto"},[$(U,{name:"slide-right",css:r.value},{default:O(()=>[(v(!0),x(Q,null,J(a.value.value,f=>(v(),P(se,{key:f.id,message:f},null,8,["message"]))),128))]),_:1},8,["css"])],512),e("div",ae,[e("div",ne,[j(e("input",{ref_key:"inputRef",ref:c,"onUpdate:modelValue":m[0]||(m[0]=f=>d.value=f),type:"text",placeholder:"Type a message",class:"tw-w-full",onKeydown:G(h,["enter"])},null,544),[[z,d.value]]),e("button",{class:"icon",onClick:h},m[1]||(m[1]=[e("i",{class:"fas fa-arrow-right"},null,-1)]))])])]))}}),ie={class:"pl-bg-block tw-rounded-xl lg:tw-rounded-r-0 tw-h-full tw-h-full tw-flex tw-flex-col"},ce={class:"tw-flex-auto tw-flex tw-flex-col tw-gap-4 tw-overflow-hidden tw-p-3 tw-pb-0"},re={class:"tw-flex-auto tw-min-h-0"},me=y({__name:"Test",props:{taskId:{}},setup(u){const t=u,o=W(),i=()=>{var a;const c=(a=o.currentRoute.value.matched.find(r=>r.meta.isListView))==null?void 0:a.name;c?o.push({name:c}):console.error("Cant find back route")};return(c,a)=>(v(),x("div",ie,[e("div",{class:"tw-flex-none tw-p-3"},[e("button",{class:"circle gray",onClick:i},a[0]||(a[0]=[e("i",{class:"fas fa-times"},null,-1)]))]),e("div",ce,[e("div",re,[$(le,{"task-id":t.taskId},null,8,["task-id"])])])]))}});export{me as default};
