{$time = time()}
{if $pl2pro.labels || $pl2pro.shortcutsGrouped}
<div class="pl2pro-item-add" data-pl2pro-wrapper="item-compact-add-{$time}"{if $pl2pro.itemLabel->getId()} data-pl2pro-label-selected="{$pl2pro.itemLabel->getId()}"{/if}>
    {* @var pocketlistsProPluginLabel $label *}
    <a
            class="pl-label"
            style="background-color: #fff; color: #aaa !important;"
            data-pl2pro-label="0"
    >
        [`No status`]
    </a>
    {foreach $pl2pro.labels as $label}
        <a
                class="pl-label {if $label->getId() == $pl2pro.itemLabel->getId()}selected{/if}"
                style="background-color: #{$label->getColor()|escape};"
                data-pl2pro-label="{$label->getId()}"
        >
            {$label->getName()|escape}
        </a>
    {/foreach}

    {if $pl2pro.shortcutsGrouped && $pl2pro.isNew}
        {foreach $pl2pro.shortcutsGrouped as $group => $shortcuts}
        <span
                class="pl2pro-shortcuts-group"
                data-pl2pro-shortcuts-group="{$group}"
                {if $shortcuts@iteration != 1}style="display: none"{/if}
        >
        {* @var pocketlistsProPluginShortcut shortcut *}
        {foreach $shortcuts as $shortcut}
            <a href="#" class="inline-link pl2pro-shortcut" title="Alt + {$shortcut@iteration}"><b><i>{$shortcut->getName()|escape}</i></b></a>
        {/foreach}
        </span>
        {/foreach}
    {/if}

    <script>
        (function () {
            'use strict';
            var wrapperTime = {$time},
                $wrapper = null,
                isNew = {$pl2pro.isNew};

            $(document)
                .off('open_new_item_wrapper.pl2')
                .off('itemDetailsOpened.pl2')
                .on('open_new_item_wrapper.pl2', function (e, data) {
                    $wrapper = data.add_wrapper.find('[data-pl2pro-wrapper="item-compact-add-' + wrapperTime + '"]');

                    init($wrapper);
                })
                .on('itemDetailsOpened.pl2', function (e, data) {
                    $wrapper = data.details_wrapper.find('[data-pl2pro-wrapper="item-compact-add-' + wrapperTime + '"]');

                    init($wrapper);
                });

            function init($wrapper) {
                if ($wrapper.data('pl2pro-item-add')) {
                    return;
                }

                $wrapper.data('pl2pro-item-add', 1);

                $wrapper.removeData('pl2pro-label-selected');

                var labels = function () {
                    var $labels = $wrapper.find('[data-pl2pro-label]'),
                        labelId = 0;

                    if (!isNew) {
                        $labels.addClass('shown');
                    } else {
                        $labels.removeClass('selected');
                        if ($.storage && (labelId = $.storage.get('pocketlists/pro/label'))) {
                            $labels
                                .removeClass('selected shown')
                                .filter('[data-pl2pro-label="'+labelId+'"]')
                                .addClass('selected shown');
                            $wrapper.data('pl2pro-label-selected', labelId);
                        } else {
                            $labels.filter(':nth(1)').addClass('shown');
                        }
                    }

                    var labelsAreHidden = function() {
                        return !!$labels.filter(':hidden').length;
                    };

                    $labels.on('click', function () {
                        var $this = $(this),
                            add = !$this.hasClass('selected');

                        if (labelsAreHidden()) {
                            $labels.addClass('shown');

                            return;
                        }

                        $labels.removeClass('selected');
                        $wrapper.removeData('pl2pro-label-selected');

                        if (add) {
                            $.storage && !$.storage.set('pocketlists/pro/label', $this.data('pl2pro-label'));
                            $labels.removeClass('shown');
                            $this.addClass('selected shown');
                            $wrapper.data('pl2pro-label-selected', $this.data('pl2pro-label'));
                        }
                    });

                    // todo: удалить несколько обработчиков
                    $(document)
                        .on('beforeAddItemSync.pl2', function (e, eventData) {
                            eventData.response.data[0]['pro_label_id'] = parseInt($wrapper.data('pl2pro-label-selected')) || 0;
                        })
                        .on('item_add.pl2', function (e) {
                            labels();
                            shortcuts();
                        })
                        .on('beforeUpdateItemSync.pl2', function (e, $form) {
                            $('<input>', {
                                type: 'hidden',
                                name: 'item[pro_label_id]',
                                value: (parseInt($wrapper.data('pl2pro-label-selected')) || 0)
                            }).appendTo($form);

                            e.preventDefault();
                        });
                };

                /*{if $pl2pro.labels}*/
                labels();
                /*{/if}*/

                var shortcuts = function() {
                    $wrapper
                        .find('[data-pl2pro-shortcuts-group]')
                            .hide()
                        .filter(':first')
                            .show();

                    var setVisible = function (i) {
                            var $this = $(this),
                                $shortcutGroups = $wrapper.find('[data-pl2pro-shortcuts-group]'),
                                $nextGroup = $shortcutGroups.filter('[data-pl2pro-shortcuts-group="' + i + '"]');

                            if ($nextGroup.length) {
                                $shortcutGroups.hide();
                                $nextGroup.show();
                            }
                        },
                        focus = function($textarea) {
                            setTimeout(function () {
                                $textarea.trigger('focus');
                            }, 0);
                        },
                        canBeShown = function(itemText) {
                            var $shortcutGroups = $wrapper.find('[data-pl2pro-shortcuts-group]'),
                                groups = { };

                            $shortcutGroups
                                .hide()
                                .map(function () {
                                    groups[$(this).data('pl2pro-shortcuts-group')] = true;
                                });

                            $shortcutGroups.find('.pl2pro-shortcut')
                                .each(function () {
                                    var $this = $(this),
                                        search = new RegExp($this.text(), 'i');

                                    if (itemText.search(search) > -1) {
                                        var groupId = $this.closest('[data-pl2pro-shortcuts-group]').data('pl2pro-shortcuts-group');

                                        groups[groupId] = false;
                                    }
                                });

                            for (var index in groups) {
                                if (groups[index]) {
                                    $shortcutGroups.filter(':nth(' + (index - 1) + ')').show();
                                    break;
                                }
                            }
                        };

                    $wrapper.closest('#pl-item-add').find('textarea').on('keyup', function (e) {
                        canBeShown($(this).val());
                    });

                    $wrapper.on('click.pl2pro', '.pl2pro-shortcut', function (e) {
                        e.preventDefault();

                        var $this = $(this),
                            $textarea = $this.closest('#pl-item-add').find('textarea'),
                            isNotEmpty = !!$textarea.val(),
                            groupId = $this.closest('[data-pl2pro-shortcuts-group]').data('pl2pro-shortcuts-group');

                        $textarea.val($textarea.val() + (isNotEmpty ? ' ' : '') + $this.text());
                        focus($textarea);
                        setVisible.call(this, groupId + 1);
                    });

                    $(document).on('keydown', function (e) {
                        var num = parseInt(e.which) - 48;

                        if (e.altKey && num > 0 && num < 10) {
                            var $shortcut = $wrapper
                                .find('[data-pl2pro-shortcuts-group]')
                                .filter('[data-pl2pro-shortcuts-group]:visible')
                                .find('.pl2pro-shortcut:nth(' + (num - 1) + ')');

                            if ($shortcut.length) {
                                $shortcut.trigger('click.pl2pro');

                                e.preventDefault();
                            }
                        }
                    });
                };

                /*{if $pl2pro.shortcutsGrouped && $pl2pro.isNew}*/
                shortcuts();
                /*{/if}*/
            }
        }());
    </script>
</div>
{/if}
