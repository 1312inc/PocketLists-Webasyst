{$time = time()}
{if $labels || $shortcutsGrouped}
<div class="pl2pro-item-add" data-pl2pro-wrapper="item-compact-add-{$time}"{if $itemLabel->getId()} data-pl2pro-label-selected="{$itemLabel->getId()}"{/if}>
    {* @var pocketlistsProPluginLabel $label *}
    <a
            class="pl-label shown {if !$itemLabel->getId()}selected{/if}"
            style="background-color: #fff; color: #aaa !important;"
            data-pl2pro-label="NONENONE"
    >
        [`No status`]
    </a>
    {foreach $labels as $label}
        <a
                class="pl-label shown {if $label->getId() == $itemLabel->getId()}selected{/if}"
                style="background-color: #{$label->getColor()|escape};"
                data-pl2pro-label="{$label->getId()}"
        >
            {$label->getName()|escape}
        </a>
    {/foreach}

    {if $shortcutsGrouped && $new}
        {foreach $shortcutsGrouped as $group => $shortcuts}
        <span
                class="pl2pro-shortcuts-group"
                data-pl2pro-shortcuts-group="{$group}"
                {if $shortcuts@iteration != 1}style="display: none"{/if}
        >
        {* @var pocketlistsProPluginShortcut shortcut *}
        {foreach $shortcuts as $shortcut}
            <a href="#" class="inline-link pl2pro-shortcut" title="Alt + {$shortcut@iteration}"><b><i>{$shortcut->getName()|escape}</i></b></a>
        {/foreach}
        </span>
        {/foreach}
    {/if}

    <script>
        (function () {
            'use strict';
            var wrapperTime = {$time},
                $wrapper = null;

            $(document)
                .off('open_new_item_wrapper.pl2')
                .off('itemDetailsOpened.pl2')
                .on('open_new_item_wrapper.pl2', function (e, data) {
                    $wrapper = data.add_wrapper.find('[data-pl2pro-wrapper="item-compact-add-' + wrapperTime + '"]');

                    init($wrapper);
                })
                .on('itemDetailsOpened.pl2', function (e, data) {
                    $wrapper = data.details_wrapper.find('[data-pl2pro-wrapper="item-compact-add-' + wrapperTime + '"]');

                    init($wrapper);
                });

            function init($wrapper) {
                if ($wrapper.data('pl2pro-item-add')) {
                    return;
                }

                $wrapper.data('pl2pro-item-add', 1);

                var labels = function () {
                    var $labels = $wrapper.find('[data-pl2pro-label]');

                    $labels.on('click', function () {
                        var $this = $(this),
                            add = !$this.hasClass('selected');

                        $labels.removeClass('selected');
                        $wrapper.removeData('pl2pro-label-selected');

                        if (add) {
                            $this.addClass('selected');
                            $wrapper.data('pl2pro-label-selected', $this.data('pl2pro-label'));
                        }
                    });

                    // todo: удалить несколько обработчиков
                    $(document)
                        .on('beforeAddItemSync.pl2', function (e, eventData) {
                            eventData.response.data[0]['pro_label_id'] = parseInt($wrapper.data('pl2pro-label-selected')) || 0;
                        })
                        .on('item_add.pl2', function (e) {
                            $labels.filter('.selected').trigger('click');
                        })
                        .on('beforeUpdateItemSync.pl2', function (e, $form) {
                            $('<input>', {
                                type: 'hidden',
                                name: 'item[pro_label_id]',
                                value: (parseInt($wrapper.data('pl2pro-label-selected')) || 0)
                            }).appendTo($form);

                            e.preventDefault();
                        });
                };

                /*{if $labels}*/
                labels();
                /*{/if}*/

                var shortcuts = function() {
                    var setVisible = function (i) {
                        var $this = $(this),
                            $shortcutGroups = $wrapper.find('[data-pl2pro-shortcuts-group]'),
                            $nextGroup = $shortcutGroups.filter('[data-pl2pro-shortcuts-group="' + i + '"]');

                        if ($nextGroup.length) {
                            $shortcutGroups.hide();
                            $nextGroup.show();
                        }
                    };

                    var focus = function($textarea) {
                        setTimeout(function () {
                            $textarea.trigger('focus');
                        }, 0);
                    };

                    $wrapper.on('click.pl2pro', '.pl2pro-shortcut', function (e) {
                        e.preventDefault();

                        var $this = $(this),
                            $textarea = $this.closest('#pl-item-add').find('textarea'),
                            isNotEmpty = !!$textarea.val(),
                            groupId = $this.closest('[data-pl2pro-shortcuts-group]').data('pl2pro-shortcuts-group');

                        $textarea.val($textarea.val() + (isNotEmpty ? ' ' : '') + $this.text());
                        focus($textarea);
                        setVisible.call(this, groupId + 1);
                    });

                    $(document).on('keydown', function (e) {
                        var num = parseInt(e.which) - 48;

                        if (e.altKey && num > 0 && num < 10) {
                            var $shortcut = $wrapper
                                .find('[data-pl2pro-shortcuts-group]')
                                .filter('[data-pl2pro-shortcuts-group]:visible')
                                .find('.pl2pro-shortcut:nth(' + (num - 1) + ')');

                            if ($shortcut.length) {
                                $shortcut.trigger('click.pl2pro');

                                e.preventDefault();
                            }
                        }
                    });
                };

                /*{if $shortcutsGrouped && $new}*/
                shortcuts();
                /*{/if}*/
            }

            // $('.pl-label').click(function () {
            //     $('.pl2pro-item-add').toggleClass('pl2pro-item-add-all-labels-shown');
            // });
        }());
    </script>
</div>
{/if}
