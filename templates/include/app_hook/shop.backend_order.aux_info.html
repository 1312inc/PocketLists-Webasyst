<script type="template/pl2" data-pl2-template="itemadd">
    <main class="pl-items pl-list-items pl-todo pl-shop-order" id="pl-list-content">
        <a class="pl-shop-close" href="#" data-pl2-shop-action="close" title="[`Close`]">&times;</a>
        <div class="pl-list-items" id="pl-list-items">
            <section id="pl-undone-items" data-pl-items="undone">
                <ul class="menu-v">
                    {if !empty($params.items_undone)}
                    {include '../../actions/item/Item.html' parent_id=0 items=$params.items_undone}
                    {/if}
                </ul>
            </section>

            <section id="pl-complete-log" class="pl-logbook">
                <ul class="menu-v">
                    {if $params.count_done_items}
                    {include '../../actions/item/Item.html' parent_id=0 items=$params.items_done}
                    {/if}
                </ul>
            </section>

        </div>

        {if $params.app->userCanAccess()}
            {include '../../include/itemadd.html' inline}
        {/if}
        {include '../../include/itemdetails.html' inline}
        {include '../../include/itemcomments.html' inline}

    </main>
</script>
<script type="text/javascript" src="{$params.wa_app_static_url}js/pocketlists.js?v{if !waSystemConfig::isDebug()}{$wa->version()}{/if}"></script>
<script type="text/javascript" src="{$params.wa_app_static_url}js/pocketlists-item.js?v{if !waSystemConfig::isDebug()}{$wa->version()}{/if}"></script>
<link type="text/css" rel="stylesheet" href="{$params.wa_app_static_url}css/pocketlists.css?v{if !waSystemConfig::isDebug()}{$wa->version()}{/if}">

<script>
    (function(){
        var $order_info_wrapper = $('#s-split-order-wrapper'),
            item_add_html = $('[data-pl2-template="itemadd"]').html(),
            $toggle_link = $('[data-pl2-action="show-add-item"]'),
            has_undone = /*{if empty($params.items_undone)}*/false/*{else}*/true/*{/if}*/;

        $order_info_wrapper.prepend(item_add_html);

        var $list_wrapper = $('#pl-list-content');

        function canShow() {
            return (!has_undone && !$.storage.get('pocketlists/apps/hide-pl2ss-by-default')) || has_undone;
        }

        $list_wrapper.on('click', '[data-pl2-shop-action="close"]', function (e) {
            e.preventDefault();

            $.storage.set('pocketlists/apps/hide-pl2ss-by-default', 1);
            $list_wrapper.slideUp(200);
        });

        if (!canShow()) {
            $list_wrapper.hide();
        }

        $toggle_link.on('click', function (e) {
            e.preventDefault();

            $.storage.del('pocketlists/apps/hide-pl2ss-by-default');

            $list_wrapper.slideToggle(200, function () {
                if ($list_wrapper.is(':visible')) {
                    $list_wrapper.find('#pl-item-add textarea').trigger('focus');
                }
            });
        });

        var Items = new $.pocketlists.Items($list_wrapper, {
            enableAddLinkOnHover: false,
            enableChangeLevel: false,
            enableSortItems: false,
            current_user_id: {$wa->user()->getId()},
            standAloneItemAdd: 1,
            defaultLinkedEntity: {
                app: '{$params.app->getApp()}',
                entity_type: 'order',
                entity_id: {$params.order.id}
            },
            appUrl: '{$params.plurl}',
            userHasLinkedApps: {$params.user->hasLinkedApps()},
            wa_url: '{$wa_url}',
            fileUpload: {$params.fileupload}
        });
    }());
</script>
