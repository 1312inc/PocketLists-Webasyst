"use strict";$.pocketlists.Items=function(k,s){var d=k.find("#pl-undone-items > ul.menu-v"),E=$("#pl-undone-items").find("ul.menu-v"),e=k.find("#pl-complete-log"),w=e.find("ul.menu-v").first(),A=$("#pl-item-add").detach(),t=A.find("textarea"),y=$('<div id="pl-item-add-wrapper-hover" style="display: none;">'),r="[data-parent-id]",M=$("#pl-item-add-link"),n=$("#pl-complete-log-link"),C=k.find("#pl-empty-list-msg"),v=null,F=$.extend({},{enableAddLinkOnHover:true,enableChangeLevel:true,enableSortItems:true,list:null,assignUser:null,showMessageOnEmptyList:false,dueDate:"",filter:false,archive:false,allowChat:true},s);var G=function(){if(F.enableSortItems){E.sortable({item:r,distance:5,connectWith:"ul.menu-v",placeholder:"pl-item-placeholder",tolerance:"pointer",start:function(N,o){o.placeholder.height(o.helper.outerHeight())},stop:function(N,P){var o=P.item.parents(r).first(),O=o.length?parseInt(o.data("id")):0;P.item.data("parent-id",O);f(parseInt(P.item.data("id")))}})}};var I=function(o,P){var O=$(this);if(F.dueDate){$.each(o,function(Q){o[Q]["due_date"]=F.dueDate})}var N=O.closest(".pl-item").find(".pl-done-label span").addClass("transparent").html($.pocketlists.$loading);$.post("?module=item&action=create",{list_id:F.list?F.list.list_id:0,data:o,assigned_contact_id:F.assignUser?F.assignUser:false,filter:F.filter},function(R){$.pocketlists.updateAppCounter();$.pocketlists.$loading.remove();N.removeClass("transparent");var T=O.closest(r);var Q=$(""+R+"");t.data("can_blur",false);if(T.length){if(!T.parents(r).length||A.prev(".pl-item").length){T.after(Q)}else{T.before(Q)}}else{d.prepend(Q)}Q.filter(r).last().find(".pl-item").first().after(A);t.val("").trigger("focus").css("height","auto").data("can_blur",true);var S=$(".pl-calendar");if(!F.list&&S.length){$.get("?module=json&action=getItemsPocketColor&id="+parseInt(Q.data("id")),function(W){if(W.status==="ok"){var X=S.find(".pl-selected").length?S.find(".pl-selected"):S.find(".pl-today"),U=X.find(".pl-dots"),V=$('<i class="icon10 color pl-dark-'+W.data+'">');if(!U.length){U=$('<div class="pl-dots">');X.append(U)}if(U.find("i").not(".pl-dark-none").length<3){U.append(V)}}},"json")}D();B();f();$.isFunction(P)&&P.call(O)})};var z=function(N,S){var O=N.find("#pl-item-list-id").val(),R=N.find("#pl-item-list-id").val(),P=N.find('[name="item[list_id]"]').val();var o=function(Y,ad){$.pocketlists.updateAppCounter();$.pocketlists.$loading.remove();c(Y);if(F.list){var ac=0,V=0,X=$("#pl-lists").find('[data-pl-list-id="'+F.list.list_id+'"] span.count');var ab={green:1,"pl-green":1,"pl-due-tomorrow":1,yellow:2,"pl-yellow":2,"pl-due-today":2,red:3,"pl-red":3,"pl-due-overdue":3,none:0,"pl-none":0,"pl-due-someday":0,"undefined":0},T={1:" indicator green",2:" indicator yellow",3:" indicator red",0:""};if(R!=P){var af=$("#pl-lists").find('[data-pl-list-id="'+P+'"] span.count'),Z=parseInt(af.text()),ae=0,W=af.attr("class").match(/count\sindicator\s(.+)/),aa=l($("<div>").html(v));$.each(aa,function(){ae=Math.max(ae,this.priority)});af.text(Z+aa.length);af.removeClass().addClass("count"+T[Math.max(ae,(W?ab[W[1]]:0))]);h(N.find('input[name="item[id]"]').val());B()}$.each(l(),function(){ac=Math.max(ac,this.priority)});var U=F.list.$el.find(".pl-list-due");if(U.length){V=ab[U.attr("class").match(/pl-list-due\s(pl-.*)/)[1]]}X.removeClass().addClass("count"+T[Math.max(ac,V)])}$.isFunction(ad)&&ad.call()};var Q=function(U,X){var T=U.attr("id"),W=T+"-iframe";if(!$("#"+W).length){U.after("<iframe id="+W+" name="+W+" style='display:none;'></iframe>")}var V=$("#"+W);U.attr("target",W);V.one("load",function(){var Y=$(this).contents().find("body").html();o(Y,X)})};Q(N,S)};var l=function(o){o=o||d;var N=[];o.find(r).each(function(Q){var R=$(this),O=R.find(".pl-done").length?R.find(".pl-done").attr("class").match(/pl-done\s(pl-.*)/):null,P=0;if(O&&O.length>0){switch(O[1]){case"pl-red":P=3;break;case"pl-yellow":P=2;break;case"pl-green":P=1;break}}N.push({id:R.data("id"),parent_id:R.data("parent-id"),sort:Q,has_children:R.find(r).length?1:0,priority:P})});return N};var f=function(o){if(F.enableSortItems&&F.list){$.post("?module=item&action=sort",{list_id:F.list.list_id,item_id:o?o:0,data:l()},function(N){if(N.status==="ok"){G()}else{alert(N.errors)}},"json")}};var u=function(N,o,P){var O=parseInt(N.data("id"));N.prop("disabled",true);$.post("?module=item&action=complete",{id:O,status:o},function(Q){if(Q.status==="ok"){$.pocketlists.updateAppCounter();N.find("ul.menu-v").find(":checkbox").prop("checked",o);N.find(".pl-done").prop("disabled",false);N.find(".pl-item-name").toggleClass("gray");setTimeout(function(){N.slideToggle(200,function(){if(o){if(w.length){w.prepend(N)}N.find(".pl-reply").hide()}else{d.append(N);N.find(".pl-reply").show();f()}N.show();B();n.show().find("i").text($_("Show all "+w.find("[data-id]").length+" completed to-dos"));b();P&&$.isFunction(P)&&P.call(N)})},800)}else{alert(Q.errors)}$.pocketlists.$loading.remove()},"json")};var a=function(o){if(F.enableChangeLevel&&v){o.preventDefault();o.stopPropagation();v.each(function(){var P=$(this),O=P.prev(r);if(O.length){var Q=parseInt(O.data("id"));P.data("parent-id",Q);var N=O.find("ul.menu-v").first();if(N.length){N.append(P)}else{O.append($('<ul class="menu-v">').html(P))}f(parseInt(P.data("id")))}})}};var q=function(o){if(F.enableChangeLevel&&v){o.preventDefault();o.stopPropagation();v.each(function(){var O=$(this),N=O.parents(r).first();if(N.length){var Q=parseInt(N.data("parent-id"));O.data("parent-id",Q);var P=O.nextAll(),R=O.find("ul.menu-v");if(!R.length){R=$('<ul class="menu-v">');O.append(R)}R.append(P);N.after(O);f(parseInt(O.data("id")))}})}};var J=function(o){var N=o.find('[class*="star"]'),O=parseInt(o.data("id"));$.post("?module=item&action=favorite",{id:O,status:N.hasClass("star-empty")?1:0},function(P){if(P.status==="ok"){N.toggleClass("star-empty star")}else{alert(P.errors)}},"json")};var p=function(o){v=o;if(v){var N=v.find(".pl-item").first();k.find(".pl-item").removeClass("pl-item-selected");N.addClass("pl-item-selected");v.prop("checked",true)}};var m=function(){if(v){k.find(".pl-item").removeClass("pl-item-selected");v.prop("checked",false);v=null}};var h=function(o){k.find('[data-id="'+o+'"]').remove()};var c=function(o){if(v){v.find(".pl-item").first().replaceWith($(o).addClass("pl-item-selected"))}};var B=function(){if(F.list&&F.list.list_id){$("#pl-lists").find('[data-pl-list-id="'+F.list.list_id+'"]').find(".count").text(d.find("[data-id]").length)}};var L=function(){return !l().length};var b=function(){if(L()&&F.showMessageOnEmptyList){C.show();$(".pl-title h1").css("opacity","0.25")}};var D=function(){if(F.showMessageOnEmptyList){C.hide();$(".pl-title h1").css("opacity","1")}};var i=function(){v.find(".pl-chat").show().find("textarea").trigger("focus")};var K=function(){if(!v.find(".pl-cue").length){v.find(".pl-chat").hide()}};var g=function(N){var O=$(this),o=O.closest(r).data("id");$.post("?module=comment&action=add",{item_id:o,comment:N.comment},function(R){if(R.status==="ok"){var Q=O.closest(".pl-reply"),S=Q.find("i").clone(),P=$('<div class="pl-cue pl-my-cue">');P.append($('<div class="pl-cue-inner">').append('<div class="pl-bubble">'+R.data.comment+"</div></div>",S," "+R.data.username,' <span class="hint">'+R.data.datetime+"</span>"));O.closest(".pl-reply").before(P);O.val("").trigger("focus")}},"json")};var x=(function(N){var o=function(){N.slideUp(200,function(){N.detach();$(".pl-new-item-wrapper").remove();t.val("");b()})};var O=function(){M.on("click",function(R){R.preventDefault();R.stopPropagation();function Q(){D();N.prependTo(d).slideDown(200,function(){t.focus()}).wrap('<li class="pl-new-item-wrapper">')}if(N.is(":visible")){N.slideUp(200,function(){N.detach();$(".pl-new-item-wrapper").remove();Q()})}else{Q()}});if(L()&&!F.showMessageOnEmptyList){M.trigger("click")}t.on("change cut keydown drop paste",function(){window.setTimeout(function(){$.pocketlists.resizeTextarea($new_item_input)},0)}).on("keydown",function(T){var S=$(this);S.data("can_blur",true);if(!T.shiftKey&&T.which===13){T.preventDefault();var R=S.closest(".menu-v").find(r).first().data("parent-id"),Q=S.val().trim();if(Q){I.call(this,[{name:Q,parent_id:R}])}}else{if(T.which===27){S.data("can_blur",false);o()}}}).on("paste",function(){var Q=this,R=$(this).closest(".menu-v").find(r).first().data("parent-id");if(!$(this).val().length){setTimeout(function(){var S=t.val().split(/\n/);var V=[];if(S.length>1){for(var U=0;U<S.length;U++){var T=$.trim(S[U]);if(T){V.push({name:T,parent_id:R})}}I.call(Q,V)}},100)}}).on("blur",function(){var T=$(this),S=T.closest(".menu-v").find(r).first().data("parent-id"),R=T.val().trim(),Q=T.data("can_blur");if(Q){if(R){I.call(this,[{name:R,parent_id:S}],o)}else{o()}}});var P=null;if(F.enableAddLinkOnHover){d.on("mouseenter",r+" > .pl-item",function(R){R.stopPropagation();var Q=$(this);P=setTimeout(function(){if(!Q.find(A).length){Q.find(".pl-chat").after(y.show())}},1312)}).on("mouseleave",r+" > .pl-item",function(){clearTimeout(P);y.detach()});y.on("click",function(S){S.preventDefault();S.stopPropagation();var Q=$(this);var R=Q.closest(r).find(".menu-v");t.data("can_blur",false);if(R.length){R.find(".pl-item").first().before(A)}else{Q.closest(r).find(".pl-item").first().after(A)}y.detach();N.slideDown(200);t.focus();t.data("can_blur",true)})}};M.length&&O();return{hide:o}}(A));var j=(function(P){var S=0,o=$("#pl-dialog-delete-item-confirm");var O=function(){P.animate({right:"-100%"},200,function(){P.hide().empty()});S=0;k.trigger("deselectItem.pl2")};var N=function(T){S=T;P.html($.pocketlists.$loading).show().animate({right:"0%"},200);$.pocketlists.stickyDetailsSidebar();$.post("?module=item&action=details",{id:S},function(U){P.html(U);R()})};var R=function(){var T={changeMonth:true,changeYear:true,shortYearCutoff:2,dateShowWeek:false,showOtherMonths:true,selectOtherMonths:true,stepMonths:1,numberOfMonths:1,gotoCurrent:true,constrainInput:false,dateFormat:"yy-mm-dd",onClose:function(){if(P.find("#pl-item-due-datetime").val()){if(!P.find("#pl-item-due-datetime-clear").is(":visible")){P.find("#pl-item-due-datetime-set").show()}}else{P.find("#pl-item-due-datetime-set, #pl-item-due-datetime-hours, #pl-item-due-datetime-minutes, #pl-item-due-datetime-clear").hide()}}};P.find("#pl-item-due-datetime").datepicker(T)};var Q=function(){if(P.data("pl-ListDetails")){return}P.data("pl-ListDetails",true);P.on("submit","form",function(U){var T=$(this);T.find("#pl-item-details-save").after($.pocketlists.$loading);z(T,function(){T.find("#pl-item-details-save").removeClass("yellow");O()})}).on("click","#pl-item-details-cancel",function(T){T.preventDefault();O()}).on("click","#pl-item-priority a",function(T){T.preventDefault();$("#pl-item-priority").find("input").val($(this).data("pl-item-priority")).trigger("change");$(this).addClass("selected").siblings().removeClass("selected")}).on("click","#pl-item-due-datetime-set",function(U){U.preventDefault();var T=$(this);T.hide().siblings().show().filter("select").prop("disabled",false)}).on("click","#pl-item-due-datetime-clear",function(U){U.preventDefault();var T=$(this);T.hide().siblings().show().filter("select").hide().prop("disabled",true)}).on("click",'[data-pl-action="item-delete"]',function(T){T.preventDefault();o.waDialog({height:"150px","min-height":"150px",width:"400px",onLoad:function(){},onSubmit:function(U){$.post("?module=item&action=delete",{id:S},function(V){if(V.status==="ok"){h(V.data.id);k.find('[data-id="'+V.data.id+'"]').remove();U.trigger("close");O();B()}else{}},"json");return false}})}).on("change","#pl-assigned-contact select",function(){var T=$(this).val();$("#pl-assigned-contact").find('[data-pl-contact-id="'+T+'"]').show().siblings().hide()}).on("change paste keyup",":input",function(){P.find("#pl-item-details-save").addClass("yellow")}).on("show.pl2",function(T,U){N(U)}).on("hide.pl2",O).on("change","#pl-item-pocket",function(){var T=$(this).find(":selected").val();$(this).after($.pocketlists.$loading);$.get("?module=json&action=getLists&id="+T,function(U){$.pocketlists.$loading.remove();if(U.status==="ok"){$("#pl-item-list").empty();$.each(U.data,function(){$("#pl-item-list").append($('<option value="'+this.id+'">').text(this.name))});$("#pl-item-list").trigger("change")}},"json")}).on("change","#pl-item-list",function(){var T=$(this).find(":selected").val();if(T){P.find('input[name="item[list_id]"]').val(T)}});$(window).scroll(function(){$.pocketlists.stickyDetailsSidebar()})};Q();return{$el:P,trigger:function(T,U){this.$el&&this.$el.trigger(T,U)},isVisible:function(){return this.$el?this.$el.is(":visible"):false}}}($("#pl-item-details")));var H=function(){if(F.archive){k.find(":checkbox").prop("disabled",true)}b();G();k.on("change",".pl-done",function(){var O=$(this),N=O.closest(r),o=O.is(":checked")?1:0;u(N,o)}).on("change",".pl-is-selected",function(P){var O=$(this),o=O.closest(r),Q=(v&&v.data("id")==o.data("id"))?true:false,N=parseInt(o.data("id"));P.preventDefault();if(j.isVisible()){m(o);j.trigger("hide.pl2")}if(N){if(!j.isVisible()&&!Q){j.trigger("hide.pl2");p(o)}else{if(!v.find(".pl-chat").is(":visible")){p(o);i()}else{K();m()}}}}).on("click",".pl-edit",function(O){O.preventDefault();var N=$(this),o=N.closest(r);j.trigger("show.pl2",[parseInt(o.data("id"))]);p(o)}).on("click",'[data-pl-action="item-favorite"]',function(O){O.preventDefault();var N=$(this),o=N.closest(r);J(o)}).on("increaseSelectedItem.pl2",function(o){a(o)}).on("decreaseSelectedItem.pl2",function(o){q(o)}).on("deselectItem.pl2",m).on("removeItem.pl2",function(o,N){h(N)}).on("replaceSelectedItem.pl2",function(N,o){c(o)}).on("change cut keydown drop paste",".pl-chat .pl-reply textarea",function(){var o=$(this);window.setTimeout(function(){$.pocketlists.resizeTextarea(o)},0)}).on("keydown",".pl-chat .pl-reply textarea",function(N){var o=$(this);if(!N.shiftKey&&N.which===13){N.preventDefault();var O=o.val().trim();if(O){g.call(this,{comment:O})}}else{if(N.which===27){K()}}});$(document).on("keydown",function(o){switch(o.which){case 9:if(!(F.list&&F.list.list_details.isVisible())&&!j.isVisible()){if(o.shiftKey){q(o)}else{a(o)}}break;case 27:j.isVisible()&&j.trigger("hide.pl2");break}});n.click(function(){e.slideDown(200);$(this).slideUp(200);return false})};H();return{$el:k,trigger:function(o,N){this.$el&&this.$el.trigger(o,N)}}};