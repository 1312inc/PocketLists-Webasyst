(function(){var p=parseInt($("#pl-list-id").val()),o=parseInt($("#pl-pocket-id").val()),i=$("#pl-list-items"),m=$("#pl-undone-items > ul.menu-v"),a=$("#pl-complete-log > ul.menu-v"),n=$('<i class="icon16 loading">'),l=$("#pl-new-list-input"),r=$("#pl-item-add").detach(),f=r.find("textarea"),q=$('<div id="pl-item-add-wrapper-hover" style="display: none;">'),j="[data-parent-id]";var c=function(t){var s={name:$(this).val().trim(),type:"checklist",pocket_id:o};if(s.name){$(this).after(n);$.post("?module=list&action=update",{data:s,id:t},function(u){if(u.status==="ok"){if(p===-1){$.wa.setHash("#/pocket/"+o+"/list/"+u.data.id+"/")}}else{}},"json")}};var g=function(s){var t=$(this);t.after(n);$.post("?module=item&action=create",{list_id:p,data:s},function(v){var w=t.closest(j);var u=$(""+v+"");u.filter(j).last().find(".pl-item").first().after(r);if(w.length){w.after(u)}else{m.prepend(u)}n.remove();f.val("").trigger("focus");d.call(u)})};var k=function(s,t){$.post("?module=item&action=move",{list_id:p,data:s},function(u){if(u.status==="ok"){$.isFunction(t)&&t.call()}else{alert(u.errors)}},"json")};var e=function(){var s=[];m.find(j).each(function(t){var u=$(this);s.push({id:u.data("id"),parent_id:u.data("parent-id"),sort:t})});return s};var d=function(s){this.find("label").first().append(n);$.post("?module=item&action=sort",{list_id:p,data:e()},function(t){if(t.status==="ok"){h();s&&$.isFunction(s)&&s.call()}else{alert(t.errors)}n.remove()},"json")};var b=function(u,s,t){this.find("label").first().append(n);$.post("?module=item&action=complete",{list_id:p,id:u,status:s},function(v){if(v.status==="ok"){t&&$.isFunction(t)&&t.call()}else{alert(v.errors)}n.remove()},"json")};if(l.length){l.focus();l.on("keydown",function(s){if(s.which===13){s.preventDefault();c.call(this,p)}})}$("#pl-item-add-link").click(function(s){s.preventDefault();if(r.is(":visible")){r.slideUp(200,function(){r.detach();$(".pl-new-item-wrapper").remove()})}else{r.prependTo(m).slideDown(200).wrap('<li class="pl-new-item-wrapper">')}f.focus()});f.on("keydown",function(u){var t=$(this);if(u.which===13){u.preventDefault();var s=t.closest(".menu-v").find(j).first().data("parent-id");g.call(this,[{name:t.val().trim(),parent_id:s}])}else{if(u.which===27){r.slideUp(200,function(){r.detach();$(".pl-new-item-wrapper").remove()});f.val("")}}}).on("paste",function(u){var t=$(this).closest(".menu-v").find(j).first().data("parent-id");var s=this;setTimeout(function(){var v=f.val().split(/\n/);var y=[];if(v.length>1){for(var x=0;x<v.length;x++){var w=$.trim(v[x]);if(w){y.push({name:w,parent_id:t})}}g.call(s,y)}},100)});m.on("mouseenter",j+" > .pl-item",function(u){u.stopPropagation();var s=$(this);if(!s.find(r).length){var t=s.closest(j).find(".menu-v");if(t.length){t.find(".pl-item").first().before(q.show())}else{s.after(q.show())}}}).on("mouseleave",function(s){q.detach()});q.on("click",function(s){q.after(r);q.detach();r.slideDown(200);f.focus()});i.on("change",".pl-is-selected",function(){$("#pl-item-details").toggle();i.find(".pl-item").removeClass("pl-item-selected");$(this).closest(".pl-item").toggleClass("pl-item-selected")});i.on("change",".pl-done",function(v){var u=$(this),t=u.closest(j),w=parseInt(t.data("id")),s=u.is(":checked")?1:0;t.find("ul.menu-v .pl-done").prop("checked",s);b.call(t,w,s,function(){t.slideToggle(200,function(){t.show();if(s){a.append(t)}else{m.append(t);d.call(t)}})})});$(document).on("keydown",function(s){var t=m.find(".pl-item-selected").closest(j);if(s.which===39){if(t.length){t.each(function(){var w=$(this),v=w.prev(j),u=v.next(j);if(v.length){var z=parseInt(v.data("id")),x=parseInt(w.data("id")),A=u.length?parseInt(u.data("id")):0,y=[{id:x,parent_id:z,before_id:A}];w.data("parent-id",z);d.call(w,function(){var B=v.find("ul").first();if(B.length){B.append(w)}else{v.append($('<ul class="menu-v">').html(w))}})}})}}else{if(s.which===37){if(t.length){t.each(function(){var B=$(this),u=B.parents(j).first(),w=u.next(j);if(u.length){var z=parseInt(u.data("parent-id")),C=parseInt(B.data("id")),v=w.length?parseInt(w.data("id")):0,y=[{id:C,parent_id:z,before_id:v}];B.data("parent-id",z);var A=B.nextAll(),x=B.find("ul.menu-v");A.each(function(){A.data("parent-id",C);y.push({id:$(this).data("id"),parent_id:C})});d.call(B,function(){if(!x.length){x=$('<ul class="menu-v">');B.append(x)}x.append(A);u.after(B)})}})}}}});var h=function(){m.sortable({connectWith:"ul.menu-v",placeholder:"pl-item-placeholder",stop:function(t,v){var s=v.item.parents(j).first(),u=s.length?parseInt(s.data("id")):0;v.item.data("parent-id",u);d.call(v.item)}})};h();$("#pl-complete-log-link").click(function(){$("#pl-complete-log").slideToggle(200);$(this).hide(200);return false})}());