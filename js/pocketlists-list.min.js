(function(){$.pocketlists.List=function(g){var e=g.find("#pl-new-list-input"),f=parseInt(g.find("#pl-list-id").val()),m=parseInt($("#pl-pocket-id").val()),b=$("#pl-dialog-delete-confirm"),c=$("#pl-dialog-list-archive-complete-all");var l=(function(t){var s=null;var p=function(){$.pocketlists.scrollToTop(200,80);t.html($.pocketlists.$loading).show();a();$.post("?module=list&action=details",{id:f},function(w){t.html(w);v()})};var r=function(){t.hide().empty()};var q=function(){var x=t.find('input[name="list[name]"]').val(),w=t.find("[data-pl-list-color].selected").data("pl-list-color"),y=t.find('input[name="list[icon]"]').val();$("#pl-list-name").text(x);$("#pl-lists").find('[data-pl-list-id="'+f+'"]').removeClass().addClass("pl-"+w).find(".pl-list-name").text(x).end().find(".listicon48").css("background-image","url("+s+y+")");$(".pl-items").removeClass().addClass("pl-items pl-"+w)};var v=function(){var w={changeMonth:true,changeYear:true,shortYearCutoff:2,dateShowWeek:false,showOtherMonths:true,selectOtherMonths:true,stepMonths:1,numberOfMonths:1,gotoCurrent:true,constrainInput:false};t.find("#pl-list-due-datetime").datepicker(w);s=t.find("#pl-list-icon-dialog").find("ul").data("pl-icons-path")};var u=function(){if(t.data("pl-ListDetails")){return}t.data("pl-ListDetails",true);t.on("submit","form",function(x){x.preventDefault();var w=$(this);w.find("#pl-list-details-save").after($.pocketlists.$loading);$.post("?module=list&action=save",w.serialize(),function(y){$.pocketlists.$loading.remove();if(y.status==="ok"){q();r()}else{t.find(".error").show().delay(3000).hide()}},"json");return false}).on("click","#pl-list-details-cancel",function(w){w.preventDefault();r()}).on("click","#pl-list-color a",function(w){w.preventDefault();$("#pl-list-color").find("input").val($(this).data("pl-list-color"));$(this).addClass("selected").siblings().removeClass("selected")}).on("click","#pl-list-due-datetime-set",function(x){x.preventDefault();var w=$(this);w.hide().siblings().show().filter("select").prop("disabled",false)}).on("click","#pl-list-due-datetime-clear",function(x){x.preventDefault();var w=$(this);w.hide().siblings().show().filter("select").hide().prop("disabled",true)}).on("click","#pl-list-icon-change a",function(w){w.preventDefault();$("#pl-list-icon-dialog").waDialog({onLoad:function(){var x=$(this);$("#pl-list-icon-dialog").on("click","a[data-pl-list-icon]",function(A){A.preventDefault();var y=$(this).data("pl-list-icon"),z=$(this);t.find("#pl-list-icon-change").find("input").val($(this).data("pl-list-icon"));z.find("input").val(y);t.find("#pl-list-icon-change .listicon48").css("background-image","url("+s+y+")");x.trigger("close");return false})}})}).on("show.pl2",p).on("hide.pl2",r)};u();return{$el:t,trigger:function(w,x){this.$el&&this.$el.trigger(w,x)},isVisible:function(){return this.$el?this.$el.is(":visible"):false}}}($("#pl-list-details")));var o=function(q){var p={name:e.val().trim(),type:"checklist",pocket_id:m};if(p.name){$.post("?module=list&action=update",{data:p,id:q},function(s){if(s.status==="ok"){if(f===-1){$.wa.setHash("#/pocket/"+m+"/list/"+s.data.id+"/")}}else{}},"json")}};var j=function(){var p=g.find('[class*="star"]');$.post("?module=list&action=favorite",{id:f,status:p.hasClass("star-empty")?1:0},function(q){if(q.status==="ok"){p.toggleClass("star-empty star")}else{alert(q.errors)}},"json")};var k=function(){b.waDialog({height:"150px","min-height":"150px",width:"400px",onLoad:function(){},onSubmit:function(p){$.post("?module=list&action=delete",{list_id:f},function(q){if(q.status==="ok"){p.trigger("close");$.wa.setHash("#/pocket/1/")}else{}},"json");return false}})};var d=function(){$.post("?module=list&action=archive",{list_id:f,archive:1},function(p){if(p.status==="ok"){$.wa.setHash("#/pocket/1/")}else{}},"json")};var i=function(){$.post("?module=list&action=sort",{list_id:f},function(p){if(p.status==="ok"){$.pocketlists_routing.redispatch()}else{}},"json")};var h=function(){g.removeData("pl-clicked")};var n=function(){if(e.length){e.focus();e.on("keydown",function(p){if(p.which===13){p.preventDefault();o(f)}})}g.on("click",function(q){var p=g.data("pl-clicked");if($(q.target).closest(".pl-done-label").length){return}if(p==1){g.data("pl-clicked",2);$.pocketlists.scrollToTop(200,80);l.trigger("show.pl2")}else{if(p==2){l.trigger("hide.pl2");h()}else{g.data("pl-clicked",1)}}}).on("click",'[data-pl-action="list-delete"]',function(p){p.preventDefault();k()}).on("click",'[data-pl-action="list-archive"]',function(p){p.preventDefault();d()}).on("click",'[data-pl-action="list-sort"]',function(p){p.preventDefault();i()}).on("click",'[data-pl-action="list-favorite"]',function(p){p.preventDefault();j()}).on("click","#pl-list-complete",function(p){p.stopPropagation();c.waDialog({height:"150px","min-height":"150px",width:"400px",onLoad:function(){var q=$(this);q.on("click","[data-pl-action]",function(t){t.preventDefault();var s=$(this),r=s.data("pl-action");s.after($.pocketlists.$loading);if(r==="list-complete-all"){$.post("?module=list&action=complete",{list_id:f,status:1},function(u){if(u.status==="ok"){q.trigger("close");$.pocketlists_routing.redispatch()}else{}},"json")}else{if(r==="list-archive"){$.post("?module=list&action=archive",{list_id:f,archive:1},function(u){if(u.status==="ok"){q.trigger("close");$.wa.setHash("#/pocket/"+m)}else{}},"json")}else{if(r==="cancel"){$("#pl-list-complete").prop("checked",false);q.trigger("close");$.pocketlists.$loading.remove()}}}})}})}).on("deleteList.pl2",k).on("deselectList.pl2",h);$(document).on("keydown",function(p){switch(p.which){case 27:l.isVisible()&&l.trigger("hide.pl2");break}})};n();return{list_details:l,list_id:f,pocket_id:m}};$.pocketlists.Items=function(n,h){var s=n.find("#pl-undone-items > ul.menu-v"),t=$("#pl-undone-items ul.menu-v"),d=n.find("#pl-complete-log > ul.menu-v"),D=$("#pl-item-add").detach(),i=D.find("textarea"),B=$('<div id="pl-item-add-wrapper-hover" style="display: none;">'),p="[data-parent-id]",k=$("#pl-item-add-link"),C=null,l={enableAddLinkOnHover:true,enableChangeLevel:true,enableSortItems:true,list:null},r={},e=this;var b=function(){if(r.enableSortItems){t.sortable({item:p,connectWith:"ul.menu-v",placeholder:"pl-item-placeholder",tolerance:"pointer",stop:function(G,I){var o=I.item.parents(p).first(),H=o.length?parseInt(o.data("id")):0;I.item.data("parent-id",H);f(parseInt(I.item.data("id")))}})}};var A=function(o,H){var G=$(this);$.post("?module=item&action=create",{list_id:r.list?r.list.list_id:0,data:o},function(J){var K=G.closest(p);var I=$(""+J+"");i.data("can_blur",false);if(K.length){if(!K.parents(p).length||D.prev(".pl-item").length){K.after(I)}else{K.before(I)}}else{s.prepend(I)}I.filter(p).last().find(".pl-item").first().after(D);$(".pl-list-empty").removeClass("pl-list-empty");i.val("").trigger("focus").css("height","auto").data("can_blur",true);$.isFunction(H)&&H.call(G);g();f()})};var c=function(){var o=[];s.find(p).each(function(G){var H=$(this);o.push({id:H.data("id"),parent_id:H.data("parent-id"),sort:G,has_children:H.find(p).length?1:0})});return o};var f=function(o){if(r.enableSortItems){$.post("?module=item&action=sort",{list_id:$.pocketlists.List.list_id,item_id:o?o:0,data:c()},function(G){if(G.status==="ok"){b()}else{alert(G.errors)}},"json")}};var E=function(G,o,I){var H=parseInt(G.data("id"));G.prop("disabled",true);$.post("?module=item&action=complete",{id:H,status:o},function(J){if(J.status==="ok"){$.pocketlists.updateAppCounter();G.find("ul.menu-v").find(":checkbox").prop("checked",o);G.find(".pl-done").prop("disabled",false);G.find(".pl-item-name").toggleClass("gray");setTimeout(function(){G.slideToggle(200,function(){G.show();if(o){d.append(G)}else{s.append(G);f()}g();$("#pl-complete-log-link").find("i").text($_("Show all "+d.find("[data-id]").length+" completed to-dos"));I&&$.isFunction(I)&&I.call(G)})},800)}else{alert(J.errors)}$.pocketlists.$loading.remove()},"json")};var x=function(o){if(r.changeLevel&&C){o.preventDefault();o.stopPropagation();C.each(function(){var I=$(this),H=I.prev(p);if(H.length){var J=parseInt(H.data("id"));I.data("parent-id",J);var G=H.find("ul.menu-v").first();if(G.length){G.append(I)}else{H.append($('<ul class="menu-v">').html(I))}f(parseInt(I.data("id")))}})}};var w=function(o){if(r.changeLevel&&C){o.preventDefault();o.stopPropagation();C.each(function(){var H=$(this),G=H.parents(p).first();if(G.length){var J=parseInt(G.data("parent-id"));H.data("parent-id",J);var I=H.nextAll(),K=H.find("ul.menu-v");if(!K.length){K=$('<ul class="menu-v">');H.append(K)}K.append(I);G.after(H);f(parseInt(H.data("id")))}})}};var y=function(o){var G=o.find('[class*="star"]'),H=parseInt(o.data("id"));$.post("?module="+type+"&action=favorite",{id:H,status:G.hasClass("star-empty")?1:0},function(I){if(I.status==="ok"){G.toggleClass("star-empty star")}else{alert(I.errors)}},"json")};var j=function(o){C=o;if(C){var G=C.find(".pl-item").first();n.find(".pl-item").removeClass("pl-item-selected");G.addClass("pl-item-selected");C.prop("checked",true)}};var m=function(){if(C){n.find(".pl-item").removeClass("pl-item-selected");C.prop("checked",false);C=null}};var F=function(o){n.find('[data-id="'+o+'"]').remove()};var v=function(o){if(C){C.find(".pl-item").first().replaceWith($(o).addClass("pl-item-selected"))}};var g=function(){if(r.list&&r.list.list_id){$("#pl-lists").find('[data-pl-list-id="'+r.list.list_id+'"]').find(".count").text(s.find("[data-id]").length)}};var q=function(){var G=function(){i.css("height","auto");i.css("height",(i.get(0).scrollHeight-parseInt(i.css("padding-top"))-parseInt(i.css("padding-bottom")))+"px")};var o=function(){D.slideUp(200,function(){D.detach();$(".pl-new-item-wrapper").remove();i.val("")})};var H=function(){k.on("click",function(K){K.preventDefault();K.stopPropagation();function J(){D.prependTo(s).slideDown(200,function(){i.focus()}).wrap('<li class="pl-new-item-wrapper">')}if(D.is(":visible")){D.slideUp(200,function(){D.detach();$(".pl-new-item-wrapper").remove();J()})}else{J()}});if($(".pl-list-empty").length){k.trigger("click")}i.on("change cut keydown drop paste",function(){window.setTimeout(G,0)}).on("keydown",function(M){var L=$(this);L.data("can_blur",true);if(!M.shiftKey&&M.which===13){M.preventDefault();var K=L.closest(".menu-v").find(p).first().data("parent-id"),J=L.val().trim();if(J){A.call(this,[{name:J,parent_id:K}])}}else{if(M.which===27){o()}}}).on("paste",function(){var K=$(this).closest(".menu-v").find(p).first().data("parent-id");var J=this;setTimeout(function(){var L=i.val().split(/\n/);var O=[];if(L.length>1){for(var N=0;N<L.length;N++){var M=$.trim(L[N]);if(M){O.push({name:M,parent_id:K})}}A.call(J,O)}},100)}).on("blur",function(){var M=$(this),L=M.closest(".menu-v").find(p).first().data("parent-id"),K=M.val().trim(),J=M.data("can_blur");if(J){if(K){A.call(this,[{name:K,parent_id:L}],o)}else{o()}}});var I=null;if(r.enableAddLinkOnHover){s.on("mouseenter",p+" > .pl-item",function(K){K.stopPropagation();var J=$(this);I=setTimeout(function(){if(!J.find(D).length){J.find(".pl-select-label").append(B.show())}},500)}).on("mouseleave",p+" > .pl-item",function(){clearTimeout(I);B.detach()});B.on("click",function(){var J=$(this);var K=J.closest(p).find(".menu-v");i.data("can_blur",false);if(K.length){K.find(".pl-item").first().before(D)}else{J.closest(p).find(".pl-item").first().after(D)}B.detach();D.slideDown(200);i.focus();i.data("can_blur",true)})}};H()};var u=(function(J){var M=0,o=$("#pl-dialog-delete-confirm"),G=this;var I=function(){J.hide().empty();M=0;n.trigger("deselectItem.pl2")};var H=function(N){M=N;J.html($.pocketlists.$loading).show();a();$.post("?module=item&action=details",{id:M},function(O){J.html(O);L()})};var L=function(){var N={changeMonth:true,changeYear:true,shortYearCutoff:2,dateShowWeek:false,showOtherMonths:true,selectOtherMonths:true,stepMonths:1,numberOfMonths:1,gotoCurrent:true,constrainInput:false};J.find("#pl-item-due-datetime").datepicker(N)};var K=function(){if(J.data("pl-ListDetails")){return}J.data("pl-ListDetails",true);J.on("submit","form",function(O){O.preventDefault();var N=$(this);N.find("#pl-item-details-save").after($.pocketlists.$loading);$.post("?module=item&action=data",N.serialize(),function(P){$.pocketlists.updateAppCounter();$.pocketlists.$loading.remove();n.trigger("replaceSelectedItem.pl2",[P]);I()});return false}).on("click","#pl-item-details-cancel",function(N){N.preventDefault();I()}).on("click","#pl-item-priority a",function(N){N.preventDefault();$("#pl-item-priority").find("input").val($(this).data("pl-item-priority"));$(this).addClass("selected").siblings().removeClass("selected")}).on("click","#pl-item-due-datetime-set",function(O){O.preventDefault();var N=$(this);N.hide().siblings().show().filter("select").prop("disabled",false)}).on("click","#pl-item-due-datetime-clear",function(O){O.preventDefault();var N=$(this);N.hide().siblings().show().filter("select").hide().prop("disabled",true)}).on("click",'[data-pl-action="item-delete"]',function(N){N.preventDefault();o.waDialog({height:"150px","min-height":"150px",width:"400px",onLoad:function(){},onSubmit:function(O){$.post("?module=item&action=delete",{id:M,list_id:list.list_id},function(P){if(P.status==="ok"){n.trigger("deselectItem.pl2",[P.data.id]);I();O.trigger("close")}else{}},"json");return false}})}).on("change","#pl-assigned-contact select",function(){var N=$(this).val();$("#pl-assigned-contact").find('[data-pl-contact-id="'+N+'"]').show().siblings().hide()}).on("show.pl2",function(N,O){H(O)}).on("hide.pl2",I)};K();return{$el:J,trigger:function(N,O){this.$el&&this.$el.trigger(N,O)},isVisible:function(){return this.$el?this.$el.is(":visible"):false}}}($("#pl-item-details")));var z=function(){r=$.extend({},l,h);;if($.pocketlists_routing.getHash()=="#/todo/"&&$.pocketlists_routing.getHash().indexOf("/team/")>0){D.prependTo(s).slideDown(200).wrap('<li class="pl-new-item-wrapper">');i.focus()}b();k.length&&new q();n.on("change",".pl-done",function(){var H=$(this),G=H.closest(p),o=H.is(":checked")?1:0;E(G,o)}).on("change",".pl-is-selected",function(H){var G=$(this),o=G.closest(p),I=(C&&C.data("id")==o.data("id"))?true:false;H.preventDefault();if(!o.find("#pl-item-add").length){if(!u.isVisible()&&!I){u.trigger("hide.pl2");j(o)}else{if(!u.isVisible()){u.trigger("show.pl2",[parseInt(o.data("id"))]);j(o)}else{u.trigger("hide.pl2");m()}}}}).on("click",".pl-favorite",function(H){H.preventDefault();var G=$(this),o=G.closest(p);y(o)}).on("increaseSelectedItem.pl2",function(o){x(o)}).on("decreaseSelectedItem.pl2",function(o){w(o)}).on("deselectItem.pl2",m).on("removeItem.pl2",function(o,G){F(G)}).on("replaceSelectedItem.pl2",function(G,o){v(o)});$(document).on("keydown",function(o){switch(o.which){case 9:if(!(r.list&&r.list.list_details.isVisible())&&!u.isVisible()){if(o.shiftKey){w(o)}else{x(o)}}break;case 27:u.isVisible()&&u.trigger("hide.pl2");break}})};z();return{$el:n,trigger:function(o,G){this.$el&&this.$el.trigger(o,G)}}};$("#pl-complete-log-link").click(function(){$("#pl-complete-log").slideDown(200);$(this).slideUp(200);return false});function a(){var e=$("#pl-list-content").offset().top;var d=$(window).scrollTop();var b=$(window).height();if($(".pl-details .fields form").height()>b){return}if(d>e){$(".pl-details").addClass("sticky");var c=$(document).height()-b-d;$(".pl-details").css("bottom",Math.max(0,16-c)+"px")}else{$(".pl-details").removeClass("sticky")}}$(window).scroll(function(){a()})}());