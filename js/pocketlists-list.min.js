(function(b){b.pocketlists.List=function(i){var f=i.find("#pl-new-list-input"),g=parseInt(i.find("#pl-list-id").val()),n=parseInt(b("#pl-pocket-id").val()),c=b("#pl-dialog-delete-list-confirm"),d=b("#pl-dialog-list-archive-complete-all");var m=(function(u){var t=null;var q=function(){b.pocketlists.scrollToTop(200,80);u.html(b.pocketlists.$loading).show().animate({right:"0%"},200);a();b.post("?module=list&action=details",{id:g},function(x){u.html(x);w()})};var s=function(){u.animate({right:"-100%"},200,function(){u.hide().empty()})};var r=function(x){i.find("#pl-list-name").text(x.name);if(x.due_date||x.due_datetime){var y="pl-due-someday";if(x.calc_priority==1){y="pl-due-tomorrow"}else{if(x.calc_priority==2){y="pl-due-today"}else{if(x.calc_priority==3){y="pl-due-overdue"}}}i.find(".pl-list-due").removeClass().addClass("pl-list-due "+y).text(x.due_datetime?x.due_datetime:x.due_date).show()}else{i.find(".pl-list-due").hide()}b("#pl-lists").find('[data-pl-list-id="'+g+'"]').removeClass().addClass("pl-"+x.color).find(".pl-list-name").text(x.name).end().find(".listicon48").css("background-image","url("+t+x.icon+")");b(".pl-items").removeClass().addClass("pl-items pl-"+x.color)};var w=function(){var x={changeMonth:true,changeYear:true,shortYearCutoff:2,dateShowWeek:false,showOtherMonths:true,selectOtherMonths:true,stepMonths:1,numberOfMonths:1,gotoCurrent:true,constrainInput:false};u.find("#pl-list-due-datetime").datepicker(x);t=u.find("#pl-list-icon-dialog").find("ul").data("pl-icons-path")};var v=function(){if(u.data("pl-ListDetails")){return}u.data("pl-ListDetails",true);u.on("submit","form",function(y){y.preventDefault();var x=b(this);x.find("#pl-list-details-save").removeClass("yellow").after(b.pocketlists.$loading);b.post("?module=list&action=save",x.serialize(),function(z){b.pocketlists.$loading.remove();if(z.status==="ok"){r(z.data);s()}else{u.find(".error").show().delay(3000).hide()}},"json");return false}).on("click","#pl-list-details-cancel",function(x){x.preventDefault();s()}).on("click","#pl-list-color a",function(x){x.preventDefault();b("#pl-list-color").find("input").val(b(this).data("pl-list-color")).trigger("change");b(this).addClass("selected").siblings().removeClass("selected")}).on("click","#pl-list-due-datetime-set",function(y){y.preventDefault();var x=b(this);x.hide().siblings().show().filter("select").prop("disabled",false)}).on("click","#pl-list-due-datetime-clear",function(y){y.preventDefault();var x=b(this);x.hide().siblings().show().filter("select").hide().prop("disabled",true)}).on("click","#pl-list-icon-change a",function(x){x.preventDefault();b("#pl-list-icon-dialog").waDialog({onLoad:function(){var y=b(this);b("#pl-list-icon-dialog").on("click","a[data-pl-list-icon]",function(B){B.preventDefault();var z=b(this).data("pl-list-icon"),A=b(this);u.find("#pl-list-icon-change").find("input").val(b(this).data("pl-list-icon"));A.find("input").val(z);u.find("#pl-list-icon-change .listicon48").css("background-image","url("+t+z+")");u.find("#pl-list-details-save").addClass("yellow");y.trigger("close");return false})}})}).on("change paste keyup",":input",function(){u.find("#pl-list-details-save").addClass("yellow")}).on("show.pl2",q).on("hide.pl2",s);b(window).scroll(function(){a()})};v();return{$el:u,trigger:function(x,y){this.$el&&this.$el.trigger(x,y)},isVisible:function(){return this.$el?this.$el.is(":visible"):false}}}(b("#pl-list-details")));var p=function(r){var q={name:f.val().trim(),type:"checklist",pocket_id:n};if(q.name){b.post("?module=list&action=update",{data:q,id:r},function(s){if(s.status==="ok"){if(g===-1){b.wa.setHash("#/pocket/"+n+"/list/"+s.data.id+"/")}}else{}},"json")}};var k=function(){var q=i.find('[class*="star"]');b.post("?module=list&action=favorite",{id:g,status:q.hasClass("star-empty")?1:0},function(s){if(s.status==="ok"){q.toggleClass("star-empty star")}else{alert(s.errors)}},"json")};var l=function(){c.waDialog({height:"150px","min-height":"150px",width:"400px",onLoad:function(){},onSubmit:function(q){b.post("?module=list&action=delete",{list_id:g},function(s){if(s.status==="ok"){q.trigger("close");b.wa.setHash("#/pocket/1/")}else{}},"json");return false}})};var e=function(){b.post("?module=list&action=archive",{list_id:g,archive:1},function(q){if(q.status==="ok"){b.wa.setHash("#/pocket/1/")}else{}},"json")};var j=function(){b.post("?module=list&action=sort",{list_id:g},function(q){if(q.status==="ok"){b.pocketlists_routing.redispatch()}else{}},"json")};var h=function(){i.removeData("pl-clicked")};var o=function(){if(f.length){f.focus();f.on("keydown",function(q){if(q.which===13){q.preventDefault();p(g)}})}i.on("click",function(r){var q=i.data("pl-clicked");if(b(r.target).closest(".pl-done-label").length){return}if(q==1){i.data("pl-clicked",2);b.pocketlists.scrollToTop(200,80);m.trigger("show.pl2")}else{if(q==2){m.trigger("hide.pl2");h()}else{i.data("pl-clicked",1)}}}).on("click",'[data-pl-action="list-delete"]',function(q){q.preventDefault();l()}).on("click",'[data-pl-action="list-archive"]',function(q){q.preventDefault();e()}).on("click",'[data-pl-action="list-sort"]',function(q){q.preventDefault();j()}).on("click",'[data-pl-action="list-favorite"]',function(q){q.preventDefault();k()}).on("click","#pl-list-complete",function(q){q.stopPropagation();d.waDialog({height:"150px","min-height":"150px",width:"400px",onLoad:function(){var r=b(this);r.on("click","[data-pl-action]",function(u){u.preventDefault();var t=b(this),s=t.data("pl-action");t.after(b.pocketlists.$loading);if(s==="list-complete-all"){b.post("?module=list&action=complete",{list_id:g,status:1},function(v){if(v.status==="ok"){r.trigger("close");b.pocketlists_routing.redispatch()}else{}},"json")}else{if(s==="list-archive"){b.post("?module=list&action=archive",{list_id:g,archive:1},function(v){if(v.status==="ok"){r.trigger("close");b.wa.setHash("#/pocket/"+n)}else{}},"json")}else{if(s==="cancel"){b("#pl-list-complete").prop("checked",false);r.trigger("close");b.pocketlists.$loading.remove()}}}})}})}).on("deleteList.pl2",l).on("deselectList.pl2",h);b(document).on("keydown",function(q){switch(q.which){case 27:m.isVisible()&&m.trigger("hide.pl2");break}})};o();return{$el:i,list_details:m,list_id:g,pocket_id:n}};b.pocketlists.Items=function(l,t){var f=l.find("#pl-undone-items > ul.menu-v"),F=b("#pl-undone-items ul.menu-v"),g=l.find("#pl-complete-log"),w=g.find("ul.menu-v").first(),B=b("#pl-item-add").detach(),i=B.find("textarea"),z=b('<div id="pl-item-add-wrapper-hover" style="display: none;">'),s="[data-parent-id]",M=b("#pl-item-add-link"),p=b("#pl-complete-log-link"),D=l.find("#pl-empty-list-msg"),v=null,x={enableAddLinkOnHover:true,enableChangeLevel:true,enableSortItems:true,list:null,assignUser:null,showMessageOnEmptyList:false},G={};var H=function(){if(G.enableSortItems){F.sortable({item:s,distance:5,connectWith:"ul.menu-v",placeholder:"pl-item-placeholder",tolerance:"pointer",start:function(N,o){o.placeholder.height(o.helper.outerHeight())},stop:function(N,P){var o=P.item.parents(s).first(),O=o.length?parseInt(o.data("id")):0;P.item.data("parent-id",O);h(parseInt(P.item.data("id")))}})}};var J=function(o,O){var N=b(this);N.closest(".pl-item").find(".pl-done-label span").html(b.pocketlists.$loading);b.post("?module=item&action=create",{list_id:G.list?G.list.list_id:0,data:o,assigned_contact_id:G.assignUser?G.assignUser:false},function(Q){var R=N.closest(s);var P=b(""+Q+"");i.data("can_blur",false);if(R.length){if(!R.parents(s).length||B.prev(".pl-item").length){R.after(P)}else{R.before(P)}}else{f.prepend(P)}P.filter(s).last().find(".pl-item").first().after(B);b.pocketlists.$loading.remove();i.val("").trigger("focus").css("height","auto").data("can_blur",true);b.isFunction(O)&&O.call(N);E();C();h()})};var A=function(o,N){b.post("?module=item&action=data",o,function(R){b.pocketlists.updateAppCounter();b.pocketlists.$loading.remove();e(R);if(G.list){var Q=0,P=0,O="";b.each(m(),function(){Q=Math.max(Q,this.priority)});var S=G.list.$el.find(".pl-list-due");if(S.length){switch(S.attr("class").match(/pl-list-due\s(pl-.*)/)[1]){case"pl-due-tomorrow":P=1;break;case"pl-due-today":P=2;break;case"pl-due-overdue":P=3;break}}switch(Math.max(Q,P)){case 1:O=" indicator green";break;case 2:O=" indicator yellow";break;case 3:O=" indicator red";break}b("#pl-lists").find('[data-pl-list-id="'+G.list.list_id+'"] span.count').removeClass().addClass("count"+O)}b.isFunction(N)&&N.call()})};var m=function(){var o=[];f.find(s).each(function(P){var Q=b(this),N=Q.find(".pl-done").length?Q.find(".pl-done").attr("class").match(/pl-done\s(pl-.*)/):null,O=0;if(N&&N.length>0){switch(N[1]){case"pl-red":O=3;break;case"pl-yellow":O=2;break;case"pl-green":O=1;break}}o.push({id:Q.data("id"),parent_id:Q.data("parent-id"),sort:P,has_children:Q.find(s).length?1:0,priority:O})});console.dir(o);return o};var h=function(o){if(G.enableSortItems&&G.list){b.post("?module=item&action=sort",{list_id:G.list.list_id,item_id:o?o:0,data:m()},function(N){if(N.status==="ok"){H()}else{alert(N.errors)}},"json")}};var u=function(N,o,P){var O=parseInt(N.data("id"));N.prop("disabled",true);b.post("?module=item&action=complete",{id:O,status:o},function(Q){if(Q.status==="ok"){b.pocketlists.updateAppCounter();N.find("ul.menu-v").find(":checkbox").prop("checked",o);N.find(".pl-done").prop("disabled",false);N.find(".pl-item-name").toggleClass("gray");setTimeout(function(){N.slideToggle(200,function(){N.show();if(o){w.prepend(N)}else{f.append(N);h()}C();p.show().find("i").text($_("Show all "+w.find("[data-id]").length+" completed to-dos"));d();P&&b.isFunction(P)&&P.call(N)})},800)}else{alert(Q.errors)}b.pocketlists.$loading.remove()},"json")};var c=function(o){if(G.enableChangeLevel&&v){o.preventDefault();o.stopPropagation();v.each(function(){var P=b(this),O=P.prev(s);if(O.length){var Q=parseInt(O.data("id"));P.data("parent-id",Q);var N=O.find("ul.menu-v").first();if(N.length){N.append(P)}else{O.append(b('<ul class="menu-v">').html(P))}h(parseInt(P.data("id")))}})}};var r=function(o){if(G.enableChangeLevel&&v){o.preventDefault();o.stopPropagation();v.each(function(){var O=b(this),N=O.parents(s).first();if(N.length){var Q=parseInt(N.data("parent-id"));O.data("parent-id",Q);var P=O.nextAll(),R=O.find("ul.menu-v");if(!R.length){R=b('<ul class="menu-v">');O.append(R)}R.append(P);N.after(O);h(parseInt(O.data("id")))}})}};var K=function(o){var N=o.find('[class*="star"]'),O=parseInt(o.data("id"));b.post("?module="+type+"&action=favorite",{id:O,status:N.hasClass("star-empty")?1:0},function(P){if(P.status==="ok"){N.toggleClass("star-empty star")}else{alert(P.errors)}},"json")};var q=function(o){v=o;if(v){var N=v.find(".pl-item").first();l.find(".pl-item").removeClass("pl-item-selected");N.addClass("pl-item-selected");v.prop("checked",true)}};var n=function(){if(v){l.find(".pl-item").removeClass("pl-item-selected");v.prop("checked",false);v=null}};var j=function(o){l.find('[data-id="'+o+'"]').remove()};var e=function(o){if(v){v.find(".pl-item").first().replaceWith(b(o).addClass("pl-item-selected"))}};var C=function(){if(G.list&&G.list.list_id){b("#pl-lists").find('[data-pl-list-id="'+G.list.list_id+'"]').find(".count").text(f.find("[data-id]").length)}};var L=function(){return !m().length};var d=function(){L()&&G.showMessageOnEmptyList&&D.show()};var E=function(){G.showMessageOnEmptyList&&D.hide()};var y=function(){var N=function(){i.css("height","auto");i.css("height",(i.get(0).scrollHeight-parseInt(i.css("padding-top"))-parseInt(i.css("padding-bottom")))+"px")};var o=function(){B.slideUp(200,function(){B.detach();b(".pl-new-item-wrapper").remove();i.val("");d()})};var O=function(){M.on("click",function(R){R.preventDefault();R.stopPropagation();function Q(){E();B.prependTo(f).slideDown(200,function(){i.focus()}).wrap('<li class="pl-new-item-wrapper">')}if(B.is(":visible")){B.slideUp(200,function(){B.detach();b(".pl-new-item-wrapper").remove();Q()})}else{Q()}});if(L()&&!G.showMessageOnEmptyList){M.trigger("click")}i.on("change cut keydown drop paste",function(){window.setTimeout(N,0)}).on("keydown",function(T){var S=b(this);S.data("can_blur",true);if(!T.shiftKey&&T.which===13){T.preventDefault();var R=S.closest(".menu-v").find(s).first().data("parent-id"),Q=S.val().trim();if(Q){J.call(this,[{name:Q,parent_id:R}])}}else{if(T.which===27){S.data("can_blur",false);o()}}}).on("paste",function(){var Q=this,R=b(this).closest(".menu-v").find(s).first().data("parent-id");if(!b(this).val().length){setTimeout(function(){var S=i.val().split(/\n/);var V=[];if(S.length>1){for(var U=0;U<S.length;U++){var T=b.trim(S[U]);if(T){V.push({name:T,parent_id:R})}}J.call(Q,V)}},100)}}).on("blur",function(){var T=b(this),S=T.closest(".menu-v").find(s).first().data("parent-id"),R=T.val().trim(),Q=T.data("can_blur");if(Q){if(R){J.call(this,[{name:R,parent_id:S}],o)}else{o()}}});var P=null;if(G.enableAddLinkOnHover){f.on("mouseenter",s+" > .pl-item",function(R){R.stopPropagation();var Q=b(this);P=setTimeout(function(){if(!Q.find(B).length){Q.find(".pl-select-label").append(z.show())}},500)}).on("mouseleave",s+" > .pl-item",function(){clearTimeout(P);z.detach()});z.on("click",function(){var Q=b(this);var R=Q.closest(s).find(".menu-v");i.data("can_blur",false);if(R.length){R.find(".pl-item").first().before(B)}else{Q.closest(s).find(".pl-item").first().after(B)}z.detach();B.slideDown(200);i.focus();i.data("can_blur",true)})}};O()};var k=(function(P){var S=0,o=b("#pl-dialog-delete-item-confirm");var O=function(){P.animate({right:"-100%"},200,function(){P.hide().empty()});S=0;l.trigger("deselectItem.pl2")};var N=function(T){S=T;P.html(b.pocketlists.$loading).show().animate({right:"0%"},200);a();b.post("?module=item&action=details",{id:S},function(U){P.html(U);R()})};var R=function(){var T={changeMonth:true,changeYear:true,shortYearCutoff:2,dateShowWeek:false,showOtherMonths:true,selectOtherMonths:true,stepMonths:1,numberOfMonths:1,gotoCurrent:true,constrainInput:false};P.find("#pl-item-due-datetime").datepicker(T)};var Q=function(){if(P.data("pl-ListDetails")){return}P.data("pl-ListDetails",true);P.on("submit","form",function(U){U.preventDefault();var T=b(this);T.find("#pl-item-details-save").after(b.pocketlists.$loading);A(T.serialize(),function(){T.find("#pl-item-details-save").removeClass("yellow");O()});return false}).on("click","#pl-item-details-cancel",function(T){T.preventDefault();O()}).on("click","#pl-item-priority a",function(T){T.preventDefault();b("#pl-item-priority").find("input").val(b(this).data("pl-item-priority")).trigger("change");b(this).addClass("selected").siblings().removeClass("selected")}).on("click","#pl-item-due-datetime-set",function(U){U.preventDefault();var T=b(this);T.hide().siblings().show().filter("select").prop("disabled",false)}).on("click","#pl-item-due-datetime-clear",function(U){U.preventDefault();var T=b(this);T.hide().siblings().show().filter("select").hide().prop("disabled",true)}).on("click",'[data-pl-action="item-delete"]',function(T){T.preventDefault();o.waDialog({height:"150px","min-height":"150px",width:"400px",onLoad:function(){var U=b(this)},onSubmit:function(U){b.post("?module=item&action=delete",{id:S},function(V){if(V.status==="ok"){l.find('[data-id="'+V.data.id+'"]').remove();U.trigger("close");O();C()}else{}},"json");return false}})}).on("change","#pl-assigned-contact select",function(){var T=b(this).val();b("#pl-assigned-contact").find('[data-pl-contact-id="'+T+'"]').show().siblings().hide()}).on("change paste keyup",":input",function(){P.find("#pl-item-details-save").addClass("yellow")}).on("show.pl2",function(T,U){N(U)}).on("hide.pl2",O);b(window).scroll(function(){a()})};Q();return{$el:P,trigger:function(T,U){this.$el&&this.$el.trigger(T,U)},isVisible:function(){return this.$el?this.$el.is(":visible"):false}}}(b("#pl-item-details")));var I=function(){G=b.extend({},x,t);if(b.pocketlists_routing.getHash()=="#/todo/"&&b.pocketlists_routing.getHash().indexOf("/team/")>0){B.prependTo(f).slideDown(200).wrap('<li class="pl-new-item-wrapper">');i.focus()}d();H();M.length&&new y();l.on("change",".pl-done",function(){var O=b(this),N=O.closest(s),o=O.is(":checked")?1:0;u(N,o)}).on("change",".pl-is-selected",function(O){var N=b(this),o=N.closest(s),P=(v&&v.data("id")==o.data("id"))?true:false;O.preventDefault();if(!o.find("#pl-item-add").length){if(!k.isVisible()&&!P){k.trigger("hide.pl2");q(o)}else{if(!k.isVisible()){k.trigger("show.pl2",[parseInt(o.data("id"))]);q(o)}else{k.trigger("hide.pl2");n()}}}}).on("click",".pl-edit",function(O){O.preventDefault();var N=b(this),o=N.closest(s);k.trigger("show.pl2",[parseInt(o.data("id"))]);q(o)}).on("click",".pl-favorite",function(O){O.preventDefault();var N=b(this),o=N.closest(s);K(o)}).on("increaseSelectedItem.pl2",function(o){c(o)}).on("decreaseSelectedItem.pl2",function(o){r(o)}).on("deselectItem.pl2",n).on("removeItem.pl2",function(o,N){j(N)}).on("replaceSelectedItem.pl2",function(N,o){e(o)});b(document).on("keydown",function(o){switch(o.which){case 9:if(!(G.list&&G.list.list_details.isVisible())&&!k.isVisible()){if(o.shiftKey){r(o)}else{c(o)}}break;case 27:k.isVisible()&&k.trigger("hide.pl2");break}});p.click(function(){g.slideDown(200);b(this).slideUp(200);return false})};I();return{$el:l,trigger:function(o,N){this.$el&&this.$el.trigger(o,N)}}};function a(){var f=b("#pl-list-content").offset().top;var e=b(window).scrollTop();var c=b(window).height();if(b(".pl-details .fields form").height()>c){return}if(e>f){b(".pl-details").addClass("sticky");var d=b(document).height()-c-e;b(".pl-details").css("bottom",Math.max(0,16-d)+"px")}else{b(".pl-details").removeClass("sticky")}}}(jQuery));