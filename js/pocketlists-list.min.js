(function(){var y=parseInt($("#pl-list-id").val()),x=parseInt($("#pl-pocket-id").val()),m=$("#pl-list-items"),s=$("#pl-undone-items > ul.menu-v"),b=$("#pl-complete-log > ul.menu-v"),u=$('<i class="icon16 loading">'),q=$("#pl-new-list-input"),C=$("#pl-item-add").detach(),f=C.find("textarea"),z=$('<div id="pl-item-add-wrapper-hover" style="display: none;">'),n="[data-parent-id]",k=$("#pl-item-add-link");var l=function(){$("#pl-undone-items ul.menu-v").sortable({item:n,connectWith:"ul.menu-v",placeholder:"pl-item-placeholder",tolerance:"pointer",stop:function(E,G){var D=G.item.parents(n).first(),F=D.length?parseInt(D.data("id")):0;G.item.data("parent-id",F);d.call(G.item,parseInt(G.item.data("id")))}})};var c=function(E){var D={name:$(this).val().trim(),type:"checklist",pocket_id:x};if(D.name){$(this).after(u);$.post("?module=list&action=update",{data:D,id:E},function(F){if(F.status==="ok"){if(y===-1){$.wa.setHash("#/pocket/"+x+"/list/"+F.data.id+"/")}}else{}},"json")}};var i=function(D,F){var E=$(this);E.after(u);$.post("?module=item&action=create",{list_id:y,data:D},function(H){var I=E.closest(n);var G=$(""+H+"");f.data("can_blur",false);G.filter(n).last().find(".pl-item").first().after(C);if(I.length){if(!I.parents(n).length||I.prev(n).length){I.after(G)}else{I.before(G)}}else{s.prepend(G)}u.remove();$(".pl-list-empty").removeClass("pl-list-empty");f.val("").trigger("focus").css("height","auto").data("can_blur",true);$.isFunction(F)&&F.call(E);g();d.call(G)})};var p=function(D,E){$.post("?module=item&action=move",{list_id:y,data:D},function(F){if(F.status==="ok"){$.isFunction(E)&&E.call()}else{alert(F.errors)}},"json")};var e=function(){var D=[];s.find(n).each(function(E){var F=$(this);D.push({id:F.data("id"),parent_id:F.data("parent-id"),sort:E,has_children:F.find(n).length?1:0})});return D};var d=function(D){this.find("label").first().append(u);$.post("?module=item&action=sort",{list_id:y,item_id:D?D:0,data:e()},function(E){if(E.status==="ok"){l()}else{alert(E.errors)}u.remove()},"json")};var a=function(G,D,F){var E=this;E.find(".pl-select-label").first().append(u);E.prop("disabled",true);$.post("?module=item&action=complete",{list_id:y,id:G,status:D},function(H){if(H.status==="ok"){$.pocketlist.updateAppCounter();E.find("ul.menu-v").find(":checkbox").prop("checked",D);E.find(".pl-done").prop("disabled",false);E.find(".pl-item-name").toggleClass("gray");setTimeout(function(){E.slideToggle(200,function(){E.show();if(D){b.append(E)}else{s.append(E);d.call(E)}g();$("#pl-complete-log-link").find("i").text($_("Show all "+b.find("[data-id]").length+" completed to-dos"));F&&$.isFunction(F)&&F.call(E)})},500)}else{alert(H.errors)}u.remove()},"json")};var t=function(){var D=s.find(".pl-item-selected").closest(n);if(D.length){D.each(function(){var G=$(this),F=G.prev(n);if(F.length){var H=parseInt(F.data("id"));G.data("parent-id",H);var E=F.find("ul.menu-v").first();if(E.length){E.append(G)}else{F.append($('<ul class="menu-v">').html(G))}d.call(G,parseInt(G.data("id")))}})}};var h=function(){var D=s.find(".pl-item-selected").closest(n);if(D.length){D.each(function(){var F=$(this),E=F.parents(n).first();if(E.length){var H=parseInt(E.data("parent-id"));F.data("parent-id",H);var G=F.nextAll(),I=F.find("ul.menu-v");if(!I.length){I=$('<ul class="menu-v">');F.append(I)}I.append(G);E.after(F);d.call(F,parseInt(F.data("id")))}})}};var o=function(E,F){var D=this.find('[class*="star"]');$.post("?module="+E+"&action=favorite",{id:F,status:D.hasClass("star-empty")?1:0},function(G){if(G.status==="ok"){D.toggleClass("star-empty star")}else{alert(G.errors)}},"json")};var g=function(){$("#pl-lists").find('[data-pl-list-id="'+y+'"]').find(".count").text(s.find("[data-id]").length)};var w=function(){if($.pocketlists_routing.getHash()=="#/todo/"&&$.pocketlists_routing.getHash().indexOf("/team/")>0){C.prependTo(s).slideDown(200).wrap('<li class="pl-new-item-wrapper">');f.focus()}};function A(){var G=$("#pl-list-content").offset().top;var F=$(window).scrollTop();var D=$(window).height();if($(".pl-details .fields form").height()>D){return}if(F>G){$(".pl-details").addClass("sticky");var E=$(document).height()-D-F;$(".pl-details").css("bottom",Math.max(0,16-E)+"px")}else{$(".pl-details").removeClass("sticky")}}w();if(q.length){q.focus();q.on("keydown",function(D){if(D.which===13){D.preventDefault();c.call(this,y)}})}k.on("click",function(E){E.preventDefault();E.stopPropagation();function D(){C.prependTo(s).slideDown(200,function(){f.focus()}).wrap('<li class="pl-new-item-wrapper">')}if(C.is(":visible")){C.slideUp(200,function(){C.detach();$(".pl-new-item-wrapper").remove();D()})}else{D()}});if($(".pl-list-empty").length){k.trigger("click")}function r(){f.css("height","auto");f.css("height",(f.get(0).scrollHeight-parseInt(f.css("padding-top"))-parseInt(f.css("padding-bottom")))+"px")}function B(){C.slideUp(200,function(){C.detach();$(".pl-new-item-wrapper").remove();f.val("")})}f.on("change cut keydown drop paste",function(){window.setTimeout(r,0)}).on("keydown",function(G){var F=$(this);if(!G.shiftKey&&G.which===13){G.preventDefault();var E=F.closest(".menu-v").find(n).first().data("parent-id"),D=F.val().trim();i.call(this,[{name:F.val().trim(),parent_id:E}])}else{if(G.which===27){B()}}}).on("paste",function(F){var E=$(this).closest(".menu-v").find(n).first().data("parent-id");var D=this;setTimeout(function(){var G=f.val().split(/\n/);var J=[];if(G.length>1){for(var I=0;I<G.length;I++){var H=$.trim(G[I]);if(H){J.push({name:H,parent_id:E})}}i.call(D,J)}},100)}).on("blur",function(){var G=$(this),F=G.closest(".menu-v").find(n).first().data("parent-id"),E=G.val().trim(),D=G.data("can_blur");if(D){if(E){i.call(this,[{name:E,parent_id:F}],B)}else{B()}}});s.on("mouseenter",n+" > .pl-item",function(E){E.stopPropagation();var D=$(this);if(!D.find(C).length){D.find(".pl-select-label").append(z.show())}}).on("mouseleave",function(D){z.detach()});z.on("click",function(F){var D=$(this);var E=D.closest(n).find(".menu-v");if(E.length){E.find(".pl-item").first().before(C)}else{D.closest(n).find(".pl-item").first().after(C)}z.detach();C.slideDown(200);f.focus()});m.on("change",".pl-is-selected",function(H){var G=$(this),D=$("#pl-item-details"),E=D.is(":visible"),F=G.closest(".pl-item"),J=F.closest(n),I=F.hasClass("pl-item-selected");H.preventDefault();if(!J.find("#pl-item-add").length){if(!E&&!I){D.hide();m.find(".pl-item").removeClass("pl-item-selected");F.addClass("pl-item-selected");G.prop("checked",true)}else{if(!E){D.html(u).show();A();$.post("?module=item&action=details",{id:parseInt(J.data("id"))},function(K){D.html(K);v(D)});G.prop("checked",true)}else{D.hide().empty();m.find(".pl-item").removeClass("pl-item-selected");G.prop("checked",false)}}}});m.on("change",".pl-done",function(G){var F=$(this),E=F.closest(n),H=parseInt(E.data("id")),D=F.is(":checked")?1:0;a.call(E,H,D)});m.on("click",".pl-favorite",function(F){F.preventDefault();var E=$(this),D=E.closest(n),G=parseInt(D.data("id"));o.call(D,"item",G)});$(document).on("keydown",function(E){switch(E.which){case 9:if(E.shiftKey){h.call(this)}else{t.call(this)}break;case 27:if($("#pl-list-details").is(":visible")){$("#pl-list-details").hide().empty();$(".pl-list-title").removeData("pl-clicked")}if($("#pl-item-details").is(":visible")){$("#pl-item-details").hide().empty();var D=m.find(".pl-item-selected");D.removeClass("pl-item-selected").prop("checked",false)}break}});l();var v=function(E){var G=0;var F=function(){var H={changeMonth:true,changeYear:true,shortYearCutoff:2,dateShowWeek:false,showOtherMonths:true,selectOtherMonths:true,stepMonths:1,numberOfMonths:1,gotoCurrent:true,constrainInput:false,minDate:new Date()};E.find("#pl-item-due-datetime").datepicker(H);G=parseInt(E.find('input[name="item[id]"]').val());D()};var D=function(){E.find("form").on("submit",function(I){I.preventDefault();var H=$(this);H.find("#pl-item-details-save").after(u);$.post("?module=item&action=data",H.serialize(),function(J){$.pocketlist.updateAppCounter();u.remove();m.find('[data-id="'+G+'"] > .pl-item').replaceWith($(J).addClass("pl-item-selected"));E.hide().empty()});return false});E.find("#pl-item-details-cancel").on("click",function(H){H.preventDefault();E.hide().empty();$(".pl-list-title").removeData("pl-clicked")});E.find("#pl-item-priority a").on("click",function(H){H.preventDefault();$("#pl-item-priority").find("input").val($(this).data("pl-item-priority"));$(this).addClass("selected").siblings().removeClass("selected")});E.find('[data-pl-action="item-delete"]').on("click",function(H){H.preventDefault();$("#pl-dialog-delete-confirm").waDialog({height:"150px","min-height":"150px",width:"400px",onLoad:function(){var I=$(this)},onSubmit:function(I){$.post("?module=item&action=delete",{id:G,list_id:y},function(J){if(J.status==="ok"){m.find('[data-id="'+J.data.id+'"]').remove();E.find("#pl-item-details-cancel").trigger("click");I.trigger("close")}else{}},"json");return false}})});E.on("change","#pl-assigned-contact select",function(){var H=$(this).val();$("#pl-assigned-contact").find('[data-pl-contact-id="'+H+'"]').show().siblings().hide()})};F()};$(".pl-list-title").on("click",function(G){var D=$("#pl-list-details"),F=$(this),E=F.data("pl-clicked");if($(G.target).closest(".pl-done-label").length){return}if(E==1){D.html(u).show();A();F.data("pl-clicked",2);$.post("?module=list&action=details",{id:parseInt($("#pl-list-id").val())},function(H){D.html(H);j(D)})}else{if(E==2){F.removeData("pl-clicked");D.hide().empty()}else{F.data("pl-clicked",1)}}}).on("click",'[data-pl-action="list-delete"]',function(D){D.preventDefault();$("#pl-dialog-delete-confirm").waDialog({height:"150px","min-height":"150px",width:"400px",onLoad:function(){var E=$(this)},onSubmit:function(E){$.post("?module=list&action=delete",{list_id:y},function(F){if(F.status==="ok"){E.trigger("close");$.wa.setHash("#/pocket/1/")}else{}},"json");return false}})}).on("click",'[data-pl-action="list-archive"]',function(D){D.preventDefault();$.post("?module=list&action=archive",{list_id:y,archive:1},function(E){if(E.status==="ok"){$.wa.setHash("#/pocket/1/")}else{}},"json")}).on("click",'[data-pl-action="list-sort"]',function(D){D.preventDefault();$.post("?module=list&action=sort",{list_id:y},function(E){if(E.status==="ok"){$.pocketlists_routing.redispatch()}else{}},"json")}).on("click",'[data-pl-action="list-favorite"]',function(F){F.preventDefault();var E=$(this),D=E.closest(".pl-list-title");o.call(D,"list",D.find("#pl-list-id").val())});var j=function(G){var I=0;var F=G.find("#pl-list-icon-dialog").find("ul").data("pl-icons-path");var H=function(){E();I=parseInt(G.find('input[name="list[id]"]').val())};var E=function(){G.find("form").on("submit",function(K){K.preventDefault();var J=$(this);J.find("#pl-list-details-save").after(u);$.post("?module=list&action=save",J.serialize(),function(L){u.remove();if(L.status==="ok"){D();G.find(".success").show().delay(3000).hide()}else{G.find(".error").show().delay(3000).hide()}G.data("pl-clicked",1).hide()},"json");return false});G.find("#pl-list-details-cancel").on("click",function(J){J.preventDefault();G.hide().empty()});G.find("#pl-list-color a").on("click",function(J){J.preventDefault();$("#pl-list-color").find("input").val($(this).data("pl-list-color"));$(this).addClass("selected").siblings().removeClass("selected")});G.find("#pl-list-icon-change a").on("click",function(K){K.preventDefault();var J=$(this);$("#pl-list-icon-dialog").waDialog({onLoad:function(){var L=$(this);$("#pl-list-icon-dialog").on("click","a[data-pl-list-icon]",function(N){N.preventDefault();var M=$(this).data("pl-list-icon");G.find("#pl-list-icon-change").find("input").val($(this).data("pl-list-icon"));J.find("input").val(M);G.find("#pl-list-icon-change .listicon48").css("background-image","url("+F+M+")");L.trigger("close");return false})}})})};var D=function(){var K=G.find('input[name="list[name]"]').val(),J=G.find("[data-pl-list-color].selected").data("pl-list-color"),L=G.find('input[name="list[icon]"]').val();$("#pl-list-name").text(K);$("#pl-lists").find('[data-pl-list-id="'+I+'"]').removeClass().addClass("pl-"+J).find(".pl-list-name").text(K).end().find(".listicon48").css("background-image","url("+F+L+")");$(".pl-items").removeClass().addClass("pl-items pl-"+J)};H()};$("#pl-list-complete").on("click",function(D){D.stopPropagation();$("#pl-dialog-list-archive-complete-all").waDialog({height:"150px","min-height":"150px",width:"400px",onLoad:function(){var E=$(this);E.on("click","[data-pl-action]",function(H){H.preventDefault();var G=$(this),F=G.data("pl-action");G.after(u);if(F==="list-complete-all"){$.post("?module=item&action=complete",{list_id:y,status:1,id:-1},function(I){if(I.status==="ok"){E.trigger("close");$.pocketlists_routing.redispatch()}else{}},"json")}else{if(F==="list-archive"){$.post("?module=list&action=archive",{list_id:y,archive:1},function(I){if(I.status==="ok"){E.trigger("close");$.wa.setHash("#/pocket/"+x)}else{}},"json")}else{if(F==="cancel"){$("#pl-list-complete").prop("checked",false);E.trigger("close");u.remove()}}}})}})});$("#pl-complete-log-link").click(function(){$("#pl-complete-log").slideDown(200);$(this).slideUp(200);return false});$(window).scroll(function(){A()})}());