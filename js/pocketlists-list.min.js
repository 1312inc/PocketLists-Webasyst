(function(){var x=parseInt($("#pl-list-id").val()),w=parseInt($("#pl-pocket-id").val()),m=$("#pl-list-items"),r=$("#pl-undone-items > ul.menu-v"),b=$("#pl-complete-log > ul.menu-v"),t=$('<i class="icon16 loading">'),q=$("#pl-new-list-input"),z=$("#pl-item-add").detach(),f=z.find("textarea"),y=$('<div id="pl-item-add-wrapper-hover" style="display: none;">'),n="[data-parent-id]",k=$("#pl-item-add-link");var l=function(){$("#pl-undone-items ul.menu-v").sortable({item:n,connectWith:"ul.menu-v",placeholder:"pl-item-placeholder",tolerance:"pointer",stop:function(B,D){var A=D.item.parents(n).first(),C=A.length?parseInt(A.data("id")):0;D.item.data("parent-id",C);d.call(D.item,parseInt(D.item.data("id")))}})};var c=function(B){var A={name:$(this).val().trim(),type:"checklist",pocket_id:w};if(A.name){$(this).after(t);$.post("?module=list&action=update",{data:A,id:B},function(C){if(C.status==="ok"){if(x===-1){$.wa.setHash("#/pocket/"+w+"/list/"+C.data.id+"/")}}else{}},"json")}};var i=function(A){var B=$(this);B.after(t);$.post("?module=item&action=create",{list_id:x,data:A},function(D){var E=B.closest(n);var C=$(""+D+"");C.filter(n).last().find(".pl-item").first().after(z);if(E.length){E.after(C)}else{r.prepend(C)}t.remove();f.val("").trigger("focus");$(".pl-list-empty").removeClass("pl-list-empty");g();d.call(C)})};var p=function(A,B){$.post("?module=item&action=move",{list_id:x,data:A},function(C){if(C.status==="ok"){$.isFunction(B)&&B.call()}else{alert(C.errors)}},"json")};var e=function(){var A=[];r.find(n).each(function(B){var C=$(this);A.push({id:C.data("id"),parent_id:C.data("parent-id"),sort:B,has_children:C.find(n).length?1:0})});return A};var d=function(A){this.find("label").first().append(t);$.post("?module=item&action=sort",{list_id:x,item_id:A?A:0,data:e()},function(B){if(B.status==="ok"){l()}else{alert(B.errors)}t.remove()},"json")};var a=function(D,A,C){var B=this;B.find(".pl-select-label").first().append(t);B.prop("disabled",true);$.post("?module=item&action=complete",{list_id:x,id:D,status:A},function(E){if(E.status==="ok"){$.pocketlist.updateAppCounter();B.find("ul.menu-v").find(":checkbox").prop("checked",A);B.find(".pl-done").prop("disabled",false);B.find(".pl-item-name").toggleClass("gray");setTimeout(function(){B.slideToggle(200,function(){B.show();if(A){b.append(B)}else{r.append(B);d.call(B)}g();$("#pl-complete-log-link").find("i").text($_("Show all "+b.find("[data-id]").length+" completed to-dos"));C&&$.isFunction(C)&&C.call(B)})},500)}else{alert(E.errors)}t.remove()},"json")};var s=function(){var A=r.find(".pl-item-selected").closest(n);if(A.length){A.each(function(){var D=$(this),C=D.prev(n);if(C.length){var E=parseInt(C.data("id"));D.data("parent-id",E);var B=C.find("ul.menu-v").first();if(B.length){B.append(D)}else{C.append($('<ul class="menu-v">').html(D))}d.call(D,parseInt(D.data("id")))}})}};var h=function(){var A=r.find(".pl-item-selected").closest(n);if(A.length){A.each(function(){var C=$(this),B=C.parents(n).first();if(B.length){var E=parseInt(B.data("parent-id"));C.data("parent-id",E);var D=C.nextAll(),F=C.find("ul.menu-v");if(!F.length){F=$('<ul class="menu-v">');C.append(F)}F.append(D);B.after(C);d.call(C,parseInt(C.data("id")))}})}};var o=function(B,C){var A=this.find('[class*="star"]');$.post("?module="+B+"&action=favorite",{id:C,status:A.hasClass("star-empty")?1:0},function(D){if(D.status==="ok"){A.toggleClass("star-empty star")}else{alert(D.errors)}},"json")};var g=function(){$("#pl-lists").find('[data-pl-list-id="'+x+'"]').find(".count").text(r.find("[data-id]").length)};var v=function(){if($.pocketlists_routing.getHash()=="#/todo/"&&$.pocketlists_routing.getHash().indexOf("/team/")>0){z.prependTo(r).slideDown(200).wrap('<li class="pl-new-item-wrapper">');f.focus()}};v();if(q.length){q.focus();q.on("keydown",function(A){if(A.which===13){A.preventDefault();c.call(this,x)}})}k.on("click",function(A){A.preventDefault();A.stopPropagation();if(z.is(":visible")){z.slideUp(200,function(){z.detach();$(".pl-new-item-wrapper").remove()})}else{z.prependTo(r).slideDown(200).wrap('<li class="pl-new-item-wrapper">')}f.focus()});if($(".pl-list-empty").length){k.trigger("click")}f.on("keydown",function(C){var B=$(this);if(!C.shiftKey&&C.which===13){C.preventDefault();var A=B.closest(".menu-v").find(n).first().data("parent-id");i.call(this,[{name:B.val().trim(),parent_id:A}])}else{if(C.which===27){z.slideUp(200,function(){z.detach();$(".pl-new-item-wrapper").remove()});f.val("")}}}).on("paste",function(C){var B=$(this).closest(".menu-v").find(n).first().data("parent-id");var A=this;setTimeout(function(){var D=f.val().split(/\n/);var G=[];if(D.length>1){for(var F=0;F<D.length;F++){var E=$.trim(D[F]);if(E){G.push({name:E,parent_id:B})}}i.call(A,G)}},100)});r.on("mouseenter",n+" > .pl-item",function(C){C.stopPropagation();var A=$(this);if(!A.find(z).length){var B=A.closest(n).find(".menu-v");if(B.length){B.find(".pl-item").first().before(y.show())}else{A.after(y.show())}}}).on("mouseleave",function(A){y.detach()});y.on("click",function(A){y.after(z);y.detach();z.slideDown(200);f.focus()});m.on("change",".pl-is-selected",function(E){var D=$(this),A=$("#pl-item-details"),B=A.is(":visible"),C=D.closest(".pl-item"),G=C.closest(n),F=C.hasClass("pl-item-selected");E.preventDefault();if(!G.find("#pl-item-add").length){if(!B&&!F){A.hide();m.find(".pl-item").removeClass("pl-item-selected");C.addClass("pl-item-selected");D.prop("checked",true)}else{if(!B){A.html(t).show();$.post("?module=item&action=details",{id:parseInt(G.data("id"))},function(H){A.html(H);u(A)});D.prop("checked",true)}else{A.hide().empty();m.find(".pl-item").removeClass("pl-item-selected");D.prop("checked",false)}}}});m.on("change",".pl-done",function(D){var C=$(this),B=C.closest(n),E=parseInt(B.data("id")),A=C.is(":checked")?1:0;a.call(B,E,A)});m.on("click",".pl-favorite",function(C){C.preventDefault();var B=$(this),A=B.closest(n),D=parseInt(A.data("id"));o.call(A,"item",D)});$(document).on("keydown",function(B){switch(B.which){case 9:if(B.shiftKey){h.call(this)}else{s.call(this)}break;case 27:if($("#pl-list-details").is(":visible")){$("#pl-list-details").hide().empty();$(".pl-list-title").removeData("pl-clicked")}if($("#pl-item-details").is(":visible")){$("#pl-item-details").hide().empty();var A=m.find(".pl-item-selected");A.removeClass("pl-item-selected").prop("checked",false)}break}});l();var u=function(B){var D=0;var C=function(){var E={changeMonth:true,changeYear:true,shortYearCutoff:2,dateShowWeek:false,showOtherMonths:true,selectOtherMonths:true,stepMonths:1,numberOfMonths:1,gotoCurrent:true,constrainInput:false,minDate:new Date()};B.find("#pl-item-due-datetime").datepicker(E);D=parseInt(B.find('input[name="item[id]"]').val());A()};var A=function(){B.find("form").on("submit",function(F){F.preventDefault();var E=$(this);E.find("#pl-item-details-save").after(t);$.post("?module=item&action=data",E.serialize(),function(G){$.pocketlist.updateAppCounter();t.remove();m.find('[data-id="'+D+'"] > .pl-item').replaceWith($(G).addClass("pl-item-selected"));B.hide().empty()});return false});B.find("#pl-item-details-cancel").on("click",function(E){E.preventDefault();B.hide().empty();$(".pl-list-title").removeData("pl-clicked")});B.find("#pl-item-priority a").on("click",function(E){E.preventDefault();$("#pl-item-priority").find("input").val($(this).data("pl-item-priority"));$(this).addClass("selected").siblings().removeClass("selected")});B.find('[data-pl-action="item-delete"]').on("click",function(E){E.preventDefault();$("#pl-dialog-delete-confirm").waDialog({height:"150px","min-height":"150px",width:"400px",onLoad:function(){var F=$(this)},onSubmit:function(F){$.post("?module=item&action=delete",{id:D,list_id:x},function(G){if(G.status==="ok"){m.find('[data-id="'+G.data.id+'"]').remove();B.find("#pl-item-details-cancel").trigger("click");F.trigger("close")}else{}},"json");return false}})});B.on("change","#pl-assigned-contact select",function(){var E=$(this).val();$("#pl-assigned-contact").find('[data-pl-contact-id="'+E+'"]').show().siblings().hide()})};C()};$(".pl-list-title").on("click",function(D){var A=$("#pl-list-details"),C=$(this),B=C.data("pl-clicked");if($(D.target).closest(".pl-done-label").length){return}if(B==1){A.html(t).show();C.data("pl-clicked",2);$.post("?module=list&action=details",{id:parseInt($("#pl-list-id").val())},function(E){A.html(E);j(A)})}else{if(B==2){C.removeData("pl-clicked");A.hide().empty()}else{C.data("pl-clicked",1)}}}).on("click",'[data-pl-action="list-delete"]',function(A){A.preventDefault();$("#pl-dialog-delete-confirm").waDialog({height:"150px","min-height":"150px",width:"400px",onLoad:function(){var B=$(this)},onSubmit:function(B){$.post("?module=list&action=delete",{list_id:x},function(C){if(C.status==="ok"){B.trigger("close");$.wa.setHash("#/pocket/1/")}else{}},"json");return false}})}).on("click",'[data-pl-action="list-archive"]',function(A){A.preventDefault();$.post("?module=list&action=archive",{list_id:x,archive:1},function(B){if(B.status==="ok"){$.wa.setHash("#/pocket/1/")}else{}},"json")}).on("click",'[data-pl-action="list-sort"]',function(A){A.preventDefault();$.post("?module=list&action=sort",{list_id:x},function(B){if(B.status==="ok"){$.pocketlists_routing.redispatch()}else{}},"json")}).on("click",'[data-pl-action="list-favorite"]',function(C){C.preventDefault();var B=$(this),A=B.closest(".pl-list-title");o.call(A,"list",A.find("#pl-list-id").val())});var j=function(D){var F=0;var C=D.find("#pl-list-icon-dialog").find("ul").data("pl-icons-path");var E=function(){B();F=parseInt(D.find('input[name="list[id]"]').val())};var B=function(){D.find("form").on("submit",function(H){H.preventDefault();var G=$(this);G.find("#pl-list-details-save").after(t);$.post("?module=list&action=save",G.serialize(),function(I){t.remove();if(I.status==="ok"){A();D.find(".success").show().delay(3000).hide()}else{D.find(".error").show().delay(3000).hide()}D.data("pl-clicked",1).hide()},"json");return false});D.find("#pl-list-details-cancel").on("click",function(G){G.preventDefault();D.hide().empty()});D.find("#pl-list-color a").on("click",function(G){G.preventDefault();$("#pl-list-color").find("input").val($(this).data("pl-list-color"));$(this).addClass("selected").siblings().removeClass("selected")});D.find("#pl-list-icon-change a").on("click",function(H){H.preventDefault();var G=$(this);$("#pl-list-icon-dialog").waDialog({onLoad:function(){var I=$(this);$("#pl-list-icon-dialog").on("click","a[data-pl-list-icon]",function(K){K.preventDefault();var J=$(this).data("pl-list-icon");D.find("#pl-list-icon-change").find("input").val($(this).data("pl-list-icon"));G.find("input").val(J);D.find("#pl-list-icon-change .listicon48").css("background-image","url("+C+J+")");I.trigger("close");return false})}})})};var A=function(){var H=D.find('input[name="list[name]"]').val(),G=D.find("[data-pl-list-color].selected").data("pl-list-color"),I=D.find('input[name="list[icon]"]').val();$("#pl-list-name").text(H);$("#pl-lists").find('[data-pl-list-id="'+F+'"]').removeClass().addClass("pl-"+G).find(".pl-list-name").text(H).end().find(".listicon48").css("background-image","url("+C+I+")");$(".pl-items").removeClass().addClass("pl-items pl-"+G)};E()};$("#pl-list-complete").on("click",function(A){A.stopPropagation();$("#pl-dialog-list-archive-complete-all").waDialog({height:"150px","min-height":"150px",width:"400px",onLoad:function(){var B=$(this);B.on("click","[data-pl-action]",function(E){E.preventDefault();var D=$(this),C=D.data("pl-action");D.after(t);if(C==="list-complete-all"){$.post("?module=item&action=complete",{list_id:x,status:1,id:-1},function(F){if(F.status==="ok"){B.trigger("close");$.pocketlists_routing.redispatch()}else{}},"json")}else{if(C==="list-archive"){$.post("?module=list&action=archive",{list_id:x,archive:1},function(F){if(F.status==="ok"){B.trigger("close");$.wa.setHash("#/pocket/"+w)}else{}},"json")}else{if(C==="cancel"){$("#pl-list-complete").prop("checked",false);B.trigger("close");t.remove()}}}})}})});$("#pl-complete-log-link").click(function(){$("#pl-complete-log").slideDown(200);$(this).slideUp(200);return false})}());