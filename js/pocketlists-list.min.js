(function(){$.pocketlists.List=function(h){var e=h.find("#pl-new-list-input"),f=parseInt(h.find("#pl-list-id").val()),m=parseInt($("#pl-pocket-id").val()),b=$("#pl-dialog-delete-confirm"),c=$("#pl-dialog-list-archive-complete-all");var l=(function(t){var s=null;var p=function(){$.pocketlists.scrollToTop(200,80);t.html($.pocketlists.$loading).show();a();$.post("?module=list&action=details",{id:f},function(w){t.html(w);v()})};var r=function(){t.hide().empty()};var q=function(w){h.find("#pl-list-name").text(w.name);if(w.due_date||w.due_datetime){var x="pl-due-someday";if(w.calc_priority==1){x="pl-due-tomorrow"}else{if(w.calc_priority==2){x="pl-due-today"}else{if(w.calc_priority==3){x="pl-due-overdue"}}}h.find(".pl-list-due").removeClass().addClass("pl-list-due "+x).text(w.due_datetime?w.due_datetime:w.due_date).show()}else{h.find(".pl-list-due").hide()}$("#pl-lists").find('[data-pl-list-id="'+f+'"]').removeClass().addClass("pl-"+w.color).find(".pl-list-name").text(w.name).end().find(".listicon48").css("background-image","url("+s+w.icon+")");$(".pl-items").removeClass().addClass("pl-items pl-"+w.color)};var v=function(){var w={changeMonth:true,changeYear:true,shortYearCutoff:2,dateShowWeek:false,showOtherMonths:true,selectOtherMonths:true,stepMonths:1,numberOfMonths:1,gotoCurrent:true,constrainInput:false};t.find("#pl-list-due-datetime").datepicker(w);s=t.find("#pl-list-icon-dialog").find("ul").data("pl-icons-path")};var u=function(){if(t.data("pl-ListDetails")){return}t.data("pl-ListDetails",true);t.on("submit","form",function(x){x.preventDefault();var w=$(this);w.find("#pl-list-details-save").after($.pocketlists.$loading);$.post("?module=list&action=save",w.serialize(),function(y){$.pocketlists.$loading.remove();if(y.status==="ok"){q(y.data);r()}else{t.find(".error").show().delay(3000).hide()}},"json");return false}).on("click","#pl-list-details-cancel",function(w){w.preventDefault();r()}).on("click","#pl-list-color a",function(w){w.preventDefault();$("#pl-list-color").find("input").val($(this).data("pl-list-color"));$(this).addClass("selected").siblings().removeClass("selected")}).on("click","#pl-list-due-datetime-set",function(x){x.preventDefault();var w=$(this);w.hide().siblings().show().filter("select").prop("disabled",false)}).on("click","#pl-list-due-datetime-clear",function(x){x.preventDefault();var w=$(this);w.hide().siblings().show().filter("select").hide().prop("disabled",true)}).on("click","#pl-list-icon-change a",function(w){w.preventDefault();$("#pl-list-icon-dialog").waDialog({onLoad:function(){var x=$(this);$("#pl-list-icon-dialog").on("click","a[data-pl-list-icon]",function(A){A.preventDefault();var y=$(this).data("pl-list-icon"),z=$(this);t.find("#pl-list-icon-change").find("input").val($(this).data("pl-list-icon"));z.find("input").val(y);t.find("#pl-list-icon-change .listicon48").css("background-image","url("+s+y+")");x.trigger("close");return false})}})}).on("show.pl2",p).on("hide.pl2",r);$(window).scroll(function(){a()})};u();return{$el:t,trigger:function(w,x){this.$el&&this.$el.trigger(w,x)},isVisible:function(){return this.$el?this.$el.is(":visible"):false}}}($("#pl-list-details")));var o=function(q){var p={name:e.val().trim(),type:"checklist",pocket_id:m};if(p.name){$.post("?module=list&action=update",{data:p,id:q},function(s){if(s.status==="ok"){if(f===-1){$.wa.setHash("#/pocket/"+m+"/list/"+s.data.id+"/")}}else{}},"json")}};var j=function(){var p=h.find('[class*="star"]');$.post("?module=list&action=favorite",{id:f,status:p.hasClass("star-empty")?1:0},function(q){if(q.status==="ok"){p.toggleClass("star-empty star")}else{alert(q.errors)}},"json")};var k=function(){b.waDialog({height:"150px","min-height":"150px",width:"400px",onLoad:function(){},onSubmit:function(p){$.post("?module=list&action=delete",{list_id:f},function(q){if(q.status==="ok"){p.trigger("close");$.wa.setHash("#/pocket/1/")}else{}},"json");return false}})};var d=function(){$.post("?module=list&action=archive",{list_id:f,archive:1},function(p){if(p.status==="ok"){$.wa.setHash("#/pocket/1/")}else{}},"json")};var i=function(){$.post("?module=list&action=sort",{list_id:f},function(p){if(p.status==="ok"){$.pocketlists_routing.redispatch()}else{}},"json")};var g=function(){h.removeData("pl-clicked")};var n=function(){if(e.length){e.focus();e.on("keydown",function(p){if(p.which===13){p.preventDefault();o(f)}})}h.on("click",function(q){var p=h.data("pl-clicked");if($(q.target).closest(".pl-done-label").length){return}if(p==1){h.data("pl-clicked",2);$.pocketlists.scrollToTop(200,80);l.trigger("show.pl2")}else{if(p==2){l.trigger("hide.pl2");g()}else{h.data("pl-clicked",1)}}}).on("click",'[data-pl-action="list-delete"]',function(p){p.preventDefault();k()}).on("click",'[data-pl-action="list-archive"]',function(p){p.preventDefault();d()}).on("click",'[data-pl-action="list-sort"]',function(p){p.preventDefault();i()}).on("click",'[data-pl-action="list-favorite"]',function(p){p.preventDefault();j()}).on("click","#pl-list-complete",function(p){p.stopPropagation();c.waDialog({height:"150px","min-height":"150px",width:"400px",onLoad:function(){var q=$(this);q.on("click","[data-pl-action]",function(t){t.preventDefault();var s=$(this),r=s.data("pl-action");s.after($.pocketlists.$loading);if(r==="list-complete-all"){$.post("?module=list&action=complete",{list_id:f,status:1},function(u){if(u.status==="ok"){q.trigger("close");$.pocketlists_routing.redispatch()}else{}},"json")}else{if(r==="list-archive"){$.post("?module=list&action=archive",{list_id:f,archive:1},function(u){if(u.status==="ok"){q.trigger("close");$.wa.setHash("#/pocket/"+m)}else{}},"json")}else{if(r==="cancel"){$("#pl-list-complete").prop("checked",false);q.trigger("close");$.pocketlists.$loading.remove()}}}})}})}).on("deleteList.pl2",k).on("deselectList.pl2",g);$(document).on("keydown",function(p){switch(p.which){case 27:l.isVisible()&&l.trigger("hide.pl2");break}})};n();return{$el:h,list_details:l,list_id:f,pocket_id:m}};$.pocketlists.Items=function(m,g){var r=m.find("#pl-undone-items > ul.menu-v"),s=$("#pl-undone-items ul.menu-v"),G=m.find("#pl-complete-log"),d=G.find("ul.menu-v").first(),D=$("#pl-item-add").detach(),h=D.find("textarea"),B=$('<div id="pl-item-add-wrapper-hover" style="display: none;">'),n="[data-parent-id]",j=$("#pl-item-add-link"),A=$("#pl-complete-log-link"),C=null,k={enableAddLinkOnHover:true,enableChangeLevel:true,enableSortItems:true,list:null,assignUser:null},q={};var c=function(){if(q.enableSortItems){s.sortable({item:n,connectWith:"ul.menu-v",placeholder:"pl-item-placeholder",tolerance:"pointer",stop:function(H,J){var o=J.item.parents(n).first(),I=o.length?parseInt(o.data("id")):0;J.item.data("parent-id",I);e(parseInt(J.item.data("id")))}})}};var z=function(o,I){var H=$(this);$.post("?module=item&action=create",{list_id:q.list?q.list.list_id:0,data:o,assigned_contact_id:q.assignUser?q.assignUser:false},function(K){var L=H.closest(n);var J=$(""+K+"");h.data("can_blur",false);if(L.length){if(!L.parents(n).length||D.prev(".pl-item").length){L.after(J)}else{L.before(J)}}else{r.prepend(J)}J.filter(n).last().find(".pl-item").first().after(D);$(".pl-list-empty").removeClass("pl-list-empty");h.val("").trigger("focus").css("height","auto").data("can_blur",true);$.isFunction(I)&&I.call(H);f();e()})};var b=function(){var o=[];r.find(n).each(function(H){var I=$(this);o.push({id:I.data("id"),parent_id:I.data("parent-id"),sort:H,has_children:I.find(n).length?1:0})});return o};var e=function(o){if(q.enableSortItems&&q.list){$.post("?module=item&action=sort",{list_id:q.list.list_id,item_id:o?o:0,data:b()},function(H){if(H.status==="ok"){c()}else{alert(H.errors)}},"json")}};var E=function(H,o,J){var I=parseInt(H.data("id"));H.prop("disabled",true);$.post("?module=item&action=complete",{id:I,status:o},function(K){if(K.status==="ok"){$.pocketlists.updateAppCounter();H.find("ul.menu-v").find(":checkbox").prop("checked",o);H.find(".pl-done").prop("disabled",false);H.find(".pl-item-name").toggleClass("gray");setTimeout(function(){H.slideToggle(200,function(){H.show();if(o){d.append(H)}else{r.append(H);e()}f();$("#pl-complete-log-link").find("i").text($_("Show all "+d.find("[data-id]").length+" completed to-dos"));J&&$.isFunction(J)&&J.call(H)})},800)}else{alert(K.errors)}$.pocketlists.$loading.remove()},"json")};var w=function(o){if(q.enableChangeLevel&&C){o.preventDefault();o.stopPropagation();C.each(function(){var J=$(this),I=J.prev(n);if(I.length){var K=parseInt(I.data("id"));J.data("parent-id",K);var H=I.find("ul.menu-v").first();if(H.length){H.append(J)}else{I.append($('<ul class="menu-v">').html(J))}e(parseInt(J.data("id")))}})}};var v=function(o){if(q.enableChangeLevel&&C){o.preventDefault();o.stopPropagation();C.each(function(){var I=$(this),H=I.parents(n).first();if(H.length){var K=parseInt(H.data("parent-id"));I.data("parent-id",K);var J=I.nextAll(),L=I.find("ul.menu-v");if(!L.length){L=$('<ul class="menu-v">');I.append(L)}L.append(J);H.after(I);e(parseInt(I.data("id")))}})}};var x=function(o){var H=o.find('[class*="star"]'),I=parseInt(o.data("id"));$.post("?module="+type+"&action=favorite",{id:I,status:H.hasClass("star-empty")?1:0},function(J){if(J.status==="ok"){H.toggleClass("star-empty star")}else{alert(J.errors)}},"json")};var i=function(o){C=o;if(C){var H=C.find(".pl-item").first();m.find(".pl-item").removeClass("pl-item-selected");H.addClass("pl-item-selected");C.prop("checked",true)}};var l=function(){if(C){m.find(".pl-item").removeClass("pl-item-selected");C.prop("checked",false);C=null}};var F=function(o){m.find('[data-id="'+o+'"]').remove()};var u=function(o){if(C){C.find(".pl-item").first().replaceWith($(o).addClass("pl-item-selected"))}};var f=function(){if(q.list&&q.list.list_id){$("#pl-lists").find('[data-pl-list-id="'+q.list.list_id+'"]').find(".count").text(r.find("[data-id]").length)}};var p=function(){var H=function(){h.css("height","auto");h.css("height",(h.get(0).scrollHeight-parseInt(h.css("padding-top"))-parseInt(h.css("padding-bottom")))+"px")};var o=function(){D.slideUp(200,function(){D.detach();$(".pl-new-item-wrapper").remove();h.val("")})};var I=function(){j.on("click",function(L){L.preventDefault();L.stopPropagation();function K(){D.prependTo(r).slideDown(200,function(){h.focus()}).wrap('<li class="pl-new-item-wrapper">')}if(D.is(":visible")){D.slideUp(200,function(){D.detach();$(".pl-new-item-wrapper").remove();K()})}else{K()}});if($(".pl-list-empty").length){j.trigger("click")}h.on("change cut keydown drop paste",function(){window.setTimeout(H,0)}).on("keydown",function(N){var M=$(this);M.data("can_blur",true);if(!N.shiftKey&&N.which===13){N.preventDefault();var L=M.closest(".menu-v").find(n).first().data("parent-id"),K=M.val().trim();if(K){z.call(this,[{name:K,parent_id:L}])}}else{if(N.which===27){o()}}}).on("paste",function(){var L=$(this).closest(".menu-v").find(n).first().data("parent-id");var K=this;setTimeout(function(){var M=h.val().split(/\n/);var P=[];if(M.length>1){for(var O=0;O<M.length;O++){var N=$.trim(M[O]);if(N){P.push({name:N,parent_id:L})}}z.call(K,P)}},100)}).on("blur",function(){var N=$(this),M=N.closest(".menu-v").find(n).first().data("parent-id"),L=N.val().trim(),K=N.data("can_blur");if(K){if(L){z.call(this,[{name:L,parent_id:M}],o)}else{o()}}});var J=null;if(q.enableAddLinkOnHover){r.on("mouseenter",n+" > .pl-item",function(L){L.stopPropagation();var K=$(this);J=setTimeout(function(){if(!K.find(D).length){K.find(".pl-select-label").append(B.show())}},500)}).on("mouseleave",n+" > .pl-item",function(){clearTimeout(J);B.detach()});B.on("click",function(){var K=$(this);var L=K.closest(n).find(".menu-v");h.data("can_blur",false);if(L.length){L.find(".pl-item").first().before(D)}else{K.closest(n).find(".pl-item").first().after(D)}B.detach();D.slideDown(200);h.focus();h.data("can_blur",true)})}};I()};var t=(function(J){var M=0,o=$("#pl-dialog-delete-confirm");var I=function(){J.hide().empty();M=0;m.trigger("deselectItem.pl2")};var H=function(N){M=N;J.html($.pocketlists.$loading).show();a();$.post("?module=item&action=details",{id:M},function(O){J.html(O);L()})};var L=function(){var N={changeMonth:true,changeYear:true,shortYearCutoff:2,dateShowWeek:false,showOtherMonths:true,selectOtherMonths:true,stepMonths:1,numberOfMonths:1,gotoCurrent:true,constrainInput:false};J.find("#pl-item-due-datetime").datepicker(N)};var K=function(){if(J.data("pl-ListDetails")){return}J.data("pl-ListDetails",true);J.on("submit","form",function(O){O.preventDefault();var N=$(this);N.find("#pl-item-details-save").after($.pocketlists.$loading);$.post("?module=item&action=data",N.serialize(),function(P){$.pocketlists.updateAppCounter();$.pocketlists.$loading.remove();m.trigger("replaceSelectedItem.pl2",[P]);I()});return false}).on("click","#pl-item-details-cancel",function(N){N.preventDefault();I()}).on("click","#pl-item-priority a",function(N){N.preventDefault();$("#pl-item-priority").find("input").val($(this).data("pl-item-priority"));$(this).addClass("selected").siblings().removeClass("selected")}).on("click","#pl-item-due-datetime-set",function(O){O.preventDefault();var N=$(this);N.hide().siblings().show().filter("select").prop("disabled",false)}).on("click","#pl-item-due-datetime-clear",function(O){O.preventDefault();var N=$(this);N.hide().siblings().show().filter("select").hide().prop("disabled",true)}).on("click",'[data-pl-action="item-delete"]',function(N){N.preventDefault();o.waDialog({height:"150px","min-height":"150px",width:"400px",onLoad:function(){},onSubmit:function(O){$.post("?module=item&action=delete",{id:M,list_id:list.list_id},function(P){if(P.status==="ok"){m.trigger("deselectItem.pl2",[P.data.id]);I();O.trigger("close")}else{}},"json");return false}})}).on("change","#pl-assigned-contact select",function(){var N=$(this).val();$("#pl-assigned-contact").find('[data-pl-contact-id="'+N+'"]').show().siblings().hide()}).on("show.pl2",function(N,O){H(O)}).on("hide.pl2",I);$(window).scroll(function(){a()})};K();return{$el:J,trigger:function(N,O){this.$el&&this.$el.trigger(N,O)},isVisible:function(){return this.$el?this.$el.is(":visible"):false}}}($("#pl-item-details")));var y=function(){q=$.extend({},k,g);if($.pocketlists_routing.getHash()=="#/todo/"&&$.pocketlists_routing.getHash().indexOf("/team/")>0){D.prependTo(r).slideDown(200).wrap('<li class="pl-new-item-wrapper">');h.focus()}c();j.length&&new p();m.on("change",".pl-done",function(){var I=$(this),H=I.closest(n),o=I.is(":checked")?1:0;E(H,o)}).on("change",".pl-is-selected",function(I){var H=$(this),o=H.closest(n),J=(C&&C.data("id")==o.data("id"))?true:false;I.preventDefault();if(!o.find("#pl-item-add").length){if(!t.isVisible()&&!J){t.trigger("hide.pl2");i(o)}else{if(!t.isVisible()){t.trigger("show.pl2",[parseInt(o.data("id"))]);i(o)}else{t.trigger("hide.pl2");l()}}}}).on("click",".pl-favorite",function(I){I.preventDefault();var H=$(this),o=H.closest(n);x(o)}).on("increaseSelectedItem.pl2",function(o){w(o)}).on("decreaseSelectedItem.pl2",function(o){v(o)}).on("deselectItem.pl2",l).on("removeItem.pl2",function(o,H){F(H)}).on("replaceSelectedItem.pl2",function(H,o){u(o)});$(document).on("keydown",function(o){switch(o.which){case 9:if(!(q.list&&q.list.list_details.isVisible())&&!t.isVisible()){if(o.shiftKey){v(o)}else{w(o)}}break;case 27:t.isVisible()&&t.trigger("hide.pl2");break}});A.click(function(){G.slideDown(200);$(this).slideUp(200);return false})};y();return{$el:m,trigger:function(o,H){this.$el&&this.$el.trigger(o,H)}}};function a(){var e=$("#pl-list-content").offset().top;var d=$(window).scrollTop();var b=$(window).height();if($(".pl-details .fields form").height()>b){return}if(d>e){$(".pl-details").addClass("sticky");var c=$(document).height()-b-d;$(".pl-details").css("bottom",Math.max(0,16-c)+"px")}else{$(".pl-details").removeClass("sticky")}}}());