(function(){$.pocketlists.List=function(h){var e=h.find("#pl-new-list-input"),f=parseInt(h.find("#pl-list-id").val()),m=parseInt($("#pl-pocket-id").val()),b=$("#pl-dialog-delete-confirm"),c=$("#pl-dialog-list-archive-complete-all");var l=(function(t){var s=null;var p=function(){$.pocketlists.scrollToTop(200,80);t.html($.pocketlists.$loading).show();a();$.post("?module=list&action=details",{id:f},function(w){t.html(w);v()})};var r=function(){t.hide().empty()};var q=function(w){h.find("#pl-list-name").text(w.name);if(w.due_date||w.due_datetime){var x="pl-due-someday";if(w.calc_priority==1){x="pl-due-tomorrow"}else{if(w.calc_priority==2){x="pl-due-today"}else{if(w.calc_priority==3){x="pl-due-overdue"}}}h.find(".pl-list-due").removeClass().addClass("pl-list-due "+x).text(w.due_datetime?w.due_datetime:w.due_date).show()}else{h.find(".pl-list-due").hide()}$("#pl-lists").find('[data-pl-list-id="'+f+'"]').removeClass().addClass("pl-"+w.color).find(".pl-list-name").text(w.name).end().find(".listicon48").css("background-image","url("+s+w.icon+")");$(".pl-items").removeClass().addClass("pl-items pl-"+w.color)};var v=function(){var w={changeMonth:true,changeYear:true,shortYearCutoff:2,dateShowWeek:false,showOtherMonths:true,selectOtherMonths:true,stepMonths:1,numberOfMonths:1,gotoCurrent:true,constrainInput:false};t.find("#pl-list-due-datetime").datepicker(w);s=t.find("#pl-list-icon-dialog").find("ul").data("pl-icons-path")};var u=function(){if(t.data("pl-ListDetails")){return}t.data("pl-ListDetails",true);t.on("submit","form",function(x){x.preventDefault();var w=$(this);w.find("#pl-list-details-save").after($.pocketlists.$loading);$.post("?module=list&action=save",w.serialize(),function(y){$.pocketlists.$loading.remove();if(y.status==="ok"){q(y.data);r()}else{t.find(".error").show().delay(3000).hide()}},"json");return false}).on("click","#pl-list-details-cancel",function(w){w.preventDefault();r()}).on("click","#pl-list-color a",function(w){w.preventDefault();$("#pl-list-color").find("input").val($(this).data("pl-list-color"));$(this).addClass("selected").siblings().removeClass("selected")}).on("click","#pl-list-due-datetime-set",function(x){x.preventDefault();var w=$(this);w.hide().siblings().show().filter("select").prop("disabled",false)}).on("click","#pl-list-due-datetime-clear",function(x){x.preventDefault();var w=$(this);w.hide().siblings().show().filter("select").hide().prop("disabled",true)}).on("click","#pl-list-icon-change a",function(w){w.preventDefault();$("#pl-list-icon-dialog").waDialog({onLoad:function(){var x=$(this);$("#pl-list-icon-dialog").on("click","a[data-pl-list-icon]",function(A){A.preventDefault();var y=$(this).data("pl-list-icon"),z=$(this);t.find("#pl-list-icon-change").find("input").val($(this).data("pl-list-icon"));z.find("input").val(y);t.find("#pl-list-icon-change .listicon48").css("background-image","url("+s+y+")");x.trigger("close");return false})}})}).on("show.pl2",p).on("hide.pl2",r);$(window).scroll(function(){a()})};u();return{$el:t,trigger:function(w,x){this.$el&&this.$el.trigger(w,x)},isVisible:function(){return this.$el?this.$el.is(":visible"):false}}}($("#pl-list-details")));var o=function(q){var p={name:e.val().trim(),type:"checklist",pocket_id:m};if(p.name){$.post("?module=list&action=update",{data:p,id:q},function(s){if(s.status==="ok"){if(f===-1){$.wa.setHash("#/pocket/"+m+"/list/"+s.data.id+"/")}}else{}},"json")}};var j=function(){var p=h.find('[class*="star"]');$.post("?module=list&action=favorite",{id:f,status:p.hasClass("star-empty")?1:0},function(q){if(q.status==="ok"){p.toggleClass("star-empty star")}else{alert(q.errors)}},"json")};var k=function(){b.waDialog({height:"150px","min-height":"150px",width:"400px",onLoad:function(){},onSubmit:function(p){$.post("?module=list&action=delete",{list_id:f},function(q){if(q.status==="ok"){p.trigger("close");$.wa.setHash("#/pocket/1/")}else{}},"json");return false}})};var d=function(){$.post("?module=list&action=archive",{list_id:f,archive:1},function(p){if(p.status==="ok"){$.wa.setHash("#/pocket/1/")}else{}},"json")};var i=function(){$.post("?module=list&action=sort",{list_id:f},function(p){if(p.status==="ok"){$.pocketlists_routing.redispatch()}else{}},"json")};var g=function(){h.removeData("pl-clicked")};var n=function(){if(e.length){e.focus();e.on("keydown",function(p){if(p.which===13){p.preventDefault();o(f)}})}h.on("click",function(q){var p=h.data("pl-clicked");if($(q.target).closest(".pl-done-label").length){return}if(p==1){h.data("pl-clicked",2);$.pocketlists.scrollToTop(200,80);l.trigger("show.pl2")}else{if(p==2){l.trigger("hide.pl2");g()}else{h.data("pl-clicked",1)}}}).on("click",'[data-pl-action="list-delete"]',function(p){p.preventDefault();k()}).on("click",'[data-pl-action="list-archive"]',function(p){p.preventDefault();d()}).on("click",'[data-pl-action="list-sort"]',function(p){p.preventDefault();i()}).on("click",'[data-pl-action="list-favorite"]',function(p){p.preventDefault();j()}).on("click","#pl-list-complete",function(p){p.stopPropagation();c.waDialog({height:"150px","min-height":"150px",width:"400px",onLoad:function(){var q=$(this);q.on("click","[data-pl-action]",function(t){t.preventDefault();var s=$(this),r=s.data("pl-action");s.after($.pocketlists.$loading);if(r==="list-complete-all"){$.post("?module=list&action=complete",{list_id:f,status:1},function(u){if(u.status==="ok"){q.trigger("close");$.pocketlists_routing.redispatch()}else{}},"json")}else{if(r==="list-archive"){$.post("?module=list&action=archive",{list_id:f,archive:1},function(u){if(u.status==="ok"){q.trigger("close");$.wa.setHash("#/pocket/"+m)}else{}},"json")}else{if(r==="cancel"){$("#pl-list-complete").prop("checked",false);q.trigger("close");$.pocketlists.$loading.remove()}}}})}})}).on("deleteList.pl2",k).on("deselectList.pl2",g);$(document).on("keydown",function(p){switch(p.which){case 27:l.isVisible()&&l.trigger("hide.pl2");break}})};n();return{$el:h,list_details:l,list_id:f,pocket_id:m}};$.pocketlists.Items=function(r,j){var v=r.find("#pl-undone-items > ul.menu-v"),w=$("#pl-undone-items ul.menu-v"),K=r.find("#pl-complete-log"),e=K.find("ul.menu-v").first(),H=$("#pl-item-add").detach(),k=H.find("textarea"),F=$('<div id="pl-item-add-wrapper-hover" style="display: none;">'),s="[data-parent-id]",n=$("#pl-item-add-link"),E=$("#pl-complete-log-link"),b=r.find("#pl-empty-list-msg"),G=null,p={enableAddLinkOnHover:true,enableChangeLevel:true,enableSortItems:true,list:null,assignUser:null,showMessageOnEmptyList:false},u={};var d=function(){if(u.enableSortItems){w.sortable({item:s,connectWith:"ul.menu-v",placeholder:"pl-item-placeholder",tolerance:"pointer",stop:function(L,N){var o=N.item.parents(s).first(),M=o.length?parseInt(o.data("id")):0;N.item.data("parent-id",M);f(parseInt(N.item.data("id")))}})}};var D=function(o,M){var L=$(this);$.post("?module=item&action=create",{list_id:u.list?u.list.list_id:0,data:o,assigned_contact_id:u.assignUser?u.assignUser:false},function(O){var P=L.closest(s);var N=$(""+O+"");k.data("can_blur",false);if(P.length){if(!P.parents(s).length||H.prev(".pl-item").length){P.after(N)}else{P.before(N)}}else{v.prepend(N)}N.filter(s).last().find(".pl-item").first().after(H);k.val("").trigger("focus").css("height","auto").data("can_blur",true);$.isFunction(M)&&M.call(L);g();i();f()})};var c=function(){var o=[];v.find(s).each(function(L){var M=$(this);o.push({id:M.data("id"),parent_id:M.data("parent-id"),sort:L,has_children:M.find(s).length?1:0})});return o};var f=function(o){if(u.enableSortItems&&u.list){$.post("?module=item&action=sort",{list_id:u.list.list_id,item_id:o?o:0,data:c()},function(L){if(L.status==="ok"){d()}else{alert(L.errors)}},"json")}};var I=function(L,o,N){var M=parseInt(L.data("id"));L.prop("disabled",true);$.post("?module=item&action=complete",{id:M,status:o},function(O){if(O.status==="ok"){$.pocketlists.updateAppCounter();L.find("ul.menu-v").find(":checkbox").prop("checked",o);L.find(".pl-done").prop("disabled",false);L.find(".pl-item-name").toggleClass("gray");setTimeout(function(){L.slideToggle(200,function(){L.show();if(o){e.append(L)}else{v.append(L);f()}i();$("#pl-complete-log-link").find("i").text($_("Show all "+e.find("[data-id]").length+" completed to-dos"));l();N&&$.isFunction(N)&&N.call(L)})},800)}else{alert(O.errors)}$.pocketlists.$loading.remove()},"json")};var A=function(o){if(u.enableChangeLevel&&G){o.preventDefault();o.stopPropagation();G.each(function(){var N=$(this),M=N.prev(s);if(M.length){var O=parseInt(M.data("id"));N.data("parent-id",O);var L=M.find("ul.menu-v").first();if(L.length){L.append(N)}else{M.append($('<ul class="menu-v">').html(N))}f(parseInt(N.data("id")))}})}};var z=function(o){if(u.enableChangeLevel&&G){o.preventDefault();o.stopPropagation();G.each(function(){var M=$(this),L=M.parents(s).first();if(L.length){var O=parseInt(L.data("parent-id"));M.data("parent-id",O);var N=M.nextAll(),P=M.find("ul.menu-v");if(!P.length){P=$('<ul class="menu-v">');M.append(P)}P.append(N);L.after(M);f(parseInt(M.data("id")))}})}};var B=function(o){var L=o.find('[class*="star"]'),M=parseInt(o.data("id"));$.post("?module="+type+"&action=favorite",{id:M,status:L.hasClass("star-empty")?1:0},function(N){if(N.status==="ok"){L.toggleClass("star-empty star")}else{alert(N.errors)}},"json")};var m=function(o){G=o;if(G){var L=G.find(".pl-item").first();r.find(".pl-item").removeClass("pl-item-selected");L.addClass("pl-item-selected");G.prop("checked",true)}};var q=function(){if(G){r.find(".pl-item").removeClass("pl-item-selected");G.prop("checked",false);G=null}};var J=function(o){r.find('[data-id="'+o+'"]').remove()};var y=function(o){if(G){G.find(".pl-item").first().replaceWith($(o).addClass("pl-item-selected"))}};var i=function(){if(u.list&&u.list.list_id){$("#pl-lists").find('[data-pl-list-id="'+u.list.list_id+'"]').find(".count").text(v.find("[data-id]").length)}};var h=function(){return !c().length};var l=function(){h()&&u.showMessageOnEmptyList&&b.show()};var g=function(){u.showMessageOnEmptyList&&b.hide()};var t=function(){var L=function(){k.css("height","auto");k.css("height",(k.get(0).scrollHeight-parseInt(k.css("padding-top"))-parseInt(k.css("padding-bottom")))+"px")};var o=function(){H.slideUp(200,function(){H.detach();$(".pl-new-item-wrapper").remove();k.val("");l()})};var M=function(){n.on("click",function(P){P.preventDefault();P.stopPropagation();function O(){g();H.prependTo(v).slideDown(200,function(){k.focus()}).wrap('<li class="pl-new-item-wrapper">')}if(H.is(":visible")){H.slideUp(200,function(){H.detach();$(".pl-new-item-wrapper").remove();O()})}else{O()}});if(h()&&!u.showMessageOnEmptyList){n.trigger("click")}k.on("change cut keydown drop paste",function(){window.setTimeout(L,0)}).on("keydown",function(R){var Q=$(this);Q.data("can_blur",true);if(!R.shiftKey&&R.which===13){R.preventDefault();var P=Q.closest(".menu-v").find(s).first().data("parent-id"),O=Q.val().trim();if(O){D.call(this,[{name:O,parent_id:P}])}}else{if(R.which===27){o()}}}).on("paste",function(){var P=$(this).closest(".menu-v").find(s).first().data("parent-id");var O=this;setTimeout(function(){var Q=k.val().split(/\n/);var T=[];if(Q.length>1){for(var S=0;S<Q.length;S++){var R=$.trim(Q[S]);if(R){T.push({name:R,parent_id:P})}}D.call(O,T)}},100)}).on("blur",function(){var R=$(this),Q=R.closest(".menu-v").find(s).first().data("parent-id"),P=R.val().trim(),O=R.data("can_blur");if(O){if(P){D.call(this,[{name:P,parent_id:Q}],o)}else{o()}}});var N=null;if(u.enableAddLinkOnHover){v.on("mouseenter",s+" > .pl-item",function(P){P.stopPropagation();var O=$(this);N=setTimeout(function(){if(!O.find(H).length){O.find(".pl-select-label").append(F.show())}},500)}).on("mouseleave",s+" > .pl-item",function(){clearTimeout(N);F.detach()});F.on("click",function(){var O=$(this);var P=O.closest(s).find(".menu-v");k.data("can_blur",false);if(P.length){P.find(".pl-item").first().before(H)}else{O.closest(s).find(".pl-item").first().after(H)}F.detach();H.slideDown(200);k.focus();k.data("can_blur",true)})}};M()};var x=(function(N){var Q=0,o=$("#pl-dialog-delete-confirm");var M=function(){N.hide().empty();Q=0;r.trigger("deselectItem.pl2")};var L=function(R){Q=R;N.html($.pocketlists.$loading).show();a();$.post("?module=item&action=details",{id:Q},function(S){N.html(S);P()})};var P=function(){var R={changeMonth:true,changeYear:true,shortYearCutoff:2,dateShowWeek:false,showOtherMonths:true,selectOtherMonths:true,stepMonths:1,numberOfMonths:1,gotoCurrent:true,constrainInput:false};N.find("#pl-item-due-datetime").datepicker(R)};var O=function(){if(N.data("pl-ListDetails")){return}N.data("pl-ListDetails",true);N.on("submit","form",function(S){S.preventDefault();var R=$(this);R.find("#pl-item-details-save").after($.pocketlists.$loading);$.post("?module=item&action=data",R.serialize(),function(T){$.pocketlists.updateAppCounter();$.pocketlists.$loading.remove();r.trigger("replaceSelectedItem.pl2",[T]);M()});return false}).on("click","#pl-item-details-cancel",function(R){R.preventDefault();M()}).on("click","#pl-item-priority a",function(R){R.preventDefault();$("#pl-item-priority").find("input").val($(this).data("pl-item-priority"));$(this).addClass("selected").siblings().removeClass("selected")}).on("click","#pl-item-due-datetime-set",function(S){S.preventDefault();var R=$(this);R.hide().siblings().show().filter("select").prop("disabled",false)}).on("click","#pl-item-due-datetime-clear",function(S){S.preventDefault();var R=$(this);R.hide().siblings().show().filter("select").hide().prop("disabled",true)}).on("click",'[data-pl-action="item-delete"]',function(R){R.preventDefault();o.waDialog({height:"150px","min-height":"150px",width:"400px",onLoad:function(){},onSubmit:function(S){$.post("?module=item&action=delete",{id:Q,list_id:list.list_id},function(T){if(T.status==="ok"){r.trigger("deselectItem.pl2",[T.data.id]);M();S.trigger("close")}else{}},"json");return false}})}).on("change","#pl-assigned-contact select",function(){var R=$(this).val();$("#pl-assigned-contact").find('[data-pl-contact-id="'+R+'"]').show().siblings().hide()}).on("show.pl2",function(R,S){L(S)}).on("hide.pl2",M);$(window).scroll(function(){a()})};O();return{$el:N,trigger:function(R,S){this.$el&&this.$el.trigger(R,S)},isVisible:function(){return this.$el?this.$el.is(":visible"):false}}}($("#pl-item-details")));var C=function(){u=$.extend({},p,j);if($.pocketlists_routing.getHash()=="#/todo/"&&$.pocketlists_routing.getHash().indexOf("/team/")>0){H.prependTo(v).slideDown(200).wrap('<li class="pl-new-item-wrapper">');k.focus()}l();d();n.length&&new t();r.on("change",".pl-done",function(){var M=$(this),L=M.closest(s),o=M.is(":checked")?1:0;I(L,o)}).on("change",".pl-is-selected",function(M){var L=$(this),o=L.closest(s),N=(G&&G.data("id")==o.data("id"))?true:false;M.preventDefault();if(!o.find("#pl-item-add").length){if(!x.isVisible()&&!N){x.trigger("hide.pl2");m(o)}else{if(!x.isVisible()){x.trigger("show.pl2",[parseInt(o.data("id"))]);m(o)}else{x.trigger("hide.pl2");q()}}}}).on("click",".pl-favorite",function(M){M.preventDefault();var L=$(this),o=L.closest(s);B(o)}).on("increaseSelectedItem.pl2",function(o){A(o)}).on("decreaseSelectedItem.pl2",function(o){z(o)}).on("deselectItem.pl2",q).on("removeItem.pl2",function(o,L){J(L)}).on("replaceSelectedItem.pl2",function(L,o){y(o)});$(document).on("keydown",function(o){switch(o.which){case 9:if(!(u.list&&u.list.list_details.isVisible())&&!x.isVisible()){if(o.shiftKey){z(o)}else{A(o)}}break;case 27:x.isVisible()&&x.trigger("hide.pl2");break}});E.click(function(){K.slideDown(200);$(this).slideUp(200);return false})};C();return{$el:r,trigger:function(o,L){this.$el&&this.$el.trigger(o,L)}}};function a(){var e=$("#pl-list-content").offset().top;var d=$(window).scrollTop();var b=$(window).height();if($(".pl-details .fields form").height()>b){return}if(d>e){$(".pl-details").addClass("sticky");var c=$(document).height()-b-d;$(".pl-details").css("bottom",Math.max(0,16-c)+"px")}else{$(".pl-details").removeClass("sticky")}}}());