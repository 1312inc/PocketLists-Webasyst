(function(){var e=parseInt($("#pl-list-id").val()),l=parseInt($("#pl-pocket-id").val()),k=$('<i class="icon16 loading">'),h=$("#pl-new-list-input"),c=$("#pl-item-add").detach(),j=c.find("textarea"),g=$('<div id="pl-item-add-wrapper-hover" style="display: none;">');var f=function(o){var n={name:$(this).val().trim(),type:"checklist",pocket_id:l};if(n.name){$(this).after(k);$.post("?module=list&action=update",{data:n,id:o},function(p){if(p.status==="ok"){if(e===-1){$.wa.setHash("#/pocket/"+l+"/list/"+p.data.id+"/")}}else{}},"json")}};var b=function(n){;var o=$(this);o.after(k);$.post("?module=item&action=create",{list_id:e,data:n},function(q){;var r=o.closest(".pl-item-wrapper");var p=$(""+q+"");p.filter(".pl-item-wrapper").last().find(".pl-item").first().after(c);k.remove();r.after(p);j.val("").trigger("focus")})};var m=function(n,o){$.post("?module=item&action=move",{list_id:e,data:n},function(p){;if(p.status==="ok"){$.isFunction(o)&&o.call()}else{alert(p.errors)}},"json")};var a=function(){var n=[];$(".pl-item-wrapper").each(function(o){var p=$(this);n.push({id:p.data("id"),parent_id:p.data("parent-id"),sort:o})});return n};var d=function(n){this.find("label").first().append(k);$.post("?module=item&action=sort",{list_id:e,data:a()},function(o){if(o.status==="ok"){i();n&&$.isFunction(n)&&n.call()}else{alert(o.errors)}k.remove()},"json")};if(h.length){h.focus();h.on("keydown",function(n){if(n.which===13){n.preventDefault();f.call(this,e)}})}$("#pl-item-add-link").click(function(n){n.preventDefault();if(c.is(":visible")){c.slideUp(200,function(){c.detach();$(".pl-new-item-wrapper").remove()})}else{c.prependTo(".pl-list-items ul.menu-v:first").slideDown(200).wrap('<li class="pl-new-item-wrapper">')}j.focus()});j.on("keydown",function(p){var o=$(this);if(p.which===13){p.preventDefault();var n=o.closest(".menu-v").find(".pl-item-wrapper").first().data("parent-id");b.call(this,[{name:o.val().trim(),parent_id:n}])}else{if(p.which===27){c.slideUp(200,function(){c.detach();$(".pl-new-item-wrapper").remove()});j.val("")}}}).on("paste",function(p){var n=this;var o=$this.closest(".menu-v").find(".pl-item-wrapper").first().data("parent-id");setTimeout(function(){var q=j.val().trim().split(/\n/);var t=[];for(var s=0;s<q.length;s++){var r=$.trim(q[s]);if(r){t.push({name:r,parent_id:o})}}b.call(n,t)},100)});$(".pl-list-items > .menu-v").on("mouseenter",".pl-item-wrapper > .pl-item",function(p){p.stopPropagation();var n=$(this);if(!n.find(c).length){var o=n.closest(".pl-item-wrapper").find(".menu-v");if(o.length){o.find(".pl-item").first().before(g.show())}else{n.after(g.show())}}}).on("mouseleave",function(n){g.detach()});g.on("click",function(n){g.after(c);g.detach();c.slideDown(200);j.focus()});$(".pl-is-selected").change(function(){$("#pl-item-details").toggle();$(this).closest(".pl-list-items").find(".pl-item").removeClass("pl-item-selected");$(this).closest(".pl-item").toggleClass("pl-item-selected")});$(document).on("keydown",function(n){if(n.which===39){var o=$(".pl-list-items").find(".pl-item-selected").closest(".pl-item-wrapper");if(o.length){o.each(function(){var r=$(this),q=r.prev(".pl-item-wrapper"),p=q.next(".pl-item-wrapper");if(q.length){var u=parseInt(q.data("id")),s=parseInt(r.data("id")),v=p.length?parseInt(p.data("id")):0,t=[{id:s,parent_id:u,before_id:v}];r.data("parent-id",u);d.call(r,function(){var w=q.find("ul").first();if(w.length){w.append(r)}else{q.append($('<ul class="menu-v">').html(r))}})}})}}else{if(n.which===37){var o=$(".pl-list-items").find(".pl-item-selected").closest(".pl-item-wrapper");if(o.length){o.each(function(){var w=$(this),p=w.parents(".pl-item-wrapper").first(),r=p.next(".pl-item-wrapper");if(p.length){var u=parseInt(p.data("parent-id")),x=parseInt(w.data("id")),q=r.length?parseInt(r.data("id")):0,t=[{id:x,parent_id:u,before_id:q}];w.data("parent-id",u);var v=w.nextAll(),s=w.find("ul.menu-v");v.each(function(){v.data("parent-id",x);t.push({id:$(this).data("id"),parent_id:x})});d.call(w,function(){if(!s.length){s=$('<ul class="menu-v">');w.append(s)}s.append(v);p.after(w)})}})}}}});var i=function(){$(".pl-list-items ul.menu-v").sortable({connectWith:"ul.menu-v",placeholder:"pl-item-placeholder",stop:function(o,q){;var n=q.item.parents(".pl-item-wrapper").first(),p=n.length?parseInt(n.data("id")):0;q.item.data("parent-id",p);d.call(q.item)}})};i();$(".pl-done").click(function(){$(this).closest("li").slideToggle(200)});$("#pl-complete-log-link").click(function(){$("#pl-complete-log").slideToggle(200);$(this).hide(200);return false})}());