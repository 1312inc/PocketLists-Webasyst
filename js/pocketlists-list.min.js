(function(){var f=parseInt($("#pl-list-id").val()),l=parseInt($("#pl-pocket-id").val()),m=$(".pl-list-items"),k=$('<i class="icon16 loading">'),h=$("#pl-new-list-input"),c=$("#pl-item-add").detach(),j=c.find("textarea"),g=$('<div id="pl-item-add-wrapper-hover" style="display: none;">');var e=function(p){var o={name:$(this).val().trim(),type:"checklist",pocket_id:l};if(o.name){$(this).after(k);$.post("?module=list&action=update",{data:o,id:p},function(q){if(q.status==="ok"){if(f===-1){$.wa.setHash("#/pocket/"+l+"/list/"+q.data.id+"/")}}else{}},"json")}};var b=function(o){var p=$(this);p.after(k);$.post("?module=item&action=create",{list_id:f,data:o},function(r){var s=p.closest(".pl-item-wrapper");var q=$(""+r+"");q.filter(".pl-item-wrapper").last().find(".pl-item").first().after(c);if(s.length){s.after(q)}else{m.find("ul.menu-v").first().prepend(q)}k.remove();j.val("").trigger("focus");d.call(q)})};var n=function(o,p){$.post("?module=item&action=move",{list_id:f,data:o},function(q){if(q.status==="ok"){$.isFunction(p)&&p.call()}else{alert(q.errors)}},"json")};var a=function(){var o=[];$(".pl-item-wrapper").each(function(p){var q=$(this);o.push({id:q.data("id"),parent_id:q.data("parent-id"),sort:p})});return o};var d=function(o){this.find("label").first().append(k);$.post("?module=item&action=sort",{list_id:f,data:a()},function(p){if(p.status==="ok"){i();o&&$.isFunction(o)&&o.call()}else{alert(p.errors)}k.remove()},"json")};if(h.length){h.focus();h.on("keydown",function(o){if(o.which===13){o.preventDefault();e.call(this,f)}})}$("#pl-item-add-link").click(function(o){o.preventDefault();if(c.is(":visible")){c.slideUp(200,function(){c.detach();$(".pl-new-item-wrapper").remove()})}else{c.prependTo(".pl-list-items ul.menu-v:first").slideDown(200).wrap('<li class="pl-new-item-wrapper">')}j.focus()});j.on("keydown",function(q){var p=$(this);if(q.which===13){q.preventDefault();var o=p.closest(".menu-v").find(".pl-item-wrapper").first().data("parent-id");b.call(this,[{name:p.val().trim(),parent_id:o}])}else{if(q.which===27){c.slideUp(200,function(){c.detach();$(".pl-new-item-wrapper").remove()});j.val("")}}}).on("paste",function(q){var p=$(this).closest(".menu-v").find(".pl-item-wrapper").first().data("parent-id");var o=this;setTimeout(function(){var r=j.val().split(/\n/);var u=[];if(r.length>1){for(var t=0;t<r.length;t++){var s=$.trim(r[t]);if(s){u.push({name:s,parent_id:p})}}b.call(o,u)}},100)});$(".pl-list-items > .menu-v").on("mouseenter",".pl-item-wrapper > .pl-item",function(q){q.stopPropagation();var o=$(this);if(!o.find(c).length){var p=o.closest(".pl-item-wrapper").find(".menu-v");if(p.length){p.find(".pl-item").first().before(g.show())}else{o.after(g.show())}}}).on("mouseleave",function(o){g.detach()});g.on("click",function(o){g.after(c);g.detach();c.slideDown(200);j.focus()});m.on("change",".pl-is-selected",function(){$("#pl-item-details").toggle();$(this).closest(".pl-list-items").find(".pl-item").removeClass("pl-item-selected");$(this).closest(".pl-item").toggleClass("pl-item-selected")});$(document).on("keydown",function(o){var p=m.find(".pl-item-selected").closest(".pl-item-wrapper");if(o.which===39){if(p.length){p.each(function(){var s=$(this),r=s.prev(".pl-item-wrapper"),q=r.next(".pl-item-wrapper");if(r.length){var v=parseInt(r.data("id")),t=parseInt(s.data("id")),w=q.length?parseInt(q.data("id")):0,u=[{id:t,parent_id:v,before_id:w}];s.data("parent-id",v);d.call(s,function(){var x=r.find("ul").first();if(x.length){x.append(s)}else{r.append($('<ul class="menu-v">').html(s))}})}})}}else{if(o.which===37){if(p.length){p.each(function(){var x=$(this),q=x.parents(".pl-item-wrapper").first(),s=q.next(".pl-item-wrapper");if(q.length){var v=parseInt(q.data("parent-id")),y=parseInt(x.data("id")),r=s.length?parseInt(s.data("id")):0,u=[{id:y,parent_id:v,before_id:r}];x.data("parent-id",v);var w=x.nextAll(),t=x.find("ul.menu-v");w.each(function(){w.data("parent-id",y);u.push({id:$(this).data("id"),parent_id:y})});d.call(x,function(){if(!t.length){t=$('<ul class="menu-v">');x.append(t)}t.append(w);q.after(x)})}})}}}});var i=function(){$(".pl-list-items ul.menu-v").sortable({connectWith:"ul.menu-v",placeholder:"pl-item-placeholder",stop:function(p,r){var o=r.item.parents(".pl-item-wrapper").first(),q=o.length?parseInt(o.data("id")):0;r.item.data("parent-id",q);d.call(r.item)}})};i();$(".pl-done").click(function(){$(this).closest("li").slideToggle(200)});$("#pl-complete-log-link").click(function(){$("#pl-complete-log").slideToggle(200);$(this).hide(200);return false})}());