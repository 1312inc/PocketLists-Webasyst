(function(){$.pocketlists.List=function(h){var e=h.find("#pl-new-list-input"),f=parseInt(h.find("#pl-list-id").val()),m=parseInt($("#pl-pocket-id").val()),b=$("#pl-dialog-delete-confirm"),c=$("#pl-dialog-list-archive-complete-all");var l=(function(t){var s=null;var p=function(){$.pocketlists.scrollToTop(200,80);t.html($.pocketlists.$loading).show();a();$.post("?module=list&action=details",{id:f},function(w){t.html(w);v()})};var r=function(){t.hide().empty()};var q=function(w){h.find("#pl-list-name").text(w.name);if(w.due_date||w.due_datetime){var x="pl-due-someday";if(w.calc_priority==1){x="pl-due-tomorrow"}else{if(w.calc_priority==2){x="pl-due-today"}else{if(w.calc_priority==3){x="pl-due-overdue"}}}h.find(".pl-list-due").removeClass().addClass("pl-list-due "+x).text(w.due_datetime?w.due_datetime:w.due_date).show()}else{h.find(".pl-list-due").hide()}$("#pl-lists").find('[data-pl-list-id="'+f+'"]').removeClass().addClass("pl-"+w.color).find(".pl-list-name").text(w.name).end().find(".listicon48").css("background-image","url("+s+w.icon+")");$(".pl-items").removeClass().addClass("pl-items pl-"+w.color)};var v=function(){var w={changeMonth:true,changeYear:true,shortYearCutoff:2,dateShowWeek:false,showOtherMonths:true,selectOtherMonths:true,stepMonths:1,numberOfMonths:1,gotoCurrent:true,constrainInput:false};t.find("#pl-list-due-datetime").datepicker(w);s=t.find("#pl-list-icon-dialog").find("ul").data("pl-icons-path")};var u=function(){if(t.data("pl-ListDetails")){return}t.data("pl-ListDetails",true);t.on("submit","form",function(x){x.preventDefault();var w=$(this);w.find("#pl-list-details-save").after($.pocketlists.$loading);$.post("?module=list&action=save",w.serialize(),function(y){$.pocketlists.$loading.remove();if(y.status==="ok"){q(y.data);r()}else{t.find(".error").show().delay(3000).hide()}},"json");return false}).on("click","#pl-list-details-cancel",function(w){w.preventDefault();r()}).on("click","#pl-list-color a",function(w){w.preventDefault();$("#pl-list-color").find("input").val($(this).data("pl-list-color"));$(this).addClass("selected").siblings().removeClass("selected")}).on("click","#pl-list-due-datetime-set",function(x){x.preventDefault();var w=$(this);w.hide().siblings().show().filter("select").prop("disabled",false)}).on("click","#pl-list-due-datetime-clear",function(x){x.preventDefault();var w=$(this);w.hide().siblings().show().filter("select").hide().prop("disabled",true)}).on("click","#pl-list-icon-change a",function(w){w.preventDefault();$("#pl-list-icon-dialog").waDialog({onLoad:function(){var x=$(this);$("#pl-list-icon-dialog").on("click","a[data-pl-list-icon]",function(A){A.preventDefault();var y=$(this).data("pl-list-icon"),z=$(this);t.find("#pl-list-icon-change").find("input").val($(this).data("pl-list-icon"));z.find("input").val(y);t.find("#pl-list-icon-change .listicon48").css("background-image","url("+s+y+")");x.trigger("close");return false})}})}).on("show.pl2",p).on("hide.pl2",r)};u();return{$el:t,trigger:function(w,x){this.$el&&this.$el.trigger(w,x)},isVisible:function(){return this.$el?this.$el.is(":visible"):false}}}($("#pl-list-details")));var o=function(q){var p={name:e.val().trim(),type:"checklist",pocket_id:m};if(p.name){$.post("?module=list&action=update",{data:p,id:q},function(s){if(s.status==="ok"){if(f===-1){$.wa.setHash("#/pocket/"+m+"/list/"+s.data.id+"/")}}else{}},"json")}};var j=function(){var p=h.find('[class*="star"]');$.post("?module=list&action=favorite",{id:f,status:p.hasClass("star-empty")?1:0},function(q){if(q.status==="ok"){p.toggleClass("star-empty star")}else{alert(q.errors)}},"json")};var k=function(){b.waDialog({height:"150px","min-height":"150px",width:"400px",onLoad:function(){},onSubmit:function(p){$.post("?module=list&action=delete",{list_id:f},function(q){if(q.status==="ok"){p.trigger("close");$.wa.setHash("#/pocket/1/")}else{}},"json");return false}})};var d=function(){$.post("?module=list&action=archive",{list_id:f,archive:1},function(p){if(p.status==="ok"){$.wa.setHash("#/pocket/1/")}else{}},"json")};var i=function(){$.post("?module=list&action=sort",{list_id:f},function(p){if(p.status==="ok"){$.pocketlists_routing.redispatch()}else{}},"json")};var g=function(){h.removeData("pl-clicked")};var n=function(){if(e.length){e.focus();e.on("keydown",function(p){if(p.which===13){p.preventDefault();o(f)}})}h.on("click",function(q){var p=h.data("pl-clicked");if($(q.target).closest(".pl-done-label").length){return}if(p==1){h.data("pl-clicked",2);$.pocketlists.scrollToTop(200,80);l.trigger("show.pl2")}else{if(p==2){l.trigger("hide.pl2");g()}else{h.data("pl-clicked",1)}}}).on("click",'[data-pl-action="list-delete"]',function(p){p.preventDefault();k()}).on("click",'[data-pl-action="list-archive"]',function(p){p.preventDefault();d()}).on("click",'[data-pl-action="list-sort"]',function(p){p.preventDefault();i()}).on("click",'[data-pl-action="list-favorite"]',function(p){p.preventDefault();j()}).on("click","#pl-list-complete",function(p){p.stopPropagation();c.waDialog({height:"150px","min-height":"150px",width:"400px",onLoad:function(){var q=$(this);q.on("click","[data-pl-action]",function(t){t.preventDefault();var s=$(this),r=s.data("pl-action");s.after($.pocketlists.$loading);if(r==="list-complete-all"){$.post("?module=list&action=complete",{list_id:f,status:1},function(u){if(u.status==="ok"){q.trigger("close");$.pocketlists_routing.redispatch()}else{}},"json")}else{if(r==="list-archive"){$.post("?module=list&action=archive",{list_id:f,archive:1},function(u){if(u.status==="ok"){q.trigger("close");$.wa.setHash("#/pocket/"+m)}else{}},"json")}else{if(r==="cancel"){$("#pl-list-complete").prop("checked",false);q.trigger("close");$.pocketlists.$loading.remove()}}}})}})}).on("deleteList.pl2",k).on("deselectList.pl2",g);$(document).on("keydown",function(p){switch(p.which){case 27:l.isVisible()&&l.trigger("hide.pl2");break}})};n();return{$el:h,list_details:l,list_id:f,pocket_id:m}};$.pocketlists.Items=function(m,g){var r=m.find("#pl-undone-items > ul.menu-v"),s=$("#pl-undone-items ul.menu-v"),d=m.find("#pl-complete-log > ul.menu-v"),C=$("#pl-item-add").detach(),h=C.find("textarea"),A=$('<div id="pl-item-add-wrapper-hover" style="display: none;">'),n="[data-parent-id]",j=$("#pl-item-add-link"),B=null,k={enableAddLinkOnHover:true,enableChangeLevel:true,enableSortItems:true,list:null,assignUser:null},q={};var b=function(){if(q.enableSortItems){s.sortable({item:n,connectWith:"ul.menu-v",placeholder:"pl-item-placeholder",tolerance:"pointer",stop:function(F,H){var o=H.item.parents(n).first(),G=o.length?parseInt(o.data("id")):0;H.item.data("parent-id",G);e(parseInt(H.item.data("id")))}})}};var z=function(o,G){var F=$(this);$.post("?module=item&action=create",{list_id:q.list?q.list.list_id:0,data:o,assigned_contact_id:q.assignUser?q.assignUser:false},function(I){var J=F.closest(n);var H=$(""+I+"");h.data("can_blur",false);if(J.length){if(!J.parents(n).length||C.prev(".pl-item").length){J.after(H)}else{J.before(H)}}else{r.prepend(H)}H.filter(n).last().find(".pl-item").first().after(C);$(".pl-list-empty").removeClass("pl-list-empty");h.val("").trigger("focus").css("height","auto").data("can_blur",true);$.isFunction(G)&&G.call(F);f();e()})};var c=function(){var o=[];r.find(n).each(function(F){var G=$(this);o.push({id:G.data("id"),parent_id:G.data("parent-id"),sort:F,has_children:G.find(n).length?1:0})});return o};var e=function(o){if(q.enableSortItems&&q.list){$.post("?module=item&action=sort",{list_id:q.list.list_id,item_id:o?o:0,data:c()},function(F){if(F.status==="ok"){b()}else{alert(F.errors)}},"json")}};var D=function(F,o,H){var G=parseInt(F.data("id"));F.prop("disabled",true);$.post("?module=item&action=complete",{id:G,status:o},function(I){if(I.status==="ok"){$.pocketlists.updateAppCounter();F.find("ul.menu-v").find(":checkbox").prop("checked",o);F.find(".pl-done").prop("disabled",false);F.find(".pl-item-name").toggleClass("gray");setTimeout(function(){F.slideToggle(200,function(){F.show();if(o){d.append(F)}else{r.append(F);e()}f();$("#pl-complete-log-link").find("i").text($_("Show all "+d.find("[data-id]").length+" completed to-dos"));H&&$.isFunction(H)&&H.call(F)})},800)}else{alert(I.errors)}$.pocketlists.$loading.remove()},"json")};var w=function(o){if(q.enableChangeLevel&&B){o.preventDefault();o.stopPropagation();B.each(function(){var H=$(this),G=H.prev(n);if(G.length){var I=parseInt(G.data("id"));H.data("parent-id",I);var F=G.find("ul.menu-v").first();if(F.length){F.append(H)}else{G.append($('<ul class="menu-v">').html(H))}e(parseInt(H.data("id")))}})}};var v=function(o){if(q.enableChangeLevel&&B){o.preventDefault();o.stopPropagation();B.each(function(){var G=$(this),F=G.parents(n).first();if(F.length){var I=parseInt(F.data("parent-id"));G.data("parent-id",I);var H=G.nextAll(),J=G.find("ul.menu-v");if(!J.length){J=$('<ul class="menu-v">');G.append(J)}J.append(H);F.after(G);e(parseInt(G.data("id")))}})}};var x=function(o){var F=o.find('[class*="star"]'),G=parseInt(o.data("id"));$.post("?module="+type+"&action=favorite",{id:G,status:F.hasClass("star-empty")?1:0},function(H){if(H.status==="ok"){F.toggleClass("star-empty star")}else{alert(H.errors)}},"json")};var i=function(o){B=o;if(B){var F=B.find(".pl-item").first();m.find(".pl-item").removeClass("pl-item-selected");F.addClass("pl-item-selected");B.prop("checked",true)}};var l=function(){if(B){m.find(".pl-item").removeClass("pl-item-selected");B.prop("checked",false);B=null}};var E=function(o){m.find('[data-id="'+o+'"]').remove()};var u=function(o){if(B){B.find(".pl-item").first().replaceWith($(o).addClass("pl-item-selected"))}};var f=function(){if(q.list&&q.list.list_id){$("#pl-lists").find('[data-pl-list-id="'+q.list.list_id+'"]').find(".count").text(r.find("[data-id]").length)}};var p=function(){var F=function(){h.css("height","auto");h.css("height",(h.get(0).scrollHeight-parseInt(h.css("padding-top"))-parseInt(h.css("padding-bottom")))+"px")};var o=function(){C.slideUp(200,function(){C.detach();$(".pl-new-item-wrapper").remove();h.val("")})};var G=function(){j.on("click",function(J){J.preventDefault();J.stopPropagation();function I(){C.prependTo(r).slideDown(200,function(){h.focus()}).wrap('<li class="pl-new-item-wrapper">')}if(C.is(":visible")){C.slideUp(200,function(){C.detach();$(".pl-new-item-wrapper").remove();I()})}else{I()}});if($(".pl-list-empty").length){j.trigger("click")}h.on("change cut keydown drop paste",function(){window.setTimeout(F,0)}).on("keydown",function(L){var K=$(this);K.data("can_blur",true);if(!L.shiftKey&&L.which===13){L.preventDefault();var J=K.closest(".menu-v").find(n).first().data("parent-id"),I=K.val().trim();if(I){z.call(this,[{name:I,parent_id:J}])}}else{if(L.which===27){o()}}}).on("paste",function(){var J=$(this).closest(".menu-v").find(n).first().data("parent-id");var I=this;setTimeout(function(){var K=h.val().split(/\n/);var N=[];if(K.length>1){for(var M=0;M<K.length;M++){var L=$.trim(K[M]);if(L){N.push({name:L,parent_id:J})}}z.call(I,N)}},100)}).on("blur",function(){var L=$(this),K=L.closest(".menu-v").find(n).first().data("parent-id"),J=L.val().trim(),I=L.data("can_blur");if(I){if(J){z.call(this,[{name:J,parent_id:K}],o)}else{o()}}});var H=null;if(q.enableAddLinkOnHover){r.on("mouseenter",n+" > .pl-item",function(J){J.stopPropagation();var I=$(this);H=setTimeout(function(){if(!I.find(C).length){I.find(".pl-select-label").append(A.show())}},500)}).on("mouseleave",n+" > .pl-item",function(){clearTimeout(H);A.detach()});A.on("click",function(){var I=$(this);var J=I.closest(n).find(".menu-v");h.data("can_blur",false);if(J.length){J.find(".pl-item").first().before(C)}else{I.closest(n).find(".pl-item").first().after(C)}A.detach();C.slideDown(200);h.focus();h.data("can_blur",true)})}};G()};var t=(function(H){var K=0,o=$("#pl-dialog-delete-confirm");var G=function(){H.hide().empty();K=0;m.trigger("deselectItem.pl2")};var F=function(L){K=L;H.html($.pocketlists.$loading).show();a();$.post("?module=item&action=details",{id:K},function(M){H.html(M);J()})};var J=function(){var L={changeMonth:true,changeYear:true,shortYearCutoff:2,dateShowWeek:false,showOtherMonths:true,selectOtherMonths:true,stepMonths:1,numberOfMonths:1,gotoCurrent:true,constrainInput:false};H.find("#pl-item-due-datetime").datepicker(L)};var I=function(){if(H.data("pl-ListDetails")){return}H.data("pl-ListDetails",true);H.on("submit","form",function(M){M.preventDefault();var L=$(this);L.find("#pl-item-details-save").after($.pocketlists.$loading);$.post("?module=item&action=data",L.serialize(),function(N){$.pocketlists.updateAppCounter();$.pocketlists.$loading.remove();m.trigger("replaceSelectedItem.pl2",[N]);G()});return false}).on("click","#pl-item-details-cancel",function(L){L.preventDefault();G()}).on("click","#pl-item-priority a",function(L){L.preventDefault();$("#pl-item-priority").find("input").val($(this).data("pl-item-priority"));$(this).addClass("selected").siblings().removeClass("selected")}).on("click","#pl-item-due-datetime-set",function(M){M.preventDefault();var L=$(this);L.hide().siblings().show().filter("select").prop("disabled",false)}).on("click","#pl-item-due-datetime-clear",function(M){M.preventDefault();var L=$(this);L.hide().siblings().show().filter("select").hide().prop("disabled",true)}).on("click",'[data-pl-action="item-delete"]',function(L){L.preventDefault();o.waDialog({height:"150px","min-height":"150px",width:"400px",onLoad:function(){},onSubmit:function(M){$.post("?module=item&action=delete",{id:K,list_id:list.list_id},function(N){if(N.status==="ok"){m.trigger("deselectItem.pl2",[N.data.id]);G();M.trigger("close")}else{}},"json");return false}})}).on("change","#pl-assigned-contact select",function(){var L=$(this).val();$("#pl-assigned-contact").find('[data-pl-contact-id="'+L+'"]').show().siblings().hide()}).on("show.pl2",function(L,M){F(M)}).on("hide.pl2",G)};I();return{$el:H,trigger:function(L,M){this.$el&&this.$el.trigger(L,M)},isVisible:function(){return this.$el?this.$el.is(":visible"):false}}}($("#pl-item-details")));var y=function(){q=$.extend({},k,g);if($.pocketlists_routing.getHash()=="#/todo/"&&$.pocketlists_routing.getHash().indexOf("/team/")>0){C.prependTo(r).slideDown(200).wrap('<li class="pl-new-item-wrapper">');h.focus()}b();j.length&&new p();m.on("change",".pl-done",function(){var G=$(this),F=G.closest(n),o=G.is(":checked")?1:0;D(F,o)}).on("change",".pl-is-selected",function(G){var F=$(this),o=F.closest(n),H=(B&&B.data("id")==o.data("id"))?true:false;G.preventDefault();if(!o.find("#pl-item-add").length){if(!t.isVisible()&&!H){t.trigger("hide.pl2");i(o)}else{if(!t.isVisible()){t.trigger("show.pl2",[parseInt(o.data("id"))]);i(o)}else{t.trigger("hide.pl2");l()}}}}).on("click",".pl-favorite",function(G){G.preventDefault();var F=$(this),o=F.closest(n);x(o)}).on("increaseSelectedItem.pl2",function(o){w(o)}).on("decreaseSelectedItem.pl2",function(o){v(o)}).on("deselectItem.pl2",l).on("removeItem.pl2",function(o,F){E(F)}).on("replaceSelectedItem.pl2",function(F,o){u(o)});$(document).on("keydown",function(o){switch(o.which){case 9:if(!(q.list&&q.list.list_details.isVisible())&&!t.isVisible()){if(o.shiftKey){v(o)}else{w(o)}}break;case 27:t.isVisible()&&t.trigger("hide.pl2");break}})};y();return{$el:m,trigger:function(o,F){this.$el&&this.$el.trigger(o,F)}}};$("#pl-complete-log-link").click(function(){$("#pl-complete-log").slideDown(200);$(this).slideUp(200);return false});function a(){var e=$("#pl-list-content").offset().top;var d=$(window).scrollTop();var b=$(window).height();if($(".pl-details .fields form").height()>b){return}if(d>e){$(".pl-details").addClass("sticky");var c=$(document).height()-b-d;$(".pl-details").css("bottom",Math.max(0,16-c)+"px")}else{$(".pl-details").removeClass("sticky")}}$(window).scroll(function(){a()})}());