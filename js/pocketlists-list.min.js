(function(){var u=parseInt($("#pl-list-id").val()),t=parseInt($("#pl-pocket-id").val()),l=$("#pl-list-items"),p=$("#pl-undone-items > ul.menu-v"),b=$("#pl-complete-log > ul.menu-v"),r=$('<i class="icon16 loading">'),o=$("#pl-new-list-input"),w=$("#pl-item-add").detach(),f=w.find("textarea"),v=$('<div id="pl-item-add-wrapper-hover" style="display: none;">'),m="[data-parent-id]",j=$("#pl-item-add-link");var k=function(){$("#pl-undone-items ul.menu-v").sortable({item:m,connectWith:"ul.menu-v",placeholder:"pl-item-placeholder",tolerance:"pointer",stop:function(y,A){var x=A.item.parents(m).first(),z=x.length?parseInt(x.data("id")):0;A.item.data("parent-id",z);d.call(A.item,parseInt(A.item.data("id")))}})};var c=function(y){var x={name:$(this).val().trim(),type:"checklist",pocket_id:t};if(x.name){$(this).after(r);$.post("?module=list&action=update",{data:x,id:y},function(z){if(z.status==="ok"){if(u===-1){$.wa.setHash("#/pocket/"+t+"/list/"+z.data.id+"/")}}else{}},"json")}};var h=function(x){var y=$(this);y.after(r);$.post("?module=item&action=create",{list_id:u,data:x},function(A){var B=y.closest(m);var z=$(""+A+"");z.filter(m).last().find(".pl-item").first().after(w);if(B.length){B.after(z)}else{p.prepend(z)}r.remove();f.val("").trigger("focus");$(".pl-list-empty").removeClass("pl-list-empty");d.call(z)})};var n=function(x,y){$.post("?module=item&action=move",{list_id:u,data:x},function(z){if(z.status==="ok"){$.isFunction(y)&&y.call()}else{alert(z.errors)}},"json")};var e=function(){var x=[];p.find(m).each(function(y){var z=$(this);x.push({id:z.data("id"),parent_id:z.data("parent-id"),sort:y,has_children:z.find(m).length?1:0})});return x};var d=function(x){this.find("label").first().append(r);$.post("?module=item&action=sort",{list_id:u,item_id:x?x:0,data:e()},function(y){if(y.status==="ok"){k()}else{alert(y.errors)}r.remove()},"json")};var a=function(A,x,z){var y=this;y.find(".pl-select-label").first().append(r);y.prop("disabled",true);$.post("?module=item&action=complete",{list_id:u,id:A,status:x},function(B){if(B.status==="ok"){y.find("ul.menu-v").find(":checkbox").prop("checked",x);y.find(".pl-done").prop("disabled",false);y.find(".pl-item-name").toggleClass("gray");setTimeout(function(){y.slideToggle(200,function(){y.show();if(x){b.append(y)}else{p.append(y);d.call(y)}$("#pl-lists").find('[data-pl-list-id="'+u+'"]').find(".count").text(p.find("[data-id]").length);$("#pl-complete-log-link").find("i").text($_("Show all "+b.find("[data-id]").length+" completed to-dos"));z&&$.isFunction(z)&&z.call(y)})},500)}else{alert(B.errors)}r.remove()},"json")};var q=function(){var x=p.find(".pl-item-selected").closest(m);if(x.length){x.each(function(){var A=$(this),z=A.prev(m);if(z.length){var B=parseInt(z.data("id"));A.data("parent-id",B);var y=z.find("ul.menu-v").first();if(y.length){y.append(A)}else{z.append($('<ul class="menu-v">').html(A))}d.call(A,parseInt(A.data("id")))}})}};var g=function(){var x=p.find(".pl-item-selected").closest(m);if(x.length){x.each(function(){var z=$(this),y=z.parents(m).first();if(y.length){var B=parseInt(y.data("parent-id"));z.data("parent-id",B);var A=z.nextAll(),C=z.find("ul.menu-v");if(!C.length){C=$('<ul class="menu-v">');z.append(C)}C.append(A);y.after(z);d.call(z,parseInt(z.data("id")))}})}};if(o.length){o.focus();o.on("keydown",function(x){if(x.which===13){x.preventDefault();c.call(this,u)}})}j.on("click",function(x){x.preventDefault();x.stopPropagation();if(w.is(":visible")){w.slideUp(200,function(){w.detach();$(".pl-new-item-wrapper").remove()})}else{w.prependTo(p).slideDown(200).wrap('<li class="pl-new-item-wrapper">')}f.focus()});if($(".pl-list-empty").length){j.trigger("click")}f.on("keydown",function(z){var y=$(this);if(!z.shiftKey&&z.which===13){z.preventDefault();var x=y.closest(".menu-v").find(m).first().data("parent-id");h.call(this,[{name:y.val().trim(),parent_id:x}])}else{if(z.which===27){w.slideUp(200,function(){w.detach();$(".pl-new-item-wrapper").remove()});f.val("")}}}).on("paste",function(z){var y=$(this).closest(".menu-v").find(m).first().data("parent-id");var x=this;setTimeout(function(){var A=f.val().split(/\n/);var D=[];if(A.length>1){for(var C=0;C<A.length;C++){var B=$.trim(A[C]);if(B){D.push({name:B,parent_id:y})}}h.call(x,D)}},100)});p.on("mouseenter",m+" > .pl-item",function(z){z.stopPropagation();var x=$(this);if(!x.find(w).length){var y=x.closest(m).find(".menu-v");if(y.length){y.find(".pl-item").first().before(v.show())}else{x.after(v.show())}}}).on("mouseleave",function(x){v.detach()});v.on("click",function(x){v.after(w);v.detach();w.slideDown(200);f.focus()});l.on("change",".pl-is-selected",function(B){var A=$(this),x=$("#pl-item-details"),y=x.is(":visible"),z=A.closest(".pl-item"),D=z.closest(m),C=z.hasClass("pl-item-selected");B.preventDefault();if(!D.find("#pl-item-add").length){if(!y&&!C){x.hide();l.find(".pl-item").removeClass("pl-item-selected");z.addClass("pl-item-selected");A.prop("checked",true)}else{if(!y){x.html(r).show();$.post("?module=item&action=details",{id:parseInt(D.data("id"))},function(E){x.html(E);s(x)});A.prop("checked",true)}else{x.hide().empty();l.find(".pl-item").removeClass("pl-item-selected");A.prop("checked",false)}}}});l.on("change",".pl-done",function(A){var z=$(this),y=z.closest(m),B=parseInt(y.data("id")),x=z.is(":checked")?1:0;a.call(y,B,x)});$(document).on("keydown",function(y){switch(y.which){case 39:q.call(this);break;case 9:if(y.shiftKey){g.call(this)}else{q.call(this)}break;case 37:g.call(this);break;case 27:if($("#pl-list-details").is(":visible")){$("#pl-list-details").hide().empty();$(".pl-list-title").removeData("pl-clicked")}if($("#pl-item-details").is(":visible")){$("#pl-item-details").hide().empty();var x=l.find(".pl-item-selected");x.removeClass("pl-item-selected").prop("checked",false)}break}});k();var s=function(y){var A=0;var z=function(){var B={changeMonth:true,changeYear:true,shortYearCutoff:2,dateShowWeek:false,showOtherMonths:true,selectOtherMonths:true,stepMonths:1,numberOfMonths:1,gotoCurrent:true,constrainInput:false,minDate:new Date()};y.find("#pl-item-due-datetime").datepicker(B);A=parseInt(y.find('input[name="item[id]"]').val());x()};var x=function(){y.find("form").on("submit",function(C){C.preventDefault();var B=$(this);B.find("#pl-item-details-save").after(r);$.post("?module=item&action=data",B.serialize(),function(D){r.remove();l.find('[data-id="'+A+'"] > .pl-item').replaceWith($(D).addClass("pl-item-selected"));y.hide().empty()});return false});y.find("#pl-item-details-cancel").on("click",function(B){B.preventDefault();y.hide().empty();$(".pl-list-title").removeData("pl-clicked")});y.find("#pl-item-priority a").on("click",function(B){B.preventDefault();$("#pl-item-priority").find("input").val($(this).data("pl-item-priority"));$(this).addClass("selected").siblings().removeClass("selected")});y.find('[data-pl-action="item-delete"]').on("click",function(B){B.preventDefault();$("#pl-dialog-delete-confirm").waDialog({height:"150px","min-height":"150px",width:"400px",onLoad:function(){var C=$(this)},onSubmit:function(C){$.post("?module=item&action=delete",{id:A,list_id:u},function(D){if(D.status==="ok"){l.find('[data-id="'+D.data.id+'"]').remove();y.find("#pl-item-details-cancel").trigger("click");C.trigger("close")}else{}},"json");return false}})})};z()};$(".pl-list-title").on("click",function(A){var x=$("#pl-list-details"),z=$(this),y=z.data("pl-clicked");if($(A.target).closest(".pl-done-label").length){return}if(y==1){x.html(r).show();z.data("pl-clicked",2);$.post("?module=list&action=details",{id:parseInt($("#pl-list-id").val())},function(B){x.html(B);i(x)})}else{if(y==2){z.removeData("pl-clicked");x.hide().empty()}else{z.data("pl-clicked",1)}}}).on("click",'[data-pl-action="list-delete"]',function(x){x.preventDefault();$("#pl-dialog-delete-confirm").waDialog({height:"150px","min-height":"150px",width:"400px",onLoad:function(){var y=$(this)},onSubmit:function(y){$.post("?module=list&action=delete",{list_id:u},function(z){if(z.status==="ok"){y.trigger("close");$.wa.setHash("#/pocket/1/")}else{}},"json");return false}})}).on("click",'[data-pl-action="list-archive"]',function(x){x.preventDefault();$.post("?module=list&action=archive",{list_id:u,archive:1},function(y){if(y.status==="ok"){$.wa.setHash("#/pocket/1/")}else{}},"json")}).on("click",'[data-pl-action="list-sort"]',function(x){x.preventDefault();$.post("?module=list&action=sort",{list_id:u},function(y){;if(y.status==="ok"){$.pocketlists_routing.redispatch()}else{}},"json")});var i=function(A){var C=0;var z=A.find("#pl-list-icon-dialog").find("ul").data("pl-icons-path");var B=function(){y();C=parseInt(A.find('input[name="list[id]"]').val())};var y=function(){A.find("form").on("submit",function(E){E.preventDefault();var D=$(this);D.find("#pl-list-details-save").after(r);$.post("?module=list&action=save",D.serialize(),function(F){r.remove();if(F.status==="ok"){x();A.find(".success").show().delay(3000).hide()}else{A.find(".error").show().delay(3000).hide()}},"json");return false});A.find("#pl-list-details-cancel").on("click",function(D){D.preventDefault();A.hide().empty()});A.find("#pl-list-color a").on("click",function(D){D.preventDefault();$("#pl-list-color").find("input").val($(this).data("pl-list-color"));$(this).addClass("selected").siblings().removeClass("selected")});A.find("#pl-list-icon-change a").on("click",function(E){E.preventDefault();var D=$(this);$("#pl-list-icon-dialog").waDialog({onLoad:function(){var F=$(this);$("#pl-list-icon-dialog").on("click","a[data-pl-list-icon]",function(G){G.preventDefault();$(this).closest("ul").find("a[data-pl-list-icon]").removeClass("selected");$(this).addClass("selected");A.find("#pl-list-icon-change").find("input").val($(this).data("pl-list-icon"))})},onSubmit:function(H){var F=$("#pl-list-icon-dialog").find("a[data-pl-list-icon].selected"),G=F.data("pl-list-icon");D.find("input").val(G);A.find("#pl-list-icon-change .listicon48").css("background-image","url("+z+G+")");H.trigger("close");return false}})})};var x=function(){var E=A.find('input[name="list[name]"]').val(),D=A.find("[data-pl-list-color].selected").data("pl-list-color"),F=A.find('input[name="list[icon]"]').val();$("#pl-list-name").text(E);$("#pl-lists").find('[data-pl-list-id="'+C+'"]').removeClass().addClass("pl-"+D).find(".pl-list-name").text(E).end().find(".listicon48").css("background-image","url("+z+F+")");$(".pl-items").removeClass().addClass("pl-items pl-"+D)};B()};$("#pl-list-complete").on("click",function(x){x.stopPropagation();$("#pl-dialog-list-archive-complete-all").waDialog({height:"150px","min-height":"150px",width:"400px",onLoad:function(){var y=$(this);y.on("click","[data-pl-action]",function(B){B.preventDefault();var A=$(this),z=A.data("pl-action");A.after(r);if(z==="list-complete-all"){$.post("?module=item&action=complete",{list_id:u,status:1,id:-1},function(C){if(C.status==="ok"){y.trigger("close");$.pocketlists_routing.redispatch()}else{}},"json")}else{if(z==="list-archive"){$.post("?module=list&action=archive",{list_id:u,archive:1},function(C){if(C.status==="ok"){y.trigger("close");$.wa.setHash("#/pocket/"+t)}else{}},"json")}else{if(z==="cancel"){$("#pl-list-complete").prop("checked",false);y.trigger("close");r.remove()}}}})}})});$("#pl-complete-log-link").click(function(){$("#pl-complete-log").slideDown(200);$(this).slideUp(200);return false})}());