(function(){var y=parseInt($("#pl-list-id").val()),x=parseInt($("#pl-pocket-id").val()),m=$("#pl-list-items"),s=$("#pl-undone-items > ul.menu-v"),b=$("#pl-complete-log > ul.menu-v"),u=$('<i class="icon16 loading">'),q=$("#pl-new-list-input"),B=$("#pl-item-add").detach(),f=B.find("textarea"),z=$('<div id="pl-item-add-wrapper-hover" style="display: none;">'),n="[data-parent-id]",k=$("#pl-item-add-link");var l=function(){$("#pl-undone-items ul.menu-v").sortable({item:n,connectWith:"ul.menu-v",placeholder:"pl-item-placeholder",tolerance:"pointer",stop:function(D,F){var C=F.item.parents(n).first(),E=C.length?parseInt(C.data("id")):0;F.item.data("parent-id",E);d.call(F.item,parseInt(F.item.data("id")))}})};var c=function(D){var C={name:$(this).val().trim(),type:"checklist",pocket_id:x};if(C.name){$(this).after(u);$.post("?module=list&action=update",{data:C,id:D},function(E){if(E.status==="ok"){if(y===-1){$.wa.setHash("#/pocket/"+x+"/list/"+E.data.id+"/")}}else{}},"json")}};var i=function(C){var D=$(this);D.after(u);$.post("?module=item&action=create",{list_id:y,data:C},function(F){;var G=D.closest(n);var E=$(""+F+"");E.filter(n).last().find(".pl-item").first().after(B);if(G.length){if(!G.parents(n).length||G.prev(n).length){G.after(E)}else{G.before(E)}}else{s.prepend(E)}u.remove();f.val("").css("height","auto").trigger("focus");$(".pl-list-empty").removeClass("pl-list-empty");g();d.call(E)})};var p=function(C,D){$.post("?module=item&action=move",{list_id:y,data:C},function(E){if(E.status==="ok"){$.isFunction(D)&&D.call()}else{alert(E.errors)}},"json")};var e=function(){var C=[];s.find(n).each(function(D){var E=$(this);C.push({id:E.data("id"),parent_id:E.data("parent-id"),sort:D,has_children:E.find(n).length?1:0})});return C};var d=function(C){this.find("label").first().append(u);$.post("?module=item&action=sort",{list_id:y,item_id:C?C:0,data:e()},function(D){if(D.status==="ok"){l()}else{alert(D.errors)}u.remove()},"json")};var a=function(F,C,E){var D=this;D.find(".pl-select-label").first().append(u);D.prop("disabled",true);$.post("?module=item&action=complete",{list_id:y,id:F,status:C},function(G){if(G.status==="ok"){$.pocketlist.updateAppCounter();D.find("ul.menu-v").find(":checkbox").prop("checked",C);D.find(".pl-done").prop("disabled",false);D.find(".pl-item-name").toggleClass("gray");setTimeout(function(){D.slideToggle(200,function(){D.show();if(C){b.append(D)}else{s.append(D);d.call(D)}g();$("#pl-complete-log-link").find("i").text($_("Show all "+b.find("[data-id]").length+" completed to-dos"));E&&$.isFunction(E)&&E.call(D)})},500)}else{alert(G.errors)}u.remove()},"json")};var t=function(){var C=s.find(".pl-item-selected").closest(n);if(C.length){C.each(function(){var F=$(this),E=F.prev(n);if(E.length){var G=parseInt(E.data("id"));F.data("parent-id",G);var D=E.find("ul.menu-v").first();if(D.length){D.append(F)}else{E.append($('<ul class="menu-v">').html(F))}d.call(F,parseInt(F.data("id")))}})}};var h=function(){var C=s.find(".pl-item-selected").closest(n);if(C.length){C.each(function(){var E=$(this),D=E.parents(n).first();if(D.length){var G=parseInt(D.data("parent-id"));E.data("parent-id",G);var F=E.nextAll(),H=E.find("ul.menu-v");if(!H.length){H=$('<ul class="menu-v">');E.append(H)}H.append(F);D.after(E);d.call(E,parseInt(E.data("id")))}})}};var o=function(D,E){var C=this.find('[class*="star"]');$.post("?module="+D+"&action=favorite",{id:E,status:C.hasClass("star-empty")?1:0},function(F){if(F.status==="ok"){C.toggleClass("star-empty star")}else{alert(F.errors)}},"json")};var g=function(){$("#pl-lists").find('[data-pl-list-id="'+y+'"]').find(".count").text(s.find("[data-id]").length)};var w=function(){if($.pocketlists_routing.getHash()=="#/todo/"&&$.pocketlists_routing.getHash().indexOf("/team/")>0){B.prependTo(s).slideDown(200).wrap('<li class="pl-new-item-wrapper">');f.focus()}};function A(){var F=$("#pl-list-content").offset().top;var E=$(window).scrollTop();var C=$(window).height();if($(".pl-details .fields form").height()>C){return}if(E>F){$(".pl-details").addClass("sticky");var D=$(document).height()-C-E;$(".pl-details").css("bottom",Math.max(0,16-D)+"px")}else{$(".pl-details").removeClass("sticky")}}w();if(q.length){q.focus();q.on("keydown",function(C){if(C.which===13){C.preventDefault();c.call(this,y)}})}k.on("click",function(C){C.preventDefault();C.stopPropagation();if(B.is(":visible")){B.slideUp(200,function(){B.detach();$(".pl-new-item-wrapper").remove()})}else{B.prependTo(s).slideDown(200).wrap('<li class="pl-new-item-wrapper">')}f.focus()});if($(".pl-list-empty").length){k.trigger("click")}function r(){f.css("height","auto");f.css("height",(f.get(0).scrollHeight-parseInt(f.css("padding-top"))-parseInt(f.css("padding-bottom")))+"px")}f.on("change cut keydown drop paste",function(){window.setTimeout(r,0)}).on("keydown",function(E){var D=$(this);if(!E.shiftKey&&E.which===13){E.preventDefault();var C=D.closest(".menu-v").find(n).first().data("parent-id");i.call(this,[{name:D.val().trim(),parent_id:C}])}else{if(E.which===27){B.slideUp(200,function(){B.detach();$(".pl-new-item-wrapper").remove()});f.val("")}}}).on("paste",function(E){var D=$(this).closest(".menu-v").find(n).first().data("parent-id");var C=this;setTimeout(function(){var F=f.val().split(/\n/);var I=[];if(F.length>1){for(var H=0;H<F.length;H++){var G=$.trim(F[H]);if(G){I.push({name:G,parent_id:D})}}i.call(C,I)}},100)});s.on("mouseenter",n+" > .pl-item",function(E){E.stopPropagation();var C=$(this);if(!C.find(B).length){var D=C.closest(n).find(".menu-v");C.find(".pl-select-label").append(z.show())}}).on("mouseleave",function(C){z.detach()});z.on("click",function(E){var C=$(this);var D=C.closest(n).find(".menu-v");if(D.length){D.find(".pl-item").first().before(B)}else{C.closest(n).find(".pl-item").first().after(B)}z.detach();B.slideDown(200);f.focus()});m.on("change",".pl-is-selected",function(G){var F=$(this),C=$("#pl-item-details"),D=C.is(":visible"),E=F.closest(".pl-item"),I=E.closest(n),H=E.hasClass("pl-item-selected");G.preventDefault();if(!I.find("#pl-item-add").length){if(!D&&!H){C.hide();m.find(".pl-item").removeClass("pl-item-selected");E.addClass("pl-item-selected");F.prop("checked",true)}else{if(!D){C.html(u).show();A();$.post("?module=item&action=details",{id:parseInt(I.data("id"))},function(J){C.html(J);v(C)});F.prop("checked",true)}else{C.hide().empty();m.find(".pl-item").removeClass("pl-item-selected");F.prop("checked",false)}}}});m.on("change",".pl-done",function(F){var E=$(this),D=E.closest(n),G=parseInt(D.data("id")),C=E.is(":checked")?1:0;a.call(D,G,C)});m.on("click",".pl-favorite",function(E){E.preventDefault();var D=$(this),C=D.closest(n),F=parseInt(C.data("id"));o.call(C,"item",F)});$(document).on("keydown",function(D){switch(D.which){case 9:if(D.shiftKey){h.call(this)}else{t.call(this)}break;case 27:if($("#pl-list-details").is(":visible")){$("#pl-list-details").hide().empty();$(".pl-list-title").removeData("pl-clicked")}if($("#pl-item-details").is(":visible")){$("#pl-item-details").hide().empty();var C=m.find(".pl-item-selected");C.removeClass("pl-item-selected").prop("checked",false)}break}});l();var v=function(D){var F=0;var E=function(){var G={changeMonth:true,changeYear:true,shortYearCutoff:2,dateShowWeek:false,showOtherMonths:true,selectOtherMonths:true,stepMonths:1,numberOfMonths:1,gotoCurrent:true,constrainInput:false,minDate:new Date()};D.find("#pl-item-due-datetime").datepicker(G);F=parseInt(D.find('input[name="item[id]"]').val());C()};var C=function(){D.find("form").on("submit",function(H){H.preventDefault();var G=$(this);G.find("#pl-item-details-save").after(u);$.post("?module=item&action=data",G.serialize(),function(I){$.pocketlist.updateAppCounter();u.remove();m.find('[data-id="'+F+'"] > .pl-item').replaceWith($(I).addClass("pl-item-selected"));D.hide().empty()});return false});D.find("#pl-item-details-cancel").on("click",function(G){G.preventDefault();D.hide().empty();$(".pl-list-title").removeData("pl-clicked")});D.find("#pl-item-priority a").on("click",function(G){G.preventDefault();$("#pl-item-priority").find("input").val($(this).data("pl-item-priority"));$(this).addClass("selected").siblings().removeClass("selected")});D.find('[data-pl-action="item-delete"]').on("click",function(G){G.preventDefault();$("#pl-dialog-delete-confirm").waDialog({height:"150px","min-height":"150px",width:"400px",onLoad:function(){var H=$(this)},onSubmit:function(H){$.post("?module=item&action=delete",{id:F,list_id:y},function(I){if(I.status==="ok"){m.find('[data-id="'+I.data.id+'"]').remove();D.find("#pl-item-details-cancel").trigger("click");H.trigger("close")}else{}},"json");return false}})});D.on("change","#pl-assigned-contact select",function(){var G=$(this).val();$("#pl-assigned-contact").find('[data-pl-contact-id="'+G+'"]').show().siblings().hide()})};E()};$(".pl-list-title").on("click",function(F){var C=$("#pl-list-details"),E=$(this),D=E.data("pl-clicked");if($(F.target).closest(".pl-done-label").length){return}if(D==1){C.html(u).show();A();E.data("pl-clicked",2);$.post("?module=list&action=details",{id:parseInt($("#pl-list-id").val())},function(G){C.html(G);j(C)})}else{if(D==2){E.removeData("pl-clicked");C.hide().empty()}else{E.data("pl-clicked",1)}}}).on("click",'[data-pl-action="list-delete"]',function(C){C.preventDefault();$("#pl-dialog-delete-confirm").waDialog({height:"150px","min-height":"150px",width:"400px",onLoad:function(){var D=$(this)},onSubmit:function(D){$.post("?module=list&action=delete",{list_id:y},function(E){if(E.status==="ok"){D.trigger("close");$.wa.setHash("#/pocket/1/")}else{}},"json");return false}})}).on("click",'[data-pl-action="list-archive"]',function(C){C.preventDefault();$.post("?module=list&action=archive",{list_id:y,archive:1},function(D){if(D.status==="ok"){$.wa.setHash("#/pocket/1/")}else{}},"json")}).on("click",'[data-pl-action="list-sort"]',function(C){C.preventDefault();$.post("?module=list&action=sort",{list_id:y},function(D){if(D.status==="ok"){$.pocketlists_routing.redispatch()}else{}},"json")}).on("click",'[data-pl-action="list-favorite"]',function(E){E.preventDefault();var D=$(this),C=D.closest(".pl-list-title");o.call(C,"list",C.find("#pl-list-id").val())});var j=function(F){var H=0;var E=F.find("#pl-list-icon-dialog").find("ul").data("pl-icons-path");var G=function(){D();H=parseInt(F.find('input[name="list[id]"]').val())};var D=function(){F.find("form").on("submit",function(J){J.preventDefault();var I=$(this);I.find("#pl-list-details-save").after(u);$.post("?module=list&action=save",I.serialize(),function(K){u.remove();if(K.status==="ok"){C();F.find(".success").show().delay(3000).hide()}else{F.find(".error").show().delay(3000).hide()}F.data("pl-clicked",1).hide()},"json");return false});F.find("#pl-list-details-cancel").on("click",function(I){I.preventDefault();F.hide().empty()});F.find("#pl-list-color a").on("click",function(I){I.preventDefault();$("#pl-list-color").find("input").val($(this).data("pl-list-color"));$(this).addClass("selected").siblings().removeClass("selected")});F.find("#pl-list-icon-change a").on("click",function(J){J.preventDefault();var I=$(this);$("#pl-list-icon-dialog").waDialog({onLoad:function(){var K=$(this);$("#pl-list-icon-dialog").on("click","a[data-pl-list-icon]",function(M){M.preventDefault();var L=$(this).data("pl-list-icon");F.find("#pl-list-icon-change").find("input").val($(this).data("pl-list-icon"));I.find("input").val(L);F.find("#pl-list-icon-change .listicon48").css("background-image","url("+E+L+")");K.trigger("close");return false})}})})};var C=function(){var J=F.find('input[name="list[name]"]').val(),I=F.find("[data-pl-list-color].selected").data("pl-list-color"),K=F.find('input[name="list[icon]"]').val();$("#pl-list-name").text(J);$("#pl-lists").find('[data-pl-list-id="'+H+'"]').removeClass().addClass("pl-"+I).find(".pl-list-name").text(J).end().find(".listicon48").css("background-image","url("+E+K+")");$(".pl-items").removeClass().addClass("pl-items pl-"+I)};G()};$("#pl-list-complete").on("click",function(C){C.stopPropagation();$("#pl-dialog-list-archive-complete-all").waDialog({height:"150px","min-height":"150px",width:"400px",onLoad:function(){var D=$(this);D.on("click","[data-pl-action]",function(G){G.preventDefault();var F=$(this),E=F.data("pl-action");F.after(u);if(E==="list-complete-all"){$.post("?module=item&action=complete",{list_id:y,status:1,id:-1},function(H){if(H.status==="ok"){D.trigger("close");$.pocketlists_routing.redispatch()}else{}},"json")}else{if(E==="list-archive"){$.post("?module=list&action=archive",{list_id:y,archive:1},function(H){if(H.status==="ok"){D.trigger("close");$.wa.setHash("#/pocket/"+x)}else{}},"json")}else{if(E==="cancel"){$("#pl-list-complete").prop("checked",false);D.trigger("close");u.remove()}}}})}})});$("#pl-complete-log-link").click(function(){$("#pl-complete-log").slideDown(200);$(this).slideUp(200);return false});$(window).scroll(function(){A()})}());