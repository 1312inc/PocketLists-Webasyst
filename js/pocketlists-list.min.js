(function(){var w=parseInt($("#pl-list-id").val()),v=parseInt($("#pl-pocket-id").val()),m=$("#pl-list-items"),q=$("#pl-undone-items > ul.menu-v"),b=$("#pl-complete-log > ul.menu-v"),s=$('<i class="icon16 loading">'),p=$("#pl-new-list-input"),y=$("#pl-item-add").detach(),f=y.find("textarea"),x=$('<div id="pl-item-add-wrapper-hover" style="display: none;">'),n="[data-parent-id]",k=$("#pl-item-add-link");var l=function(){$("#pl-undone-items ul.menu-v").sortable({item:n,connectWith:"ul.menu-v",placeholder:"pl-item-placeholder",tolerance:"pointer",stop:function(A,C){var z=C.item.parents(n).first(),B=z.length?parseInt(z.data("id")):0;C.item.data("parent-id",B);d.call(C.item,parseInt(C.item.data("id")))}})};var c=function(A){var z={name:$(this).val().trim(),type:"checklist",pocket_id:v};if(z.name){$(this).after(s);$.post("?module=list&action=update",{data:z,id:A},function(B){if(B.status==="ok"){if(w===-1){$.wa.setHash("#/pocket/"+v+"/list/"+B.data.id+"/")}}else{}},"json")}};var i=function(z){var A=$(this);A.after(s);$.post("?module=item&action=create",{list_id:w,data:z},function(C){var D=A.closest(n);var B=$(""+C+"");B.filter(n).last().find(".pl-item").first().after(y);if(D.length){D.after(B)}else{q.prepend(B)}s.remove();f.val("").trigger("focus");$(".pl-list-empty").removeClass("pl-list-empty");g();d.call(B)})};var o=function(z,A){$.post("?module=item&action=move",{list_id:w,data:z},function(B){if(B.status==="ok"){$.isFunction(A)&&A.call()}else{alert(B.errors)}},"json")};var e=function(){var z=[];q.find(n).each(function(A){var B=$(this);z.push({id:B.data("id"),parent_id:B.data("parent-id"),sort:A,has_children:B.find(n).length?1:0})});return z};var d=function(z){this.find("label").first().append(s);$.post("?module=item&action=sort",{list_id:w,item_id:z?z:0,data:e()},function(A){if(A.status==="ok"){l()}else{alert(A.errors)}s.remove()},"json")};var a=function(C,z,B){var A=this;A.find(".pl-select-label").first().append(s);A.prop("disabled",true);$.post("?module=item&action=complete",{list_id:w,id:C,status:z},function(D){if(D.status==="ok"){A.find("ul.menu-v").find(":checkbox").prop("checked",z);A.find(".pl-done").prop("disabled",false);A.find(".pl-item-name").toggleClass("gray");setTimeout(function(){A.slideToggle(200,function(){A.show();if(z){b.append(A)}else{q.append(A);d.call(A)}g();$("#pl-complete-log-link").find("i").text($_("Show all "+b.find("[data-id]").length+" completed to-dos"));B&&$.isFunction(B)&&B.call(A)})},500)}else{alert(D.errors)}s.remove()},"json")};var r=function(){var z=q.find(".pl-item-selected").closest(n);if(z.length){z.each(function(){var C=$(this),B=C.prev(n);if(B.length){var D=parseInt(B.data("id"));C.data("parent-id",D);var A=B.find("ul.menu-v").first();if(A.length){A.append(C)}else{B.append($('<ul class="menu-v">').html(C))}d.call(C,parseInt(C.data("id")))}})}};var h=function(){var z=q.find(".pl-item-selected").closest(n);if(z.length){z.each(function(){var B=$(this),A=B.parents(n).first();if(A.length){var D=parseInt(A.data("parent-id"));B.data("parent-id",D);var C=B.nextAll(),E=B.find("ul.menu-v");if(!E.length){E=$('<ul class="menu-v">');B.append(E)}E.append(C);A.after(B);d.call(B,parseInt(B.data("id")))}})}};var g=function(){$("#pl-lists").find('[data-pl-list-id="'+w+'"]').find(".count").text(q.find("[data-id]").length)};var u=function(){if($.pocketlists_routing.getHash()=="#/todo/"&&$.pocketlists_routing.getHash().indexOf("/team/")>0){y.prependTo(q).slideDown(200).wrap('<li class="pl-new-item-wrapper">');f.focus()}};u();if(p.length){p.focus();p.on("keydown",function(z){if(z.which===13){z.preventDefault();c.call(this,w)}})}k.on("click",function(z){z.preventDefault();z.stopPropagation();if(y.is(":visible")){y.slideUp(200,function(){y.detach();$(".pl-new-item-wrapper").remove()})}else{y.prependTo(q).slideDown(200).wrap('<li class="pl-new-item-wrapper">')}f.focus()});if($(".pl-list-empty").length){k.trigger("click")}f.on("keydown",function(B){var A=$(this);if(!B.shiftKey&&B.which===13){B.preventDefault();var z=A.closest(".menu-v").find(n).first().data("parent-id");i.call(this,[{name:A.val().trim(),parent_id:z}])}else{if(B.which===27){y.slideUp(200,function(){y.detach();$(".pl-new-item-wrapper").remove()});f.val("")}}}).on("paste",function(B){var A=$(this).closest(".menu-v").find(n).first().data("parent-id");var z=this;setTimeout(function(){var C=f.val().split(/\n/);var F=[];if(C.length>1){for(var E=0;E<C.length;E++){var D=$.trim(C[E]);if(D){F.push({name:D,parent_id:A})}}i.call(z,F)}},100)});q.on("mouseenter",n+" > .pl-item",function(B){B.stopPropagation();var z=$(this);if(!z.find(y).length){var A=z.closest(n).find(".menu-v");if(A.length){A.find(".pl-item").first().before(x.show())}else{z.after(x.show())}}}).on("mouseleave",function(z){x.detach()});x.on("click",function(z){x.after(y);x.detach();y.slideDown(200);f.focus()});m.on("change",".pl-is-selected",function(D){var C=$(this),z=$("#pl-item-details"),A=z.is(":visible"),B=C.closest(".pl-item"),F=B.closest(n),E=B.hasClass("pl-item-selected");D.preventDefault();if(!F.find("#pl-item-add").length){if(!A&&!E){z.hide();m.find(".pl-item").removeClass("pl-item-selected");B.addClass("pl-item-selected");C.prop("checked",true)}else{if(!A){z.html(s).show();$.post("?module=item&action=details",{id:parseInt(F.data("id"))},function(G){z.html(G);t(z)});C.prop("checked",true)}else{z.hide().empty();m.find(".pl-item").removeClass("pl-item-selected");C.prop("checked",false)}}}});m.on("change",".pl-done",function(C){var B=$(this),A=B.closest(n),D=parseInt(A.data("id")),z=B.is(":checked")?1:0;a.call(A,D,z)});$(document).on("keydown",function(A){switch(A.which){case 9:if(A.shiftKey){h.call(this)}else{r.call(this)}break;case 27:if($("#pl-list-details").is(":visible")){$("#pl-list-details").hide().empty();$(".pl-list-title").removeData("pl-clicked")}if($("#pl-item-details").is(":visible")){$("#pl-item-details").hide().empty();var z=m.find(".pl-item-selected");z.removeClass("pl-item-selected").prop("checked",false)}break}});l();var t=function(A){var C=0;var B=function(){var D={changeMonth:true,changeYear:true,shortYearCutoff:2,dateShowWeek:false,showOtherMonths:true,selectOtherMonths:true,stepMonths:1,numberOfMonths:1,gotoCurrent:true,constrainInput:false,minDate:new Date()};A.find("#pl-item-due-datetime").datepicker(D);C=parseInt(A.find('input[name="item[id]"]').val());z()};var z=function(){A.find("form").on("submit",function(E){E.preventDefault();var D=$(this);D.find("#pl-item-details-save").after(s);$.post("?module=item&action=data",D.serialize(),function(F){s.remove();m.find('[data-id="'+C+'"] > .pl-item').replaceWith($(F).addClass("pl-item-selected"));A.hide().empty()});return false});A.find("#pl-item-details-cancel").on("click",function(D){D.preventDefault();A.hide().empty();$(".pl-list-title").removeData("pl-clicked")});A.find("#pl-item-priority a").on("click",function(D){D.preventDefault();$("#pl-item-priority").find("input").val($(this).data("pl-item-priority"));$(this).addClass("selected").siblings().removeClass("selected")});A.find('[data-pl-action="item-delete"]').on("click",function(D){D.preventDefault();$("#pl-dialog-delete-confirm").waDialog({height:"150px","min-height":"150px",width:"400px",onLoad:function(){var E=$(this)},onSubmit:function(E){$.post("?module=item&action=delete",{id:C,list_id:w},function(F){if(F.status==="ok"){m.find('[data-id="'+F.data.id+'"]').remove();A.find("#pl-item-details-cancel").trigger("click");E.trigger("close")}else{}},"json");return false}})});A.on("change","#pl-assigned-contact select",function(){var D=$(this).val();$("#pl-assigned-contact").find('[data-pl-contact-id="'+D+'"]').show().siblings().hide()})};B()};$(".pl-list-title").on("click",function(C){var z=$("#pl-list-details"),B=$(this),A=B.data("pl-clicked");if($(C.target).closest(".pl-done-label").length){return}if(A==1){z.html(s).show();B.data("pl-clicked",2);$.post("?module=list&action=details",{id:parseInt($("#pl-list-id").val())},function(D){z.html(D);j(z)})}else{if(A==2){B.removeData("pl-clicked");z.hide().empty()}else{B.data("pl-clicked",1)}}}).on("click",'[data-pl-action="list-delete"]',function(z){z.preventDefault();$("#pl-dialog-delete-confirm").waDialog({height:"150px","min-height":"150px",width:"400px",onLoad:function(){var A=$(this)},onSubmit:function(A){$.post("?module=list&action=delete",{list_id:w},function(B){if(B.status==="ok"){A.trigger("close");$.wa.setHash("#/pocket/1/")}else{}},"json");return false}})}).on("click",'[data-pl-action="list-archive"]',function(z){z.preventDefault();$.post("?module=list&action=archive",{list_id:w,archive:1},function(A){if(A.status==="ok"){$.wa.setHash("#/pocket/1/")}else{}},"json")}).on("click",'[data-pl-action="list-sort"]',function(z){z.preventDefault();$.post("?module=list&action=sort",{list_id:w},function(A){if(A.status==="ok"){$.pocketlists_routing.redispatch()}else{}},"json")});var j=function(C){var E=0;var B=C.find("#pl-list-icon-dialog").find("ul").data("pl-icons-path");var D=function(){A();E=parseInt(C.find('input[name="list[id]"]').val())};var A=function(){C.find("form").on("submit",function(G){G.preventDefault();var F=$(this);F.find("#pl-list-details-save").after(s);$.post("?module=list&action=save",F.serialize(),function(H){s.remove();if(H.status==="ok"){z();C.find(".success").show().delay(3000).hide()}else{C.find(".error").show().delay(3000).hide()}C.data("pl-clicked",1).hide()},"json");return false});C.find("#pl-list-details-cancel").on("click",function(F){F.preventDefault();C.hide().empty()});C.find("#pl-list-color a").on("click",function(F){F.preventDefault();$("#pl-list-color").find("input").val($(this).data("pl-list-color"));$(this).addClass("selected").siblings().removeClass("selected")});C.find("#pl-list-icon-change a").on("click",function(G){G.preventDefault();var F=$(this);$("#pl-list-icon-dialog").waDialog({onLoad:function(){var H=$(this);$("#pl-list-icon-dialog").on("click","a[data-pl-list-icon]",function(J){J.preventDefault();var I=$(this).data("pl-list-icon");C.find("#pl-list-icon-change").find("input").val($(this).data("pl-list-icon"));F.find("input").val(I);C.find("#pl-list-icon-change .listicon48").css("background-image","url("+B+I+")");H.trigger("close");return false})}})})};var z=function(){var G=C.find('input[name="list[name]"]').val(),F=C.find("[data-pl-list-color].selected").data("pl-list-color"),H=C.find('input[name="list[icon]"]').val();$("#pl-list-name").text(G);$("#pl-lists").find('[data-pl-list-id="'+E+'"]').removeClass().addClass("pl-"+F).find(".pl-list-name").text(G).end().find(".listicon48").css("background-image","url("+B+H+")");$(".pl-items").removeClass().addClass("pl-items pl-"+F)};D()};$("#pl-list-complete").on("click",function(z){z.stopPropagation();$("#pl-dialog-list-archive-complete-all").waDialog({height:"150px","min-height":"150px",width:"400px",onLoad:function(){var A=$(this);A.on("click","[data-pl-action]",function(D){D.preventDefault();var C=$(this),B=C.data("pl-action");C.after(s);if(B==="list-complete-all"){$.post("?module=item&action=complete",{list_id:w,status:1,id:-1},function(E){if(E.status==="ok"){A.trigger("close");$.pocketlists_routing.redispatch()}else{}},"json")}else{if(B==="list-archive"){$.post("?module=list&action=archive",{list_id:w,archive:1},function(E){if(E.status==="ok"){A.trigger("close");$.wa.setHash("#/pocket/"+v)}else{}},"json")}else{if(B==="cancel"){$("#pl-list-complete").prop("checked",false);A.trigger("close");s.remove()}}}})}})});$("#pl-complete-log-link").click(function(){$("#pl-complete-log").slideDown(200);$(this).slideUp(200);return false})}());