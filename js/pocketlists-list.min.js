(function(){var u=parseInt($("#pl-list-id").val()),t=parseInt($("#pl-pocket-id").val()),l=$("#pl-list-items"),p=$("#pl-undone-items > ul.menu-v"),b=$("#pl-complete-log > ul.menu-v"),r=$('<i class="icon16 loading">'),o=$("#pl-new-list-input"),w=$("#pl-item-add").detach(),f=w.find("textarea"),v=$('<div id="pl-item-add-wrapper-hover" style="display: none;">'),m="[data-parent-id]",j=$("#pl-item-add-link");var k=function(){$("#pl-undone-items ul.menu-v").sortable({item:m,connectWith:"ul.menu-v",placeholder:"pl-item-placeholder",tolerance:"pointer",stop:function(y,A){var x=A.item.parents(m).first(),z=x.length?parseInt(x.data("id")):0;A.item.data("parent-id",z);d.call(A.item,parseInt(A.item.data("id")))}})};var c=function(y){var x={name:$(this).val().trim(),type:"checklist",pocket_id:t};if(x.name){$(this).after(r);$.post("?module=list&action=update",{data:x,id:y},function(z){if(z.status==="ok"){if(u===-1){$.wa.setHash("#/pocket/"+t+"/list/"+z.data.id+"/")}}else{}},"json")}};var h=function(x){var y=$(this);y.after(r);$.post("?module=item&action=create",{list_id:u,data:x},function(A){var B=y.closest(m);var z=$(""+A+"");z.filter(m).last().find(".pl-item").first().after(w);if(B.length){B.after(z)}else{p.prepend(z)}r.remove();f.val("").trigger("focus");$(".pl-list-empty").removeClass("pl-list-empty");d.call(z)})};var n=function(x,y){$.post("?module=item&action=move",{list_id:u,data:x},function(z){if(z.status==="ok"){$.isFunction(y)&&y.call()}else{alert(z.errors)}},"json")};var e=function(){var x=[];p.find(m).each(function(y){var z=$(this);x.push({id:z.data("id"),parent_id:z.data("parent-id"),sort:y,has_children:z.find(m).length?1:0})});return x};var d=function(x){this.find("label").first().append(r);$.post("?module=item&action=sort",{list_id:u,item_id:x?x:0,data:e()},function(y){if(y.status==="ok"){k()}else{alert(y.errors)}r.remove()},"json")};var a=function(z,x,y){this.find("label").first().append(r);this.prop("disabled",true);$.post("?module=item&action=complete",{list_id:u,id:z,status:x},function(A){if(A.status==="ok"){y&&$.isFunction(y)&&y.call()}else{alert(A.errors)}r.remove()},"json")};var q=function(){var x=p.find(".pl-item-selected").closest(m);if(x.length){x.each(function(){var A=$(this),z=A.prev(m);if(z.length){var B=parseInt(z.data("id"));A.data("parent-id",B);var y=z.find("ul.menu-v").first();if(y.length){y.append(A)}else{z.append($('<ul class="menu-v">').html(A))}d.call(A,parseInt(A.data("id")))}})}};var g=function(){var x=p.find(".pl-item-selected").closest(m);if(x.length){x.each(function(){var z=$(this),y=z.parents(m).first();if(y.length){var B=parseInt(y.data("parent-id"));z.data("parent-id",B);var A=z.nextAll(),C=z.find("ul.menu-v");if(!C.length){C=$('<ul class="menu-v">');z.append(C)}C.append(A);y.after(z);d.call(z,parseInt(z.data("id")))}})}};if(o.length){o.focus();o.on("keydown",function(x){if(x.which===13){x.preventDefault();c.call(this,u)}})}j.on("click",function(x){x.preventDefault();x.stopPropagation();if(w.is(":visible")){w.slideUp(200,function(){w.detach();$(".pl-new-item-wrapper").remove()})}else{w.prependTo(p).slideDown(200).wrap('<li class="pl-new-item-wrapper">')}f.focus()});if($(".pl-list-empty").length){j.trigger("click")}f.on("keydown",function(z){var y=$(this);if(!z.shiftKey&&z.which===13){z.preventDefault();var x=y.closest(".menu-v").find(m).first().data("parent-id");h.call(this,[{name:y.val().trim(),parent_id:x}])}else{if(z.which===27){w.slideUp(200,function(){w.detach();$(".pl-new-item-wrapper").remove()});f.val("")}}}).on("paste",function(z){var y=$(this).closest(".menu-v").find(m).first().data("parent-id");var x=this;setTimeout(function(){var A=f.val().split(/\n/);var D=[];if(A.length>1){for(var C=0;C<A.length;C++){var B=$.trim(A[C]);if(B){D.push({name:B,parent_id:y})}}h.call(x,D)}},100)});p.on("mouseenter",m+" > .pl-item",function(z){z.stopPropagation();var x=$(this);if(!x.find(w).length){var y=x.closest(m).find(".menu-v");if(y.length){y.find(".pl-item").first().before(v.show())}else{x.after(v.show())}}}).on("mouseleave",function(x){v.detach()});v.on("click",function(x){v.after(w);v.detach();w.slideDown(200);f.focus()});l.on("change",".pl-is-selected",function(B){var A=$(this),x=$("#pl-item-details"),y=x.is(":visible"),z=A.closest(".pl-item"),D=z.closest(m),C=z.hasClass("pl-item-selected");B.preventDefault();if(!y&&!C){x.hide();l.find(".pl-item").removeClass("pl-item-selected");z.addClass("pl-item-selected");A.prop("checked",true)}else{if(!y){x.html(r).show();$.post("?module=item&action=details",{id:parseInt(D.data("id"))},function(E){x.html(E);s(x)});A.prop("checked",true)}else{x.hide();l.find(".pl-item").removeClass("pl-item-selected");A.prop("checked",false)}}});l.on("change",".pl-done",function(A){var z=$(this),y=z.closest(m),B=parseInt(y.data("id")),x=z.is(":checked")?1:0;y.find("ul.menu-v .pl-done").prop("checked",x);a.call(y,B,x,function(){z.prop("disabled",false);y.slideToggle(200,function(){y.show();if(x){b.append(y)}else{p.append(y);d.call(y)}})})});$(document).on("keydown",function(y){switch(y.which){case 39:q.call(this);break;case 9:if(y.shiftKey){g.call(this)}else{q.call(this)}break;case 37:g.call(this);break;case 27:if($("#pl-list-details").is(":visible")){$("#pl-list-details").hide()}if($("#pl-item-details").is(":visible")){$("#pl-item-details").hide();var x=l.find(".pl-item-selected");x.removeClass("pl-item-selected").prop("checked",false)}break}});k();var s=function(y){var A=0;var z=function(){var B={changeMonth:true,changeYear:true,shortYearCutoff:2,dateShowWeek:false,showOtherMonths:true,selectOtherMonths:true,stepMonths:1,numberOfMonths:1,gotoCurrent:true,constrainInput:false,minDate:new Date()};y.find("#pl-item-due-datetime").datepicker(B);x();A=parseInt(y.find('input[name="item[id]"]').val())};var x=function(){y.on("submit","form",function(C){C.preventDefault();var B=$(this);B.find("#pl-item-details-save").after(r);$.post("?module=item&action=data",B.serialize(),function(D){r.remove();l.find('[data-id="'+A+'"] .pl-item').first().replaceWith($(D).addClass("pl-item-selected"))});return false});y.on("click","#pl-item-details-cancel",function(B){B.preventDefault();y.hide()});y.on("click","#pl-item-priority a",function(B){B.preventDefault();$("#pl-item-priority").find("input").val($(this).data("pl-item-priority"));$(this).addClass("selected").siblings().removeClass("selected")})};z()};$(".pl-list-title").on("click",function(y){var x=$("#pl-list-details");x.html(r).toggle();$.post("?module=list&action=details",{id:parseInt($("#pl-list-id").val())},function(z){x.html(z);i(x)})});var i=function(z){var B=0;var A=function(){y();B=parseInt(z.find('input[name="list[id]"]').val())};var y=function(){z.on("submit","form",function(D){D.preventDefault();var C=$(this);C.find("#pl-list-details-save").after(r);$.post("?module=list&action=save",C.serialize(),function(E){r.remove();if(E.status==="ok"){x();z.find(".success").show().delay(3000).hide()}else{z.find(".error").show().delay(3000).hide()}},"json");return false});z.on("click","#pl-list-details-cancel",function(C){C.preventDefault();z.hide()});z.on("click","#pl-list-color a",function(C){C.preventDefault();$("#pl-list-color").find("input").val($(this).data("pl-list-color"));$(this).addClass("selected").siblings().removeClass("selected")})};var x=function(){var D=z.find('input[name="list[name]"]').val(),C=z.find("[data-pl-list-color].selected").data("pl-list-color");$("#pl-list-name").text(D);$("#pl-lists").find('[data-pl-list-id="'+B+'"]').removeClass().addClass("pl-"+C).find(".pl-list-name").text(D)};A()};$("#pl-list-complete").on("click",function(x){x.stopPropagation();alert("waDialog с предложением либо зачекать все айтемы как выполненные с дополнительным чекбоксом “отправить этот список в архив”")});$("#pl-complete-log-link").click(function(){$("#pl-complete-log").slideDown(200);$(this).slideUp(200);return false})}());