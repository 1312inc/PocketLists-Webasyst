(function(b){b.pocketlists.List=function(j,s){var g=j.find("#pl-new-list-input"),h=parseInt(j.find("#pl-list-id").val()),p=parseInt(b("#pl-pocket-id").val()),c=b("#pl-dialog-delete-list-confirm"),e=b("#pl-dialog-list-archive-complete-all"),d={archive:false};var n=(function(w){var v=null;var o=function(){b.pocketlists.scrollToTop(200,80);w.html(b.pocketlists.$loading).show().animate({right:"0%"},200);a();b.post("?module=list&action=details",{id:h},function(z){w.html(z);y()})};var u=function(){w.animate({right:"-100%"},200,function(){w.hide().empty()})};var t=function(z){j.find("#pl-list-name").text(z.name);if(z.due_date||z.due_datetime){var A="pl-due-someday";if(z.calc_priority==1){A="pl-due-tomorrow"}else{if(z.calc_priority==2){A="pl-due-today"}else{if(z.calc_priority==3){A="pl-due-overdue"}}}j.find(".pl-list-due").removeClass().addClass("pl-list-due "+A).text(z.due_datetime?z.due_datetime:z.due_date).show()}else{j.find(".pl-list-due").hide()}b("#pl-lists").find('[data-pl-list-id="'+h+'"]').removeClass().addClass("pl-"+z.color).find(".pl-list-name").text(z.name).end().find(".listicon48").css("background-image","url("+v+z.icon+")");b(".pl-items").removeClass().addClass("pl-items pl-"+z.color)};var y=function(){var z={changeMonth:true,changeYear:true,shortYearCutoff:2,dateShowWeek:false,showOtherMonths:true,selectOtherMonths:true,stepMonths:1,numberOfMonths:1,gotoCurrent:true,constrainInput:false};w.find("#pl-list-due-datetime").datepicker(z);v=w.find("#pl-list-icon-dialog").find("ul").data("pl-icons-path")};var x=function(){if(w.data("pl-ListDetails")){return}w.data("pl-ListDetails",true);w.on("submit","form",function(A){A.preventDefault();var z=b(this);z.find("#pl-list-details-save").removeClass("yellow").after(b.pocketlists.$loading);b.post("?module=list&action=save",z.serialize(),function(B){b.pocketlists.$loading.remove();if(B.status==="ok"){t(B.data);u()}else{w.find(".error").show().delay(3000).hide()}},"json");return false}).on("click","#pl-list-details-cancel",function(z){z.preventDefault();u()}).on("click","#pl-list-color a",function(z){z.preventDefault();b("#pl-list-color").find("input").val(b(this).data("pl-list-color")).trigger("change");b(this).addClass("selected").siblings().removeClass("selected")}).on("click","#pl-list-due-datetime-set",function(A){A.preventDefault();var z=b(this);z.hide().siblings().show().filter("select").prop("disabled",false)}).on("click","#pl-list-due-datetime-clear",function(A){A.preventDefault();var z=b(this);z.hide().siblings().show().filter("select").hide().prop("disabled",true)}).on("click","#pl-list-icon-change a",function(z){z.preventDefault();b("#pl-list-icon-dialog").waDialog({onLoad:function(){var A=b(this);b("#pl-list-icon-dialog").on("click","a[data-pl-list-icon]",function(D){D.preventDefault();var B=b(this).data("pl-list-icon"),C=b(this);w.find("#pl-list-icon-change").find("input").val(b(this).data("pl-list-icon"));C.find("input").val(B);w.find("#pl-list-icon-change .listicon48").css("background-image","url("+v+B+")");w.find("#pl-list-details-save").addClass("yellow");A.trigger("close");return false})}})}).on("change paste keyup",":input",function(){w.find("#pl-list-details-save").addClass("yellow")}).on("show.pl2",o).on("hide.pl2",u);b(window).scroll(function(){a()})};x();return{$el:w,trigger:function(z,A){this.$el&&this.$el.trigger(z,A)},isVisible:function(){return this.$el?this.$el.is(":visible"):false}}}(b("#pl-list-details")));var r=function(u){var o=g.val().trim();if(o.length){var t={name:g.val().trim(),type:"checklist",pocket_id:p};if(t.name){b.post("?module=list&action=update",{data:t,id:u},function(v){if(v.status==="ok"){if(h===-1){b.wa.setHash("#/pocket/"+p+"/list/"+v.data.id+"/")}}else{}},"json")}}};var l=function(){var o=j.find('[class*="star"]');b.post("?module=list&action=favorite",{id:h,status:o.hasClass("star-empty")?1:0},function(t){if(t.status==="ok"){o.toggleClass("star-empty star")}else{alert(t.errors)}},"json")};var m=function(){c.waDialog({height:"150px","min-height":"150px",width:"400px",onLoad:function(){},onSubmit:function(o){b.post("?module=list&action=delete",{list_id:h},function(t){if(t.status==="ok"){o.trigger("close");b.wa.setHash("#/pocket/1/")}else{}},"json");return false}})};var f=function(){b.post("?module=list&action=archive",{list_id:h,archive:1},function(o){if(o.status==="ok"){b.wa.setHash("#/pocket/1/")}else{}},"json")};var k=function(){b.post("?module=list&action=sort",{list_id:h},function(o){if(o.status==="ok"){b.pocketlists_routing.redispatch()}else{}},"json")};var i=function(){j.removeData("pl-clicked")};var q=function(){d=b.extend({},s);if(g.length){g.focus();g.on("keydown",function(o){g.data("pl-can-add",true);if(o.which===13&&g.data("pl-can-add")){o.preventDefault();r(h)}if(o.which===27){g.data("pl-can-add",false).val("")}}).on("blur",function(o){g.data("pl-can-add")&&r(h)})}if(d.archive){j.find(":checkbox").prop("disabled",true)}j.on("click",function(t){if(!d.archive){var o=j.data("pl-clicked");if(b(t.target).closest(".pl-done-label").length){return}if(o==1){j.data("pl-clicked",2);b.pocketlists.scrollToTop(200,80);n.trigger("show.pl2")}else{if(o==2){n.trigger("hide.pl2");i()}else{j.data("pl-clicked",1)}}}}).on("click",'[data-pl-action="list-delete"]',function(o){o.preventDefault();m()}).on("click",'[data-pl-action="list-archive"]',function(o){o.preventDefault();f()}).on("click",'[data-pl-action="list-sort"]',function(o){o.preventDefault();k()}).on("click",'[data-pl-action="list-favorite"]',function(o){o.preventDefault();l()}).on("click","#pl-list-complete",function(o){o.stopPropagation();e.waDialog({height:"150px","min-height":"150px",width:"400px",onLoad:function(){var t=b(this);t.on("click","[data-pl-action]",function(w){w.preventDefault();var v=b(this),u=v.data("pl-action");v.after(b.pocketlists.$loading);if(u==="list-complete-all"){b.post("?module=list&action=complete",{list_id:h,status:1},function(x){if(x.status==="ok"){t.trigger("close");b.pocketlists_routing.redispatch()}else{}},"json")}else{if(u==="list-archive"){b.post("?module=list&action=archive",{list_id:h,archive:1},function(x){if(x.status==="ok"){t.trigger("close");b.wa.setHash("#/pocket/"+p)}else{}},"json")}else{if(u==="cancel"){b("#pl-list-complete").prop("checked",false);t.trigger("close");b.pocketlists.$loading.remove()}}}})}})}).on("click",'[data-pl-action="list-unarchive"]',function(o){o.preventDefault();b.post("?module=list&action=archive",{list_id:h,archive:0},function(t){if(t.status==="ok"){b.wa.setHash("#/pocket/"+p+"/list/"+h+"/")}else{}},"json")}).on("deleteList.pl2",m).on("deselectList.pl2",i);b(document).on("keydown",function(o){switch(o.which){case 27:n.isVisible()&&n.trigger("hide.pl2");break}})};q();return{$el:j,list_details:n,list_id:h,pocket_id:p}};b.pocketlists.Items=function(s,l){var w=s.find("#pl-undone-items > ul.menu-v"),x=b("#pl-undone-items ul.menu-v"),L=s.find("#pl-complete-log"),f=L.find("ul.menu-v").first(),I=b("#pl-item-add").detach(),m=I.find("textarea"),G=b('<div id="pl-item-add-wrapper-hover" style="display: none;">'),t="[data-parent-id]",q=b("#pl-item-add-link"),F=b("#pl-complete-log-link"),c=s.find("#pl-empty-list-msg"),H=null,v={enableAddLinkOnHover:true,enableChangeLevel:true,enableSortItems:true,list:null,assignUser:null,showMessageOnEmptyList:false,dueDate:"",archive:false};var e=function(){if(v.enableSortItems){x.sortable({item:t,distance:5,connectWith:"ul.menu-v",placeholder:"pl-item-placeholder",tolerance:"pointer",start:function(M,o){o.placeholder.height(o.helper.outerHeight())},stop:function(M,O){var o=O.item.parents(t).first(),N=o.length?parseInt(o.data("id")):0;O.item.data("parent-id",N);g(parseInt(O.item.data("id")))}})}};var E=function(o,O){var N=b(this);if(v.dueDate){b.each(o,function(P){o[P]["due_date"]=v.dueDate})}var M=N.closest(".pl-item").find(".pl-done-label span").addClass("transparent").html(b.pocketlists.$loading);b.post("?module=item&action=create",{list_id:v.list?v.list.list_id:0,data:o,assigned_contact_id:v.assignUser?v.assignUser:false},function(Q){b.pocketlists.updateAppCounter();b.pocketlists.$loading.remove();M.removeClass("transparent");var R=N.closest(t);var P=b(""+Q+"");m.data("can_blur",false);if(R.length){if(!R.parents(t).length||I.prev(".pl-item").length){R.after(P)}else{R.before(P)}}else{w.prepend(P)}P.filter(t).last().find(".pl-item").first().after(I);m.val("").trigger("focus").css("height","auto").data("can_blur",true);b.isFunction(O)&&O.call(N);i();k();g()})};var h=function(o,M){b.post("?module=item&action=data",o,function(Q){b.pocketlists.updateAppCounter();b.pocketlists.$loading.remove();z(Q);if(v.list){var P=0,O=0,N="";b.each(d(),function(){P=Math.max(P,this.priority)});var R=v.list.$el.find(".pl-list-due");if(R.length){switch(R.attr("class").match(/pl-list-due\s(pl-.*)/)[1]){case"pl-due-tomorrow":O=1;break;case"pl-due-today":O=2;break;case"pl-due-overdue":O=3;break}}switch(Math.max(P,O)){case 1:N=" indicator green";break;case 2:N=" indicator yellow";break;case 3:N=" indicator red";break}b("#pl-lists").find('[data-pl-list-id="'+v.list.list_id+'"] span.count').removeClass().addClass("count"+N)}b.isFunction(M)&&M.call()})};var d=function(){var o=[];w.find(t).each(function(O){var P=b(this),M=P.find(".pl-done").length?P.find(".pl-done").attr("class").match(/pl-done\s(pl-.*)/):null,N=0;if(M&&M.length>0){switch(M[1]){case"pl-red":N=3;break;case"pl-yellow":N=2;break;case"pl-green":N=1;break}}o.push({id:P.data("id"),parent_id:P.data("parent-id"),sort:O,has_children:P.find(t).length?1:0,priority:N})});console.dir(o);return o};var g=function(o){if(v.enableSortItems&&v.list){b.post("?module=item&action=sort",{list_id:v.list.list_id,item_id:o?o:0,data:d()},function(M){if(M.status==="ok"){e()}else{alert(M.errors)}},"json")}};var J=function(M,o,O){var N=parseInt(M.data("id"));M.prop("disabled",true);b.post("?module=item&action=complete",{id:N,status:o},function(P){if(P.status==="ok"){b.pocketlists.updateAppCounter();M.find("ul.menu-v").find(":checkbox").prop("checked",o);M.find(".pl-done").prop("disabled",false);M.find(".pl-item-name").toggleClass("gray");setTimeout(function(){M.slideToggle(200,function(){M.show();if(o){f.prepend(M)}else{w.append(M);g()}k();F.show().find("i").text($_("Show all "+f.find("[data-id]").length+" completed to-dos"));n();O&&b.isFunction(O)&&O.call(M)})},800)}else{alert(P.errors)}b.pocketlists.$loading.remove()},"json")};var B=function(o){if(v.enableChangeLevel&&H){o.preventDefault();o.stopPropagation();H.each(function(){var O=b(this),N=O.prev(t);if(N.length){var P=parseInt(N.data("id"));O.data("parent-id",P);var M=N.find("ul.menu-v").first();if(M.length){M.append(O)}else{N.append(b('<ul class="menu-v">').html(O))}g(parseInt(O.data("id")))}})}};var A=function(o){if(v.enableChangeLevel&&H){o.preventDefault();o.stopPropagation();H.each(function(){var N=b(this),M=N.parents(t).first();if(M.length){var P=parseInt(M.data("parent-id"));N.data("parent-id",P);var O=N.nextAll(),Q=N.find("ul.menu-v");if(!Q.length){Q=b('<ul class="menu-v">');N.append(Q)}Q.append(O);M.after(N);g(parseInt(N.data("id")))}})}};var C=function(o){var M=o.find('[class*="star"]'),N=parseInt(o.data("id"));b.post("?module=item&action=favorite",{id:N,status:M.hasClass("star-empty")?1:0},function(O){if(O.status==="ok"){M.toggleClass("star-empty star")}else{alert(O.errors)}},"json")};var p=function(o){H=o;if(H){var M=H.find(".pl-item").first();s.find(".pl-item").removeClass("pl-item-selected");M.addClass("pl-item-selected");H.prop("checked",true)}};var r=function(){if(H){s.find(".pl-item").removeClass("pl-item-selected");H.prop("checked",false);H=null}};var K=function(o){s.find('[data-id="'+o+'"]').remove()};var z=function(o){if(H){H.find(".pl-item").first().replaceWith(b(o).addClass("pl-item-selected"))}};var k=function(){if(v.list&&v.list.list_id){b("#pl-lists").find('[data-pl-list-id="'+v.list.list_id+'"]').find(".count").text(w.find("[data-id]").length)}};var j=function(){return !d().length};var n=function(){j()&&v.showMessageOnEmptyList&&c.show()};var i=function(){v.showMessageOnEmptyList&&c.hide()};var u=function(){var M=function(){m.css("height","auto");m.css("height",(m.get(0).scrollHeight-parseInt(m.css("padding-top"))-parseInt(m.css("padding-bottom")))+"px")};var o=function(){I.slideUp(200,function(){I.detach();b(".pl-new-item-wrapper").remove();m.val("");n()})};var N=function(){q.on("click",function(Q){Q.preventDefault();Q.stopPropagation();function P(){i();I.prependTo(w).slideDown(200,function(){m.focus()}).wrap('<li class="pl-new-item-wrapper">')}if(I.is(":visible")){I.slideUp(200,function(){I.detach();b(".pl-new-item-wrapper").remove();P()})}else{P()}});if(j()&&!v.showMessageOnEmptyList){q.trigger("click")}m.on("change cut keydown drop paste",function(){window.setTimeout(M,0)}).on("keydown",function(S){var R=b(this);R.data("can_blur",true);if(!S.shiftKey&&S.which===13){S.preventDefault();var Q=R.closest(".menu-v").find(t).first().data("parent-id"),P=R.val().trim();if(P){E.call(this,[{name:P,parent_id:Q}])}}else{if(S.which===27){R.data("can_blur",false);o()}}}).on("paste",function(){var P=this,Q=b(this).closest(".menu-v").find(t).first().data("parent-id");if(!b(this).val().length){setTimeout(function(){var R=m.val().split(/\n/);var U=[];if(R.length>1){for(var T=0;T<R.length;T++){var S=b.trim(R[T]);if(S){U.push({name:S,parent_id:Q})}}E.call(P,U)}},100)}}).on("blur",function(){var S=b(this),R=S.closest(".menu-v").find(t).first().data("parent-id"),Q=S.val().trim(),P=S.data("can_blur");if(P){if(Q){E.call(this,[{name:Q,parent_id:R}],o)}else{o()}}});var O=null;if(v.enableAddLinkOnHover){w.on("mouseenter",t+" > .pl-item",function(Q){Q.stopPropagation();var P=b(this);O=setTimeout(function(){if(!P.find(I).length){P.find(".pl-select-label").append(G.show())}},500)}).on("mouseleave",t+" > .pl-item",function(){clearTimeout(O);G.detach()});G.on("click",function(){var P=b(this);var Q=P.closest(t).find(".menu-v");m.data("can_blur",false);if(Q.length){Q.find(".pl-item").first().before(I)}else{P.closest(t).find(".pl-item").first().after(I)}G.detach();I.slideDown(200);m.focus();m.data("can_blur",true)})}};N()};var y=(function(O){var R=0,o=b("#pl-dialog-delete-item-confirm");var N=function(){O.animate({right:"-100%"},200,function(){O.hide().empty()});R=0;s.trigger("deselectItem.pl2")};var M=function(S){R=S;O.html(b.pocketlists.$loading).show().animate({right:"0%"},200);a();b.post("?module=item&action=details",{id:R},function(T){O.html(T);Q()})};var Q=function(){var S={changeMonth:true,changeYear:true,shortYearCutoff:2,dateShowWeek:false,showOtherMonths:true,selectOtherMonths:true,stepMonths:1,numberOfMonths:1,gotoCurrent:true,constrainInput:false};O.find("#pl-item-due-datetime").datepicker(S)};var P=function(){if(O.data("pl-ListDetails")){return}O.data("pl-ListDetails",true);O.on("submit","form",function(T){T.preventDefault();var S=b(this);S.find("#pl-item-details-save").after(b.pocketlists.$loading);h(S.serialize(),function(){S.find("#pl-item-details-save").removeClass("yellow");N()});return false}).on("click","#pl-item-details-cancel",function(S){S.preventDefault();N()}).on("click","#pl-item-priority a",function(S){S.preventDefault();b("#pl-item-priority").find("input").val(b(this).data("pl-item-priority")).trigger("change");b(this).addClass("selected").siblings().removeClass("selected")}).on("click","#pl-item-due-datetime-set",function(T){T.preventDefault();var S=b(this);S.hide().siblings().show().filter("select").prop("disabled",false)}).on("click","#pl-item-due-datetime-clear",function(T){T.preventDefault();var S=b(this);S.hide().siblings().show().filter("select").hide().prop("disabled",true)}).on("click",'[data-pl-action="item-delete"]',function(S){S.preventDefault();o.waDialog({height:"150px","min-height":"150px",width:"400px",onLoad:function(){var T=b(this)},onSubmit:function(T){b.post("?module=item&action=delete",{id:R},function(U){if(U.status==="ok"){s.find('[data-id="'+U.data.id+'"]').remove();T.trigger("close");N();k()}else{}},"json");return false}})}).on("change","#pl-assigned-contact select",function(){var S=b(this).val();b("#pl-assigned-contact").find('[data-pl-contact-id="'+S+'"]').show().siblings().hide()}).on("change paste keyup",":input",function(){O.find("#pl-item-details-save").addClass("yellow")}).on("show.pl2",function(S,T){M(T)}).on("hide.pl2",N);b(window).scroll(function(){a()})};P();return{$el:O,trigger:function(S,T){this.$el&&this.$el.trigger(S,T)},isVisible:function(){return this.$el?this.$el.is(":visible"):false}}}(b("#pl-item-details")));var D=function(){v=b.extend({},v,l);if(v.archive){s.find(":checkbox").prop("disabled",true)}n();e();q.length&&new u();s.on("change",".pl-done",function(){var N=b(this),M=N.closest(t),o=N.is(":checked")?1:0;J(M,o)}).on("change",".pl-is-selected",function(N){var M=b(this),o=M.closest(t),O=(H&&H.data("id")==o.data("id"))?true:false;N.preventDefault();if(!o.find("#pl-item-add").length){if(!y.isVisible()&&!O){y.trigger("hide.pl2");p(o)}else{if(!y.isVisible()){y.trigger("show.pl2",[parseInt(o.data("id"))]);p(o)}else{y.trigger("hide.pl2");r()}}}}).on("click",".pl-edit",function(N){N.preventDefault();var M=b(this),o=M.closest(t);y.trigger("show.pl2",[parseInt(o.data("id"))]);p(o)}).on("click",".pl-favorite",function(N){N.preventDefault();var M=b(this),o=M.closest(t);C(o)}).on("increaseSelectedItem.pl2",function(o){B(o)}).on("decreaseSelectedItem.pl2",function(o){A(o)}).on("deselectItem.pl2",r).on("removeItem.pl2",function(o,M){K(M)}).on("replaceSelectedItem.pl2",function(M,o){z(o)});b(document).on("keydown",function(o){switch(o.which){case 9:if(!(v.list&&v.list.list_details.isVisible())&&!y.isVisible()){if(o.shiftKey){A(o)}else{B(o)}}break;case 27:y.isVisible()&&y.trigger("hide.pl2");break}});F.click(function(){L.slideDown(200);b(this).slideUp(200);return false})};D();return{$el:s,trigger:function(o,M){this.$el&&this.$el.trigger(o,M)}}};function a(){var f=b("#pl-list-content").offset().top;var e=b(window).scrollTop();var c=b(window).height();if(b(".pl-details .fields form").height()>c){return}if(e>f){b(".pl-details").addClass("sticky");var d=b(document).height()-c-e;b(".pl-details").css("bottom",Math.max(0,16-d)+"px")}else{b(".pl-details").removeClass("sticky")}}}(jQuery));