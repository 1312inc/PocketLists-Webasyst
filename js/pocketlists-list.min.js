(function(){var t=parseInt($("#pl-list-id").val()),s=parseInt($("#pl-pocket-id").val()),k=$("#pl-list-items"),o=$("#pl-undone-items > ul.menu-v"),b=$("#pl-complete-log > ul.menu-v"),q=$('<i class="icon16 loading">'),n=$("#pl-new-list-input"),v=$("#pl-item-add").detach(),f=v.find("textarea"),u=$('<div id="pl-item-add-wrapper-hover" style="display: none;">'),l="[data-parent-id]";var j=function(){$("#pl-undone-items ul.menu-v").sortable({item:l,connectWith:"ul.menu-v",placeholder:"pl-item-placeholder",tolerance:"pointer",stop:function(x,z){var w=z.item.parents(l).first(),y=w.length?parseInt(w.data("id")):0;z.item.data("parent-id",y);d.call(z.item,parseInt(z.item.data("id")))}})};var c=function(x){var w={name:$(this).val().trim(),type:"checklist",pocket_id:s};if(w.name){$(this).after(q);$.post("?module=list&action=update",{data:w,id:x},function(y){if(y.status==="ok"){if(t===-1){$.wa.setHash("#/pocket/"+s+"/list/"+y.data.id+"/")}}else{}},"json")}};var h=function(w){var x=$(this);x.after(q);$.post("?module=item&action=create",{list_id:t,data:w},function(z){var A=x.closest(l);var y=$(""+z+"");y.filter(l).last().find(".pl-item").first().after(v);if(A.length){A.after(y)}else{o.prepend(y)}q.remove();f.val("").trigger("focus");d.call(y)})};var m=function(w,x){$.post("?module=item&action=move",{list_id:t,data:w},function(y){if(y.status==="ok"){$.isFunction(x)&&x.call()}else{alert(y.errors)}},"json")};var e=function(){var w=[];o.find(l).each(function(x){var y=$(this);w.push({id:y.data("id"),parent_id:y.data("parent-id"),sort:x,has_children:y.find(l).length?1:0})});return w};var d=function(w){this.find("label").first().append(q);$.post("?module=item&action=sort",{list_id:t,item_id:w?w:0,data:e()},function(x){if(x.status==="ok"){j()}else{alert(x.errors)}q.remove()},"json")};var a=function(y,w,x){this.find("label").first().append(q);this.prop("disabled",true);$.post("?module=item&action=complete",{list_id:t,id:y,status:w},function(z){if(z.status==="ok"){x&&$.isFunction(x)&&x.call()}else{alert(z.errors)}q.remove()},"json")};var p=function(){var w=o.find(".pl-item-selected").closest(l);if(w.length){w.each(function(){var z=$(this),y=z.prev(l);if(y.length){var A=parseInt(y.data("id"));z.data("parent-id",A);var x=y.find("ul.menu-v").first();if(x.length){x.append(z)}else{y.append($('<ul class="menu-v">').html(z))}d.call(z,parseInt(z.data("id")))}})}};var g=function(){var w=o.find(".pl-item-selected").closest(l);if(w.length){w.each(function(){var y=$(this),x=y.parents(l).first();if(x.length){var A=parseInt(x.data("parent-id"));y.data("parent-id",A);var z=y.nextAll(),B=y.find("ul.menu-v");if(!B.length){B=$('<ul class="menu-v">');y.append(B)}B.append(z);x.after(y);d.call(y,parseInt(y.data("id")))}})}};if(n.length){n.focus();n.on("keydown",function(w){if(w.which===13){w.preventDefault();c.call(this,t)}})}$("#pl-item-add-link").click(function(w){w.preventDefault();if(v.is(":visible")){v.slideUp(200,function(){v.detach();$(".pl-new-item-wrapper").remove()})}else{v.prependTo(o).slideDown(200).wrap('<li class="pl-new-item-wrapper">')}f.focus()});f.on("keydown",function(y){var x=$(this);if(y.which===13){y.preventDefault();var w=x.closest(".menu-v").find(l).first().data("parent-id");h.call(this,[{name:x.val().trim(),parent_id:w}])}else{if(y.which===27){v.slideUp(200,function(){v.detach();$(".pl-new-item-wrapper").remove()});f.val("")}}}).on("paste",function(y){var x=$(this).closest(".menu-v").find(l).first().data("parent-id");var w=this;setTimeout(function(){var z=f.val().split(/\n/);var C=[];if(z.length>1){for(var B=0;B<z.length;B++){var A=$.trim(z[B]);if(A){C.push({name:A,parent_id:x})}}h.call(w,C)}},100)});o.on("mouseenter",l+" > .pl-item",function(y){y.stopPropagation();var w=$(this);if(!w.find(v).length){var x=w.closest(l).find(".menu-v");if(x.length){x.find(".pl-item").first().before(u.show())}else{w.after(u.show())}}}).on("mouseleave",function(w){u.detach()});u.on("click",function(w){u.after(v);u.detach();v.slideDown(200);f.focus()});k.on("change",".pl-is-selected",function(A){var z=$(this),w=$("#pl-item-details"),x=w.is(":visible"),y=z.closest(".pl-item"),C=y.closest(l),B=y.hasClass("pl-item-selected");A.preventDefault();if(!x&&!B){w.hide();k.find(".pl-item").removeClass("pl-item-selected");y.addClass("pl-item-selected");z.prop("checked",true)}else{if(!x){w.html(q).show();$.post("?module=item&action=details",{id:parseInt(C.data("id"))},function(D){w.html(D);r(w)});z.prop("checked",true)}else{w.hide();k.find(".pl-item").removeClass("pl-item-selected");z.prop("checked",false)}}});k.on("change",".pl-done",function(z){var y=$(this),x=y.closest(l),A=parseInt(x.data("id")),w=y.is(":checked")?1:0;x.find("ul.menu-v .pl-done").prop("checked",w);a.call(x,A,w,function(){y.prop("disabled",false);x.slideToggle(200,function(){x.show();if(w){b.append(x)}else{o.append(x);d.call(x)}})})});$(document).on("keydown",function(w){switch(w.which){case 39:p.call(this);break;case 9:if(w.shiftKey){g.call(this)}else{p.call(this)}break;case 37:g.call(this);break}});j();var r=function(y){var z=function(){var A={changeMonth:true,changeYear:true,shortYearCutoff:2,dateShowWeek:false,showOtherMonths:true,selectOtherMonths:true,stepMonths:1,numberOfMonths:1,gotoCurrent:true,constrainInput:false,minDate:new Date()};y.find("#pl-item-due-datetime").datepicker(A);x()};var x=function(){y.on("click","#pl-item-details-save",function(B){B.preventDefault();var A=$(this);A.after(q);$.post("?module=item&action=save",A.closest("form").serialize(),function(C){q.remove();if(C.status==="ok"){w();y.find(".success").show().delay(3000).hide()}else{y.find(".error").show().delay(3000).hide()}},"json")});y.on("click","#pl-item-details-cancel",function(A){A.preventDefault();y.hide()});y.on("click","#pl-item-priority a",function(A){A.preventDefault();$("#pl-item-priority").find("input").val($(this).data("pl-item-priority"));$(this).addClass("selected").siblings().removeClass("selected")})};var w=function(){k.find('[data-id="'+y.find('input[name="item[id]"]').val()+'"]').find(".pl-item span").first().text(y.find('input[name="item[name]"]').val())};z()};$(".pl-list-title").on("click",function(x){;var w=$("#pl-list-details");w.html(q).toggle();$.post("?module=list&action=details",{id:parseInt($("#pl-list-id").val())},function(y){w.html(y);i(w)})});var i=function(y){var z=function(){x()};var x=function(){y.on("click","#pl-list-details-save",function(B){B.preventDefault();var A=$(this);A.after(q);$.post("?module=list&action=save",A.closest("form").serialize(),function(C){q.remove();if(C.status==="ok"){w();y.find(".success").show().delay(3000).hide()}else{y.find(".error").show().delay(3000).hide()}},"json")});y.on("click","#pl-list-details-cancel",function(A){A.preventDefault();y.hide()});y.on("click","#pl-list-priority a",function(A){A.preventDefault();$("#pl-list-priority").find("input").val($(this).data("pl-list-priority"));$(this).addClass("selected").siblings().removeClass("selected")})};var w=function(){$("#pl-list-name").text(y.find('input[name="list[name]"]').val())};z()};$("#pl-complete-log-link").click(function(){$("#pl-complete-log").slideToggle(200);$(this).hide(200);return false})}());