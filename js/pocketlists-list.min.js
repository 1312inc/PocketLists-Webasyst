(function(){var z=parseInt($("#pl-list-id").val()),y=parseInt($("#pl-pocket-id").val()),m=$("#pl-list-items"),s=$("#pl-undone-items > ul.menu-v"),b=$("#pl-complete-log > ul.menu-v"),u=$('<i class="icon16 loading">'),q=$("#pl-new-list-input"),D=$("#pl-item-add").detach(),f=D.find("textarea"),A=$('<div id="pl-item-add-wrapper-hover" style="display: none;">'),n="[data-parent-id]",k=$("#pl-item-add-link");var l=function(){$("#pl-undone-items ul.menu-v").sortable({item:n,connectWith:"ul.menu-v",placeholder:"pl-item-placeholder",tolerance:"pointer",stop:function(F,H){var E=H.item.parents(n).first(),G=E.length?parseInt(E.data("id")):0;H.item.data("parent-id",G);d.call(H.item,parseInt(H.item.data("id")))}})};var c=function(F){var E={name:$(this).val().trim(),type:"checklist",pocket_id:y};if(E.name){$(this).after(u);$.post("?module=list&action=update",{data:E,id:F},function(G){if(G.status==="ok"){if(z===-1){$.wa.setHash("#/pocket/"+y+"/list/"+G.data.id+"/")}}else{}},"json")}};var i=function(E,G){var F=$(this);F.after(u);$.post("?module=item&action=create",{list_id:z,data:E},function(I){var J=F.closest(n);var H=$(""+I+"");f.data("can_blur",false);if(J.length){if(!J.parents(n).length||D.prev(".pl-item").length){J.after(H)}else{J.before(H)}}else{s.prepend(H)}H.filter(n).last().find(".pl-item").first().after(D);u.remove();$(".pl-list-empty").removeClass("pl-list-empty");f.val("").trigger("focus").css("height","auto").data("can_blur",true);$.isFunction(G)&&G.call(F);g();d.call(H)})};var p=function(E,F){$.post("?module=item&action=move",{list_id:z,data:E},function(G){if(G.status==="ok"){$.isFunction(F)&&F.call()}else{alert(G.errors)}},"json")};var e=function(){var E=[];s.find(n).each(function(F){var G=$(this);E.push({id:G.data("id"),parent_id:G.data("parent-id"),sort:F,has_children:G.find(n).length?1:0})});return E};var d=function(E){this.find("label").first().append(u);$.post("?module=item&action=sort",{list_id:z,item_id:E?E:0,data:e()},function(F){if(F.status==="ok"){l()}else{alert(F.errors)}u.remove()},"json")};var a=function(H,E,G){var F=this;F.find(".pl-select-label").first().append(u);F.prop("disabled",true);$.post("?module=item&action=complete",{list_id:z,id:H,status:E},function(I){if(I.status==="ok"){$.pocketlists.updateAppCounter();F.find("ul.menu-v").find(":checkbox").prop("checked",E);F.find(".pl-done").prop("disabled",false);F.find(".pl-item-name").toggleClass("gray");setTimeout(function(){F.slideToggle(200,function(){F.show();if(E){b.append(F)}else{s.append(F);d.call(F)}g();$("#pl-complete-log-link").find("i").text($_("Show all "+b.find("[data-id]").length+" completed to-dos"));G&&$.isFunction(G)&&G.call(F)})},500)}else{alert(I.errors)}u.remove()},"json")};var t=function(E){var F=s.find(".pl-item-selected").closest(n);if(F.length){E.preventDefault();E.stopPropagation();F.each(function(){var I=$(this),H=I.prev(n);if(H.length){var J=parseInt(H.data("id"));I.data("parent-id",J);var G=H.find("ul.menu-v").first();if(G.length){G.append(I)}else{H.append($('<ul class="menu-v">').html(I))}d.call(I,parseInt(I.data("id")))}})}};var h=function(E){var F=s.find(".pl-item-selected").closest(n);if(F.length){E.preventDefault();E.stopPropagation();F.each(function(){var H=$(this),G=H.parents(n).first();if(G.length){var J=parseInt(G.data("parent-id"));H.data("parent-id",J);var I=H.nextAll(),K=H.find("ul.menu-v");if(!K.length){K=$('<ul class="menu-v">');H.append(K)}K.append(I);G.after(H);d.call(H,parseInt(H.data("id")))}})}};var o=function(F,G){var E=this.find('[class*="star"]');$.post("?module="+F+"&action=favorite",{id:G,status:E.hasClass("star-empty")?1:0},function(H){if(H.status==="ok"){E.toggleClass("star-empty star")}else{alert(H.errors)}},"json")};var g=function(){$("#pl-lists").find('[data-pl-list-id="'+z+'"]').find(".count").text(s.find("[data-id]").length)};var x=function(){if($.pocketlists_routing.getHash()=="#/todo/"&&$.pocketlists_routing.getHash().indexOf("/team/")>0){D.prependTo(s).slideDown(200).wrap('<li class="pl-new-item-wrapper">');f.focus()}};function B(){var H=$("#pl-list-content").offset().top;var G=$(window).scrollTop();var E=$(window).height();if($(".pl-details .fields form").height()>E){return}if(G>H){$(".pl-details").addClass("sticky");var F=$(document).height()-E-G;$(".pl-details").css("bottom",Math.max(0,16-F)+"px")}else{$(".pl-details").removeClass("sticky")}}x();if(q.length){q.focus();q.on("keydown",function(E){if(E.which===13){E.preventDefault();c.call(this,z)}})}k.on("click",function(F){F.preventDefault();F.stopPropagation();function E(){D.prependTo(s).slideDown(200,function(){f.focus()}).wrap('<li class="pl-new-item-wrapper">')}if(D.is(":visible")){D.slideUp(200,function(){D.detach();$(".pl-new-item-wrapper").remove();E()})}else{E()}});if($(".pl-list-empty").length){k.trigger("click")}function r(){f.css("height","auto");f.css("height",(f.get(0).scrollHeight-parseInt(f.css("padding-top"))-parseInt(f.css("padding-bottom")))+"px")}function C(){D.slideUp(200,function(){D.detach();$(".pl-new-item-wrapper").remove();f.val("")})}f.on("change cut keydown drop paste",function(){window.setTimeout(r,0)}).on("keydown",function(H){var G=$(this);G.data("can_blur",true);if(!H.shiftKey&&H.which===13){H.preventDefault();var F=G.closest(".menu-v").find(n).first().data("parent-id"),E=G.val().trim();i.call(this,[{name:G.val().trim(),parent_id:F}])}else{if(H.which===27){C()}}}).on("paste",function(G){var F=$(this).closest(".menu-v").find(n).first().data("parent-id");var E=this;setTimeout(function(){var H=f.val().split(/\n/);var K=[];if(H.length>1){for(var J=0;J<H.length;J++){var I=$.trim(H[J]);if(I){K.push({name:I,parent_id:F})}}i.call(E,K)}},100)}).on("blur",function(){var H=$(this),G=H.closest(".menu-v").find(n).first().data("parent-id"),F=H.val().trim(),E=H.data("can_blur");if(E){if(F){i.call(this,[{name:F,parent_id:G}],C)}else{C()}}});var w=null;s.on("mouseenter",n+" > .pl-item",function(F){F.stopPropagation();var E=$(this);w=setTimeout(function(){if(!E.find(D).length){E.find(".pl-select-label").append(A.show())}},500)}).on("mouseleave",n+" > .pl-item",function(E){clearTimeout(w);A.detach()});A.on("click",function(G){var E=$(this);var F=E.closest(n).find(".menu-v");f.data("can_blur",false);if(F.length){F.find(".pl-item").first().before(D)}else{E.closest(n).find(".pl-item").first().after(D)}A.detach();D.slideDown(200);f.focus();f.data("can_blur",true)});m.on("change",".pl-is-selected",function(I){var H=$(this),E=$("#pl-item-details"),F=E.is(":visible"),G=H.closest(".pl-item"),K=G.closest(n),J=G.hasClass("pl-item-selected");I.preventDefault();if(!K.find("#pl-item-add").length){if(!F&&!J){E.hide();m.find(".pl-item").removeClass("pl-item-selected");G.addClass("pl-item-selected");H.prop("checked",true)}else{if(!F){$.pocketlists.scrollToTop(200,80);E.html(u).show();B();$.post("?module=item&action=details",{id:parseInt(K.data("id"))},function(L){E.html(L);v(E)});H.prop("checked",true)}else{E.hide().empty();m.find(".pl-item").removeClass("pl-item-selected");H.prop("checked",false)}}}});m.on("change",".pl-done",function(H){var G=$(this),F=G.closest(n),I=parseInt(F.data("id")),E=G.is(":checked")?1:0;a.call(F,I,E)});m.on("click",".pl-favorite",function(G){G.preventDefault();var F=$(this),E=F.closest(n),H=parseInt(E.data("id"));o.call(E,"item",H)});$(document).on("keydown",function(F){switch(F.which){case 9:if(!$("#pl-list-details").is(":visible")&&!$("#pl-item-details").is(":visible")){if(F.shiftKey){h.call(this,F)}else{t.call(this,F)}}break;case 27:if($("#pl-list-details").is(":visible")){$("#pl-list-details").hide().empty();$(".pl-list-title").removeData("pl-clicked")}if($("#pl-item-details").is(":visible")){$("#pl-item-details").hide().empty();var E=m.find(".pl-item-selected");E.removeClass("pl-item-selected").prop("checked",false)}break}});l();var v=function(F){var H=0;var G=function(){var I={changeMonth:true,changeYear:true,shortYearCutoff:2,dateShowWeek:false,showOtherMonths:true,selectOtherMonths:true,stepMonths:1,numberOfMonths:1,gotoCurrent:true,constrainInput:false,minDate:new Date()};F.find("#pl-item-due-datetime").datepicker(I);H=parseInt(F.find('input[name="item[id]"]').val());E()};var E=function(){F.find("form").on("submit",function(J){J.preventDefault();var I=$(this);I.find("#pl-item-details-save").after(u);$.post("?module=item&action=data",I.serialize(),function(K){$.pocketlists.updateAppCounter();u.remove();m.find('[data-id="'+H+'"] > .pl-item').replaceWith($(K).addClass("pl-item-selected"));F.hide().empty()});return false});F.find("#pl-item-details-cancel").on("click",function(I){I.preventDefault();F.hide().empty();$(".pl-list-title").removeData("pl-clicked")});F.find("#pl-item-priority a").on("click",function(I){I.preventDefault();$("#pl-item-priority").find("input").val($(this).data("pl-item-priority"));$(this).addClass("selected").siblings().removeClass("selected")});F.find('[data-pl-action="item-delete"]').on("click",function(I){I.preventDefault();$("#pl-dialog-delete-confirm").waDialog({height:"150px","min-height":"150px",width:"400px",onLoad:function(){var J=$(this)},onSubmit:function(J){$.post("?module=item&action=delete",{id:H,list_id:z},function(K){if(K.status==="ok"){m.find('[data-id="'+K.data.id+'"]').remove();F.find("#pl-item-details-cancel").trigger("click");J.trigger("close")}else{}},"json");return false}})});F.on("change","#pl-assigned-contact select",function(){var I=$(this).val();$("#pl-assigned-contact").find('[data-pl-contact-id="'+I+'"]').show().siblings().hide()})};G()};$(".pl-list-title").on("click",function(H){var E=$("#pl-list-details"),G=$(this),F=G.data("pl-clicked");if($(H.target).closest(".pl-done-label").length){return}if(F==1){$.pocketlists.scrollToTop(200,80);E.html(u).show();B();G.data("pl-clicked",2);$.post("?module=list&action=details",{id:parseInt($("#pl-list-id").val())},function(I){E.html(I);j(E)})}else{if(F==2){G.removeData("pl-clicked");E.hide().empty()}else{G.data("pl-clicked",1)}}}).on("click",'[data-pl-action="list-delete"]',function(E){E.preventDefault();$("#pl-dialog-delete-confirm").waDialog({height:"150px","min-height":"150px",width:"400px",onLoad:function(){var F=$(this)},onSubmit:function(F){$.post("?module=list&action=delete",{list_id:z},function(G){if(G.status==="ok"){F.trigger("close");$.wa.setHash("#/pocket/1/")}else{}},"json");return false}})}).on("click",'[data-pl-action="list-archive"]',function(E){E.preventDefault();$.post("?module=list&action=archive",{list_id:z,archive:1},function(F){if(F.status==="ok"){$.wa.setHash("#/pocket/1/")}else{}},"json")}).on("click",'[data-pl-action="list-sort"]',function(E){E.preventDefault();$.post("?module=list&action=sort",{list_id:z},function(F){if(F.status==="ok"){$.pocketlists_routing.redispatch()}else{}},"json")}).on("click",'[data-pl-action="list-favorite"]',function(G){G.preventDefault();var F=$(this),E=F.closest(".pl-list-title");o.call(E,"list",E.find("#pl-list-id").val())});var j=function(H){var J=0;var G=H.find("#pl-list-icon-dialog").find("ul").data("pl-icons-path");var I=function(){F();J=parseInt(H.find('input[name="list[id]"]').val())};var F=function(){H.find("form").on("submit",function(L){L.preventDefault();var K=$(this);K.find("#pl-list-details-save").after(u);$.post("?module=list&action=save",K.serialize(),function(M){u.remove();if(M.status==="ok"){E();H.find(".success").show().delay(3000).hide()}else{H.find(".error").show().delay(3000).hide()}H.data("pl-clicked",1).hide()},"json");return false});H.find("#pl-list-details-cancel").on("click",function(K){K.preventDefault();H.hide().empty()});H.find("#pl-list-color a").on("click",function(K){K.preventDefault();$("#pl-list-color").find("input").val($(this).data("pl-list-color"));$(this).addClass("selected").siblings().removeClass("selected")});H.find("#pl-list-icon-change a").on("click",function(L){L.preventDefault();var K=$(this);$("#pl-list-icon-dialog").waDialog({onLoad:function(){var M=$(this);$("#pl-list-icon-dialog").on("click","a[data-pl-list-icon]",function(O){O.preventDefault();var N=$(this).data("pl-list-icon");H.find("#pl-list-icon-change").find("input").val($(this).data("pl-list-icon"));K.find("input").val(N);H.find("#pl-list-icon-change .listicon48").css("background-image","url("+G+N+")");M.trigger("close");return false})}})})};var E=function(){var L=H.find('input[name="list[name]"]').val(),K=H.find("[data-pl-list-color].selected").data("pl-list-color"),M=H.find('input[name="list[icon]"]').val();$("#pl-list-name").text(L);$("#pl-lists").find('[data-pl-list-id="'+J+'"]').removeClass().addClass("pl-"+K).find(".pl-list-name").text(L).end().find(".listicon48").css("background-image","url("+G+M+")");$(".pl-items").removeClass().addClass("pl-items pl-"+K)};I()};$("#pl-list-complete").on("click",function(E){E.stopPropagation();$("#pl-dialog-list-archive-complete-all").waDialog({height:"150px","min-height":"150px",width:"400px",onLoad:function(){var F=$(this);F.on("click","[data-pl-action]",function(I){I.preventDefault();var H=$(this),G=H.data("pl-action");H.after(u);if(G==="list-complete-all"){$.post("?module=item&action=complete",{list_id:z,status:1,id:-1},function(J){if(J.status==="ok"){F.trigger("close");$.pocketlists_routing.redispatch()}else{}},"json")}else{if(G==="list-archive"){$.post("?module=list&action=archive",{list_id:z,archive:1},function(J){if(J.status==="ok"){F.trigger("close");$.wa.setHash("#/pocket/"+y)}else{}},"json")}else{if(G==="cancel"){$("#pl-list-complete").prop("checked",false);F.trigger("close");u.remove()}}}})}})});$("#pl-complete-log-link").click(function(){$("#pl-complete-log").slideDown(200);$(this).slideUp(200);return false});$(window).scroll(function(){B()})}());