(function(){$.pocketlists.List=function(i,r){var f=i.find("#pl-new-list-input"),g=parseInt(i.find("#pl-list-id").val()),n=parseInt($("#pl-pocket-id").val()),b=$("#pl-dialog-delete-list-confirm"),d=$("#pl-dialog-list-archive-complete-all"),c=$.extend({},{archive:false},r);var m=(function(v){var u=null;var o=function(){$.pocketlists.scrollToTop(200,80);v.html($.pocketlists.$loading).show().animate({right:"0%"},200);a();$.post("?module=list&action=details",{id:g},function(y){v.html(y);x()})};var t=function(){v.animate({right:"-100%"},200,function(){v.hide().empty()})};var s=function(y){i.find("#pl-list-name").text(y.name);if(y.due_date||y.due_datetime){var z="pl-due-someday";if(y.calc_priority==1){z="pl-due-tomorrow"}else{if(y.calc_priority==2){z="pl-due-today"}else{if(y.calc_priority==3){z="pl-due-overdue"}}}i.find(".pl-list-due").removeClass().addClass("pl-list-due "+z).text(y.due_datetime?y.due_datetime:y.due_date).show()}else{i.find(".pl-list-due").hide()}$("#pl-lists").find('[data-pl-list-id="'+g+'"]').removeClass().addClass("pl-"+y.color).find(".pl-list-name").text(y.name).end().find(".listicon48").css("background-image","url("+u+y.icon+")");$(".pl-items").removeClass().addClass("pl-items pl-"+y.color)};var x=function(){var y={changeMonth:true,changeYear:true,shortYearCutoff:2,dateShowWeek:false,showOtherMonths:true,selectOtherMonths:true,stepMonths:1,numberOfMonths:1,gotoCurrent:true,constrainInput:false};v.find("#pl-list-due-datetime").datepicker(y);u=v.find("#pl-list-icon-dialog").find("ul").data("pl-icons-path")};var w=function(){if(v.data("pl-ListDetails")){return}v.data("pl-ListDetails",true);v.on("submit","form",function(z){z.preventDefault();var y=$(this);y.find("#pl-list-details-save").removeClass("yellow").after($.pocketlists.$loading);$.post("?module=list&action=save",y.serialize(),function(A){$.pocketlists.$loading.remove();if(A.status==="ok"){s(A.data);$.pocketlists.updateAppCounter();t()}else{v.find(".error").show().delay(3000).hide()}},"json");return false}).on("click","#pl-list-details-cancel",function(y){y.preventDefault();t()}).on("click",'[data-pl-action="list-delete"]',function(y){y.preventDefault();l()}).on("click","#pl-list-color a",function(y){y.preventDefault();$("#pl-list-color").find("input").val($(this).data("pl-list-color")).trigger("change");$(this).addClass("selected").siblings().removeClass("selected")}).on("click","#pl-list-due-datetime-set",function(z){z.preventDefault();var y=$(this);y.hide().siblings().show().filter("select").prop("disabled",false)}).on("click","#pl-list-due-datetime-clear",function(z){z.preventDefault();var y=$(this);y.hide().siblings().show().filter("select").hide().prop("disabled",true)}).on("click","#pl-list-icon-change a",function(y){y.preventDefault();$("#pl-list-icon-dialog").waDialog({onLoad:function(){var z=$(this);$("#pl-list-icon-dialog").on("click","a[data-pl-list-icon]",function(C){C.preventDefault();var A=$(this).data("pl-list-icon"),B=$(this);v.find("#pl-list-icon-change").find("input").val($(this).data("pl-list-icon"));B.find("input").val(A);v.find("#pl-list-icon-change .listicon48").css("background-image","url("+u+A+")");v.find("#pl-list-details-save").addClass("yellow");z.trigger("close");return false})}})}).on("change paste keyup",":input",function(){v.find("#pl-list-details-save").addClass("yellow")}).on("show.pl2",o).on("hide.pl2",t);$(window).scroll(function(){a()})};w();return{$el:v,trigger:function(y,z){this.$el&&this.$el.trigger(y,z)},isVisible:function(){return this.$el?this.$el.is(":visible"):false}}}($("#pl-list-details")));var q=function(t){var o=f.val().trim();if(o.length){var s={name:f.val().trim(),type:"checklist",pocket_id:n};if(s.name){$.post("?module=list&action=update",{data:s,id:t},function(u){if(u.status==="ok"){if(g===-1){$.wa.setHash("#/pocket/"+n+"/list/"+u.data.id+"/")}}else{}},"json")}}};var k=function(){var o=i.find('[class*="star"]');$.post("?module=list&action=favorite",{id:g,status:o.hasClass("star-empty")?1:0},function(s){if(s.status==="ok"){o.toggleClass("star-empty star")}else{alert(s.errors)}},"json")};var l=function(){b.waDialog({height:"150px","min-height":"150px",width:"400px",onLoad:function(){},onSubmit:function(o){$.post("?module=list&action=delete",{list_id:g},function(s){if(s.status==="ok"){o.trigger("close");$.wa.setHash("#/pocket/1/")}else{}},"json");return false}})};var e=function(){$.post("?module=list&action=archive",{list_id:g,archive:1},function(o){if(o.status==="ok"){$.wa.setHash("#/pocket/1/")}else{}},"json")};var j=function(){$.post("?module=list&action=sort",{list_id:g},function(o){if(o.status==="ok"){$.pocketlists_routing.redispatch()}else{}},"json")};var h=function(){i.removeData("pl-clicked")};var p=function(){if(f.length){f.focus();f.on("keydown",function(o){f.data("pl-can-add",true);if(o.which===13&&f.data("pl-can-add")){o.preventDefault();q(g)}if(o.which===27){f.data("pl-can-add",false).val("")}}).on("blur",function(){f.data("pl-can-add")&&q(g)})}if(c.archive){i.find(":checkbox").prop("disabled",true)}i.on("click",function(s){if(!c.archive){var o=i.data("pl-clicked");if($(s.target).closest(".pl-done-label").length){return}if(o==1){i.data("pl-clicked",2);$.pocketlists.scrollToTop(200,80);m.trigger("show.pl2")}else{if(o==2){m.trigger("hide.pl2");h()}else{i.data("pl-clicked",1)}}}}).on("click",'[data-pl-action="list-edit"]',function(o){o.preventDefault();o.stopPropagation();i.data("pl-clicked",2);$.pocketlists.scrollToTop(200,80);m.trigger("show.pl2")}).on("click",'[data-pl-action="list-delete"]',function(o){o.preventDefault();l()}).on("click",'[data-pl-action="list-archive"]',function(o){o.preventDefault();e()}).on("click",'[data-pl-action="list-sort"]',function(o){o.preventDefault();j()}).on("click",'[data-pl-action="list-favorite"]',function(o){o.preventDefault();k()}).on("click","#pl-list-complete",function(o){o.stopPropagation();d.waDialog({height:"150px","min-height":"150px",width:"400px",onLoad:function(){var s=$(this);s.on("click","[data-pl-action]",function(v){v.preventDefault();var u=$(this),t=u.data("pl-action");u.after($.pocketlists.$loading);if(t==="list-complete-all"){$.post("?module=list&action=complete",{list_id:g,status:1},function(w){if(w.status==="ok"){s.trigger("close");$.pocketlists_routing.redispatch()}else{}},"json")}else{if(t==="list-archive"){$.post("?module=list&action=archive",{list_id:g,archive:1},function(w){if(w.status==="ok"){s.trigger("close");$.wa.setHash("#/pocket/"+n)}else{}},"json")}else{if(t==="cancel"){$("#pl-list-complete").prop("checked",false);s.trigger("close");$.pocketlists.$loading.remove()}}}})}})}).on("click",'[data-pl-action="list-unarchive"]',function(o){o.preventDefault();$.post("?module=list&action=archive",{list_id:g,archive:0},function(s){if(s.status==="ok"){$.pocketlists.updateAppCounter();$.wa.setHash("#/pocket/"+n+"/list/"+g+"/")}else{}},"json")}).on("deleteList.pl2",l).on("deselectList.pl2",h);$(document).on("keydown",function(o){switch(o.which){case 27:m.isVisible()&&m.trigger("hide.pl2");break}})};p();return{$el:i,list_details:m,list_id:g,pocket_id:n}};$.pocketlists.Items=function(r,k){var v=r.find("#pl-undone-items > ul.menu-v"),w=$("#pl-undone-items").find("ul.menu-v"),K=r.find("#pl-complete-log"),e=K.find("ul.menu-v").first(),H=$("#pl-item-add").detach(),l=H.find("textarea"),F=$('<div id="pl-item-add-wrapper-hover" style="display: none;">'),s="[data-parent-id]",p=$("#pl-item-add-link"),E=$("#pl-complete-log-link"),b=r.find("#pl-empty-list-msg"),G=null,u=$.extend({},{enableAddLinkOnHover:true,enableChangeLevel:true,enableSortItems:true,list:null,assignUser:null,showMessageOnEmptyList:false,dueDate:"",archive:false},k);var d=function(){if(u.enableSortItems){w.sortable({item:s,distance:5,connectWith:"ul.menu-v",placeholder:"pl-item-placeholder",tolerance:"pointer",start:function(L,o){o.placeholder.height(o.helper.outerHeight())},stop:function(L,N){var o=N.item.parents(s).first(),M=o.length?parseInt(o.data("id")):0;N.item.data("parent-id",M);f(parseInt(N.item.data("id")))}})}};var D=function(o,N){var M=$(this);if(u.dueDate){$.each(o,function(O){o[O]["due_date"]=u.dueDate})}var L=M.closest(".pl-item").find(".pl-done-label span").addClass("transparent").html($.pocketlists.$loading);$.post("?module=item&action=create",{list_id:u.list?u.list.list_id:0,data:o,assigned_contact_id:u.assignUser?u.assignUser:false},function(P){$.pocketlists.updateAppCounter();$.pocketlists.$loading.remove();L.removeClass("transparent");var Q=M.closest(s);var O=$(""+P+"");l.data("can_blur",false);if(Q.length){if(!Q.parents(s).length||H.prev(".pl-item").length){Q.after(O)}else{Q.before(O)}}else{v.prepend(O)}O.filter(s).last().find(".pl-item").first().after(H);l.val("").trigger("focus").css("height","auto").data("can_blur",true);$.isFunction(N)&&N.call(M);h();j();f()})};var g=function(L,N){var o=function(R,T){$.pocketlists.updateAppCounter();$.pocketlists.$loading.remove();y(R);if(u.list){var Q=0,P=0,O="";$.each(c(),function(){Q=Math.max(Q,this.priority)});var S=u.list.$el.find(".pl-list-due");if(S.length){switch(S.attr("class").match(/pl-list-due\s(pl-.*)/)[1]){case"pl-due-tomorrow":P=1;break;case"pl-due-today":P=2;break;case"pl-due-overdue":P=3;break}}switch(Math.max(Q,P)){case 1:O=" indicator green";break;case 2:O=" indicator yellow";break;case 3:O=" indicator red";break}$("#pl-lists").find('[data-pl-list-id="'+u.list.list_id+'"] span.count').removeClass().addClass("count"+O)}$.isFunction(T)&&T.call()};var M=function(P,S){var O=P.attr("id");var R=O+"-iframe";if(!$("#"+R).length){P.after("<iframe id="+R+" name="+R+" style='display:none;'></iframe>")}var Q=$("#"+R);P.attr("target",R);Q.one("load",function(){var T=$(this).contents().find("body").html();o(T,S)})};;if(L.find('input[name="item[attachment]"]').val()){M(L,N)}else{$.post("?module=item&action=data",L.serialize(),function(O){o(O,N)})}};var c=function(){var o=[];v.find(s).each(function(N){var O=$(this),L=O.find(".pl-done").length?O.find(".pl-done").attr("class").match(/pl-done\s(pl-.*)/):null,M=0;if(L&&L.length>0){switch(L[1]){case"pl-red":M=3;break;case"pl-yellow":M=2;break;case"pl-green":M=1;break}}o.push({id:O.data("id"),parent_id:O.data("parent-id"),sort:N,has_children:O.find(s).length?1:0,priority:M})});return o};var f=function(o){if(u.enableSortItems&&u.list){$.post("?module=item&action=sort",{list_id:u.list.list_id,item_id:o?o:0,data:c()},function(L){if(L.status==="ok"){d()}else{alert(L.errors)}},"json")}};var I=function(L,o,N){var M=parseInt(L.data("id"));L.prop("disabled",true);$.post("?module=item&action=complete",{id:M,status:o},function(O){if(O.status==="ok"){$.pocketlists.updateAppCounter();L.find("ul.menu-v").find(":checkbox").prop("checked",o);L.find(".pl-done").prop("disabled",false);L.find(".pl-item-name").toggleClass("gray");setTimeout(function(){L.slideToggle(200,function(){if(o){if(e.length){e.prepend(L);L.show()}}else{v.append(L);f()}j();E.show().find("i").text($_("Show all "+e.find("[data-id]").length+" completed to-dos"));m();N&&$.isFunction(N)&&N.call(L)})},800)}else{alert(O.errors)}$.pocketlists.$loading.remove()},"json")};var A=function(o){if(u.enableChangeLevel&&G){o.preventDefault();o.stopPropagation();G.each(function(){var N=$(this),M=N.prev(s);if(M.length){var O=parseInt(M.data("id"));N.data("parent-id",O);var L=M.find("ul.menu-v").first();if(L.length){L.append(N)}else{M.append($('<ul class="menu-v">').html(N))}f(parseInt(N.data("id")))}})}};var z=function(o){if(u.enableChangeLevel&&G){o.preventDefault();o.stopPropagation();G.each(function(){var M=$(this),L=M.parents(s).first();if(L.length){var O=parseInt(L.data("parent-id"));M.data("parent-id",O);var N=M.nextAll(),P=M.find("ul.menu-v");if(!P.length){P=$('<ul class="menu-v">');M.append(P)}P.append(N);L.after(M);f(parseInt(M.data("id")))}})}};var B=function(o){var L=o.find('[class*="star"]'),M=parseInt(o.data("id"));$.post("?module=item&action=favorite",{id:M,status:L.hasClass("star-empty")?1:0},function(N){if(N.status==="ok"){L.toggleClass("star-empty star")}else{alert(N.errors)}},"json")};var n=function(o){G=o;if(G){var L=G.find(".pl-item").first();r.find(".pl-item").removeClass("pl-item-selected");L.addClass("pl-item-selected");G.prop("checked",true)}};var q=function(){if(G){r.find(".pl-item").removeClass("pl-item-selected");G.prop("checked",false);G=null}};var J=function(o){r.find('[data-id="'+o+'"]').remove()};var y=function(o){if(G){G.find(".pl-item").first().replaceWith($(o).addClass("pl-item-selected"))}};var j=function(){if(u.list&&u.list.list_id){$("#pl-lists").find('[data-pl-list-id="'+u.list.list_id+'"]').find(".count").text(v.find("[data-id]").length)}};var i=function(){return !c().length};var m=function(){if(i()&&u.showMessageOnEmptyList){b.show();$(".pl-title h1").css("opacity","0.25")}};var h=function(){if(u.showMessageOnEmptyList){b.hide();$(".pl-title h1").css("opacity","1")}};var t=(function(M){var L=function(){l.css("height","auto");l.css("height",(l.get(0).scrollHeight-parseInt(l.css("padding-top"))-parseInt(l.css("padding-bottom")))+"px")};var o=function(){M.slideUp(200,function(){M.detach();$(".pl-new-item-wrapper").remove();l.val("");m()})};var N=function(){p.on("click",function(Q){Q.preventDefault();Q.stopPropagation();function P(){h();M.prependTo(v).slideDown(200,function(){l.focus()}).wrap('<li class="pl-new-item-wrapper">')}if(M.is(":visible")){M.slideUp(200,function(){M.detach();$(".pl-new-item-wrapper").remove();P()})}else{P()}});if(i()&&!u.showMessageOnEmptyList){p.trigger("click")}l.on("change cut keydown drop paste",function(){window.setTimeout(L,0)}).on("keydown",function(S){var R=$(this);R.data("can_blur",true);if(!S.shiftKey&&S.which===13){S.preventDefault();var Q=R.closest(".menu-v").find(s).first().data("parent-id"),P=R.val().trim();if(P){D.call(this,[{name:P,parent_id:Q}])}}else{if(S.which===27){R.data("can_blur",false);o()}}}).on("paste",function(){var P=this,Q=$(this).closest(".menu-v").find(s).first().data("parent-id");if(!$(this).val().length){setTimeout(function(){var R=l.val().split(/\n/);var U=[];if(R.length>1){for(var T=0;T<R.length;T++){var S=$.trim(R[T]);if(S){U.push({name:S,parent_id:Q})}}D.call(P,U)}},100)}}).on("blur",function(){var S=$(this),R=S.closest(".menu-v").find(s).first().data("parent-id"),Q=S.val().trim(),P=S.data("can_blur");if(P){if(Q){D.call(this,[{name:Q,parent_id:R}],o)}else{o()}}});var O=null;if(u.enableAddLinkOnHover){v.on("mouseenter",s+" > .pl-item",function(Q){Q.stopPropagation();var P=$(this);O=setTimeout(function(){if(!P.find(H).length){P.find(".pl-select-label").append(F.show())}},1312)}).on("mouseleave",s+" > .pl-item",function(){clearTimeout(O);F.detach()});F.on("click",function(R){R.preventDefault();R.stopPropagation();var P=$(this);var Q=P.closest(s).find(".menu-v");l.data("can_blur",false);if(Q.length){Q.find(".pl-item").first().before(H)}else{P.closest(s).find(".pl-item").first().after(H)}F.detach();M.slideDown(200);l.focus();l.data("can_blur",true)})}};p.length&&N();return{hide:o}}(H));var x=(function(N){var Q=0,o=$("#pl-dialog-delete-item-confirm");var M=function(){N.animate({right:"-100%"},200,function(){N.hide().empty()});Q=0;r.trigger("deselectItem.pl2")};var L=function(R){Q=R;N.html($.pocketlists.$loading).show().animate({right:"0%"},200);a();$.post("?module=item&action=details",{id:Q},function(S){N.html(S);P()})};var P=function(){var R={changeMonth:true,changeYear:true,shortYearCutoff:2,dateShowWeek:false,showOtherMonths:true,selectOtherMonths:true,stepMonths:1,numberOfMonths:1,gotoCurrent:true,constrainInput:false};N.find("#pl-item-due-datetime").datepicker(R)};var O=function(){if(N.data("pl-ListDetails")){return}N.data("pl-ListDetails",true);N.on("submit","form",function(S){var R=$(this);R.find("#pl-item-details-save").after($.pocketlists.$loading);g(R,function(){R.find("#pl-item-details-save").removeClass("yellow");M()});if(!R.find('input[name="item[attachment]"]').val()){return false}}).on("click","#pl-item-details-cancel",function(R){R.preventDefault();M()}).on("click","#pl-item-priority a",function(R){R.preventDefault();$("#pl-item-priority").find("input").val($(this).data("pl-item-priority")).trigger("change");$(this).addClass("selected").siblings().removeClass("selected")}).on("click","#pl-item-due-datetime-set",function(S){S.preventDefault();var R=$(this);R.hide().siblings().show().filter("select").prop("disabled",false)}).on("click","#pl-item-due-datetime-clear",function(S){S.preventDefault();var R=$(this);R.hide().siblings().show().filter("select").hide().prop("disabled",true)}).on("click",'[data-pl-action="item-delete"]',function(R){R.preventDefault();o.waDialog({height:"150px","min-height":"150px",width:"400px",onLoad:function(){},onSubmit:function(S){$.post("?module=item&action=delete",{id:Q},function(T){if(T.status==="ok"){r.find('[data-id="'+T.data.id+'"]').remove();S.trigger("close");M();j()}else{}},"json");return false}})}).on("change","#pl-assigned-contact select",function(){var R=$(this).val();$("#pl-assigned-contact").find('[data-pl-contact-id="'+R+'"]').show().siblings().hide()}).on("change paste keyup",":input",function(){N.find("#pl-item-details-save").addClass("yellow")}).on("show.pl2",function(R,S){L(S)}).on("hide.pl2",M);$(window).scroll(function(){a()})};O();return{$el:N,trigger:function(R,S){this.$el&&this.$el.trigger(R,S)},isVisible:function(){return this.$el?this.$el.is(":visible"):false}}}($("#pl-item-details")));var C=function(){if(u.archive){r.find(":checkbox").prop("disabled",true)}m();d();r.on("change",".pl-done",function(){var M=$(this),L=M.closest(s),o=M.is(":checked")?1:0;I(L,o)}).on("change",".pl-is-selected",function(M){if(M.target){var L=$(this),o=L.closest(s),N=(G&&G.data("id")==o.data("id"))?true:false}M.preventDefault();if(!x.isVisible()&&!N){x.trigger("hide.pl2");n(o)}else{if(!x.isVisible()){x.trigger("show.pl2",[parseInt(o.data("id"))]);n(o)}else{x.trigger("hide.pl2");q()}}}).on("click",".pl-edit",function(M){M.preventDefault();var L=$(this),o=L.closest(s);x.trigger("show.pl2",[parseInt(o.data("id"))]);n(o)}).on("click",".pl-favorite",function(M){M.preventDefault();var L=$(this),o=L.closest(s);B(o)}).on("increaseSelectedItem.pl2",function(o){A(o)}).on("decreaseSelectedItem.pl2",function(o){z(o)}).on("deselectItem.pl2",q).on("removeItem.pl2",function(o,L){J(L)}).on("replaceSelectedItem.pl2",function(L,o){y(o)});$(document).on("keydown",function(o){switch(o.which){case 9:if(!(u.list&&u.list.list_details.isVisible())&&!x.isVisible()){if(o.shiftKey){z(o)}else{A(o)}}break;case 27:x.isVisible()&&x.trigger("hide.pl2");break}});E.click(function(){K.slideDown(200);$(this).slideUp(200);return false})};C();return{$el:r,trigger:function(o,L){this.$el&&this.$el.trigger(o,L)}}};function a(){var f=$("#pl-list-content").offset().top;var d=$(window).scrollTop();var b=$(window).height();var e=$(".pl-details");if($(".pl-details .fields form").height()>b){return}if(d>f){e.addClass("sticky");var c=$(document).height()-b-d;e.css("bottom",Math.max(0,16-c)+"px")}else{e.removeClass("sticky")}}}());