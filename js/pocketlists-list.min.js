(function(){var r=parseInt($("#pl-list-id").val()),q=parseInt($("#pl-pocket-id").val()),j=$("#pl-list-items"),n=$("#pl-undone-items > ul.menu-v"),b=$("#pl-complete-log > ul.menu-v"),p=$('<i class="icon16 loading">'),m=$("#pl-new-list-input"),t=$("#pl-item-add").detach(),f=t.find("textarea"),s=$('<div id="pl-item-add-wrapper-hover" style="display: none;">'),k="[data-parent-id]";var i=function(){$("#pl-undone-items ul.menu-v").sortable({item:k,connectWith:"ul.menu-v",placeholder:"pl-item-placeholder",tolerance:"pointer",stop:function(v,x){var u=x.item.parents(k).first(),w=u.length?parseInt(u.data("id")):0;x.item.data("parent-id",w);d.call(x.item,parseInt(x.item.data("id")))}})};var c=function(v){var u={name:$(this).val().trim(),type:"checklist",pocket_id:q};if(u.name){$(this).after(p);$.post("?module=list&action=update",{data:u,id:v},function(w){if(w.status==="ok"){if(r===-1){$.wa.setHash("#/pocket/"+q+"/list/"+w.data.id+"/")}}else{}},"json")}};var h=function(u){var v=$(this);v.after(p);$.post("?module=item&action=create",{list_id:r,data:u},function(x){var y=v.closest(k);var w=$(""+x+"");w.filter(k).last().find(".pl-item").first().after(t);if(y.length){y.after(w)}else{n.prepend(w)}p.remove();f.val("").trigger("focus");d.call(w)})};var l=function(u,v){$.post("?module=item&action=move",{list_id:r,data:u},function(w){if(w.status==="ok"){$.isFunction(v)&&v.call()}else{alert(w.errors)}},"json")};var e=function(){var u=[];n.find(k).each(function(v){var w=$(this);u.push({id:w.data("id"),parent_id:w.data("parent-id"),sort:v,has_children:w.find(k).length?1:0})});return u};var d=function(u){this.find("label").first().append(p);$.post("?module=item&action=sort",{list_id:r,item_id:u?u:0,data:e()},function(v){if(v.status==="ok"){i()}else{alert(v.errors)}p.remove()},"json")};var a=function(w,u,v){this.find("label").first().append(p);this.prop("disabled",true);$.post("?module=item&action=complete",{list_id:r,id:w,status:u},function(x){if(x.status==="ok"){v&&$.isFunction(v)&&v.call()}else{alert(x.errors)}p.remove()},"json")};var o=function(){var u=n.find(".pl-item-selected").closest(k);if(u.length){u.each(function(){var x=$(this),w=x.prev(k);if(w.length){var y=parseInt(w.data("id"));x.data("parent-id",y);var v=w.find("ul.menu-v").first();if(v.length){v.append(x)}else{w.append($('<ul class="menu-v">').html(x))}d.call(x,parseInt(x.data("id")))}})}};var g=function(){var u=n.find(".pl-item-selected").closest(k);if(u.length){u.each(function(){var w=$(this),v=w.parents(k).first();if(v.length){var y=parseInt(v.data("parent-id"));w.data("parent-id",y);var x=w.nextAll(),z=w.find("ul.menu-v");if(!z.length){z=$('<ul class="menu-v">');w.append(z)}z.append(x);v.after(w);d.call(w,parseInt(w.data("id")))}})}};if(m.length){m.focus();m.on("keydown",function(u){if(u.which===13){u.preventDefault();c.call(this,r)}})}$("#pl-item-add-link").click(function(u){u.preventDefault();if(t.is(":visible")){t.slideUp(200,function(){t.detach();$(".pl-new-item-wrapper").remove()})}else{t.prependTo(n).slideDown(200).wrap('<li class="pl-new-item-wrapper">')}f.focus()});f.on("keydown",function(w){var v=$(this);if(w.which===13){w.preventDefault();var u=v.closest(".menu-v").find(k).first().data("parent-id");h.call(this,[{name:v.val().trim(),parent_id:u}])}else{if(w.which===27){t.slideUp(200,function(){t.detach();$(".pl-new-item-wrapper").remove()});f.val("")}}}).on("paste",function(w){var v=$(this).closest(".menu-v").find(k).first().data("parent-id");var u=this;setTimeout(function(){var x=f.val().split(/\n/);var A=[];if(x.length>1){for(var z=0;z<x.length;z++){var y=$.trim(x[z]);if(y){A.push({name:y,parent_id:v})}}h.call(u,A)}},100)});n.on("mouseenter",k+" > .pl-item",function(w){w.stopPropagation();var u=$(this);if(!u.find(t).length){var v=u.closest(k).find(".menu-v");if(v.length){v.find(".pl-item").first().before(s.show())}else{u.after(s.show())}}}).on("mouseleave",function(u){s.detach()});s.on("click",function(u){s.after(t);s.detach();t.slideDown(200);f.focus()});j.on("change",".pl-is-selected",function(y){var x=$(this),u=$("#pl-item-details"),v=u.is(":visible"),w=x.closest(".pl-item"),A=w.closest(k),z=w.hasClass("pl-item-selected");y.preventDefault();if(!v&&!z){u.hide();j.find(".pl-item").removeClass("pl-item-selected");w.addClass("pl-item-selected");x.prop("checked",true)}else{if(!v){u.html(p).show();$.post("?module=item&action=details",{id:parseInt(A.data("id"))},function(B){u.html(B)});x.prop("checked",true)}else{u.hide();j.find(".pl-item").removeClass("pl-item-selected");x.prop("checked",false)}}});j.on("change",".pl-done",function(x){var w=$(this),v=w.closest(k),y=parseInt(v.data("id")),u=w.is(":checked")?1:0;v.find("ul.menu-v .pl-done").prop("checked",u);a.call(v,y,u,function(){w.prop("disabled",false);v.slideToggle(200,function(){v.show();if(u){b.append(v)}else{n.append(v);d.call(v)}})})});$(document).on("keydown",function(u){switch(u.which){case 39:o.call(this);break;case 9:if(u.shiftKey){g.call(this)}else{o.call(this)}break;case 37:g.call(this);break}});i();$("#pl-complete-log-link").click(function(){$("#pl-complete-log").slideToggle(200);$(this).hide(200);return false})}());