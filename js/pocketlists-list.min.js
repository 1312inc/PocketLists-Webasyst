(function(){var s=parseInt($("#pl-list-id").val()),r=parseInt($("#pl-pocket-id").val()),j=$("#pl-list-items"),n=$("#pl-undone-items > ul.menu-v"),b=$("#pl-complete-log > ul.menu-v"),p=$('<i class="icon16 loading">'),m=$("#pl-new-list-input"),u=$("#pl-item-add").detach(),f=u.find("textarea"),t=$('<div id="pl-item-add-wrapper-hover" style="display: none;">'),k="[data-parent-id]";var i=function(){$("#pl-undone-items ul.menu-v").sortable({item:k,connectWith:"ul.menu-v",placeholder:"pl-item-placeholder",tolerance:"pointer",stop:function(w,y){var v=y.item.parents(k).first(),x=v.length?parseInt(v.data("id")):0;y.item.data("parent-id",x);d.call(y.item,parseInt(y.item.data("id")))}})};var c=function(w){var v={name:$(this).val().trim(),type:"checklist",pocket_id:r};if(v.name){$(this).after(p);$.post("?module=list&action=update",{data:v,id:w},function(x){if(x.status==="ok"){if(s===-1){$.wa.setHash("#/pocket/"+r+"/list/"+x.data.id+"/")}}else{}},"json")}};var h=function(v){var w=$(this);w.after(p);$.post("?module=item&action=create",{list_id:s,data:v},function(y){var z=w.closest(k);var x=$(""+y+"");x.filter(k).last().find(".pl-item").first().after(u);if(z.length){z.after(x)}else{n.prepend(x)}p.remove();f.val("").trigger("focus");d.call(x)})};var l=function(v,w){$.post("?module=item&action=move",{list_id:s,data:v},function(x){if(x.status==="ok"){$.isFunction(w)&&w.call()}else{alert(x.errors)}},"json")};var e=function(){var v=[];n.find(k).each(function(w){var x=$(this);v.push({id:x.data("id"),parent_id:x.data("parent-id"),sort:w,has_children:x.find(k).length?1:0})});return v};var d=function(v){this.find("label").first().append(p);$.post("?module=item&action=sort",{list_id:s,item_id:v?v:0,data:e()},function(w){if(w.status==="ok"){i()}else{alert(w.errors)}p.remove()},"json")};var a=function(x,v,w){this.find("label").first().append(p);this.prop("disabled",true);$.post("?module=item&action=complete",{list_id:s,id:x,status:v},function(y){if(y.status==="ok"){w&&$.isFunction(w)&&w.call()}else{alert(y.errors)}p.remove()},"json")};var o=function(){var v=n.find(".pl-item-selected").closest(k);if(v.length){v.each(function(){var y=$(this),x=y.prev(k);if(x.length){var z=parseInt(x.data("id"));y.data("parent-id",z);var w=x.find("ul.menu-v").first();if(w.length){w.append(y)}else{x.append($('<ul class="menu-v">').html(y))}d.call(y,parseInt(y.data("id")))}})}};var g=function(){var v=n.find(".pl-item-selected").closest(k);if(v.length){v.each(function(){var x=$(this),w=x.parents(k).first();if(w.length){var z=parseInt(w.data("parent-id"));x.data("parent-id",z);var y=x.nextAll(),A=x.find("ul.menu-v");if(!A.length){A=$('<ul class="menu-v">');x.append(A)}A.append(y);w.after(x);d.call(x,parseInt(x.data("id")))}})}};if(m.length){m.focus();m.on("keydown",function(v){if(v.which===13){v.preventDefault();c.call(this,s)}})}$("#pl-item-add-link").click(function(v){v.preventDefault();if(u.is(":visible")){u.slideUp(200,function(){u.detach();$(".pl-new-item-wrapper").remove()})}else{u.prependTo(n).slideDown(200).wrap('<li class="pl-new-item-wrapper">')}f.focus()});f.on("keydown",function(x){var w=$(this);if(x.which===13){x.preventDefault();var v=w.closest(".menu-v").find(k).first().data("parent-id");h.call(this,[{name:w.val().trim(),parent_id:v}])}else{if(x.which===27){u.slideUp(200,function(){u.detach();$(".pl-new-item-wrapper").remove()});f.val("")}}}).on("paste",function(x){var w=$(this).closest(".menu-v").find(k).first().data("parent-id");var v=this;setTimeout(function(){var y=f.val().split(/\n/);var B=[];if(y.length>1){for(var A=0;A<y.length;A++){var z=$.trim(y[A]);if(z){B.push({name:z,parent_id:w})}}h.call(v,B)}},100)});n.on("mouseenter",k+" > .pl-item",function(x){x.stopPropagation();var v=$(this);if(!v.find(u).length){var w=v.closest(k).find(".menu-v");if(w.length){w.find(".pl-item").first().before(t.show())}else{v.after(t.show())}}}).on("mouseleave",function(v){t.detach()});t.on("click",function(v){t.after(u);t.detach();u.slideDown(200);f.focus()});j.on("change",".pl-is-selected",function(z){var y=$(this),v=$("#pl-item-details"),w=v.is(":visible"),x=y.closest(".pl-item"),B=x.closest(k),A=x.hasClass("pl-item-selected");z.preventDefault();if(!w&&!A){v.hide();j.find(".pl-item").removeClass("pl-item-selected");x.addClass("pl-item-selected");y.prop("checked",true)}else{if(!w){v.html(p).show();$.post("?module=item&action=details",{id:parseInt(B.data("id"))},function(C){v.html(C);q(v)});y.prop("checked",true)}else{v.hide();j.find(".pl-item").removeClass("pl-item-selected");y.prop("checked",false)}}});j.on("change",".pl-done",function(y){var x=$(this),w=x.closest(k),z=parseInt(w.data("id")),v=x.is(":checked")?1:0;w.find("ul.menu-v .pl-done").prop("checked",v);a.call(w,z,v,function(){x.prop("disabled",false);w.slideToggle(200,function(){w.show();if(v){b.append(w)}else{n.append(w);d.call(w)}})})});$(document).on("keydown",function(v){switch(v.which){case 39:o.call(this);break;case 9:if(v.shiftKey){g.call(this)}else{o.call(this)}break;case 37:g.call(this);break}});i();var q=function(x){var y=function(){var z={changeMonth:true,changeYear:true,shortYearCutoff:2,dateShowWeek:false,showOtherMonths:true,selectOtherMonths:true,stepMonths:1,numberOfMonths:1,gotoCurrent:true,constrainInput:false,minDate:new Date()};x.find("#pl-item-due-datetime").datepicker(z);w()};var w=function(){x.on("click","#pl-item-details-save",function(A){A.preventDefault();var z=$(this);z.after(p);$.post("?module=item&action=save",z.closest("form").serialize(),function(B){p.remove();if(B.status==="ok"){v();x.find(".success").show().delay(3000).hide()}else{x.find(".error").show().delay(3000).hide()}},"json")});x.on("click","#pl-item-details-cancel",function(z){z.preventDefault();x.hide()});x.on("click","#pl-item-priority a",function(z){z.preventDefault();$("#pl-item-priority").find("input").val($(this).data("pl-item-priority"));$(this).addClass("selected").siblings().removeClass("selected")})};var v=function(){j.find('[data-id="'+x.find('input[name="item[id]"]').val()+'"]').find(".pl-item span").first().text(x.find('input[name="item[name]"]').val())};y()};$("#pl-complete-log-link").click(function(){$("#pl-complete-log").slideToggle(200);$(this).hide(200);return false})}());