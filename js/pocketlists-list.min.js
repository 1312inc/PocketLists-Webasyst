(function(){var v=parseInt($("#pl-list-id").val()),u=parseInt($("#pl-pocket-id").val()),m=$("#pl-list-items"),q=$("#pl-undone-items > ul.menu-v"),b=$("#pl-complete-log > ul.menu-v"),s=$('<i class="icon16 loading">'),p=$("#pl-new-list-input"),x=$("#pl-item-add").detach(),g=x.find("textarea"),w=$('<div id="pl-item-add-wrapper-hover" style="display: none;">'),n="[data-parent-id]",k=$("#pl-item-add-link");var l=function(){$("#pl-undone-items ul.menu-v").sortable({item:n,connectWith:"ul.menu-v",placeholder:"pl-item-placeholder",tolerance:"pointer",stop:function(z,B){var y=B.item.parents(n).first(),A=y.length?parseInt(y.data("id")):0;B.item.data("parent-id",A);e.call(B.item,parseInt(B.item.data("id")))}})};var c=function(z){var y={name:$(this).val().trim(),type:"checklist",pocket_id:u};if(y.name){$(this).after(s);$.post("?module=list&action=update",{data:y,id:z},function(A){if(A.status==="ok"){if(v===-1){$.wa.setHash("#/pocket/"+u+"/list/"+A.data.id+"/")}}else{}},"json")}};var i=function(y){var z=$(this);z.after(s);$.post("?module=item&action=create",{list_id:v,data:y},function(B){var C=z.closest(n);var A=$(""+B+"");A.filter(n).last().find(".pl-item").first().after(x);if(C.length){C.after(A)}else{q.prepend(A)}s.remove();g.val("").trigger("focus");$(".pl-list-empty").removeClass("pl-list-empty");e.call(A)})};var o=function(y,z){$.post("?module=item&action=move",{list_id:v,data:y},function(A){if(A.status==="ok"){$.isFunction(z)&&z.call()}else{alert(A.errors)}},"json")};var f=function(){var y=[];q.find(n).each(function(z){var A=$(this);y.push({id:A.data("id"),parent_id:A.data("parent-id"),sort:z,has_children:A.find(n).length?1:0})});return y};var e=function(y){this.find("label").first().append(s);$.post("?module=item&action=sort",{list_id:v,item_id:y?y:0,data:f()},function(z){if(z.status==="ok"){l()}else{alert(z.errors)}s.remove()},"json")};var a=function(A,y,z){this.find("label").first().append(s);this.prop("disabled",true);$.post("?module=item&action=complete",{list_id:v,id:A,status:y},function(B){if(B.status==="ok"){z&&$.isFunction(z)&&z.call()}else{alert(B.errors)}s.remove()},"json")};var r=function(){var y=q.find(".pl-item-selected").closest(n);if(y.length){y.each(function(){var B=$(this),A=B.prev(n);if(A.length){var C=parseInt(A.data("id"));B.data("parent-id",C);var z=A.find("ul.menu-v").first();if(z.length){z.append(B)}else{A.append($('<ul class="menu-v">').html(B))}e.call(B,parseInt(B.data("id")))}})}};var h=function(){var y=q.find(".pl-item-selected").closest(n);if(y.length){y.each(function(){var A=$(this),z=A.parents(n).first();if(z.length){var C=parseInt(z.data("parent-id"));A.data("parent-id",C);var B=A.nextAll(),D=A.find("ul.menu-v");if(!D.length){D=$('<ul class="menu-v">');A.append(D)}D.append(B);z.after(A);e.call(A,parseInt(A.data("id")))}})}};if(p.length){p.focus();p.on("keydown",function(y){if(y.which===13){y.preventDefault();c.call(this,v)}})}k.on("click",function(y){y.preventDefault();y.stopPropagation();if(x.is(":visible")){x.slideUp(200,function(){x.detach();$(".pl-new-item-wrapper").remove()})}else{x.prependTo(q).slideDown(200).wrap('<li class="pl-new-item-wrapper">')}g.focus()});if($(".pl-list-empty").length){k.trigger("click")}g.on("keydown",function(A){var z=$(this);if(!A.shiftKey&&A.which===13){A.preventDefault();var y=z.closest(".menu-v").find(n).first().data("parent-id");i.call(this,[{name:z.val().trim(),parent_id:y}])}else{if(A.which===27){x.slideUp(200,function(){x.detach();$(".pl-new-item-wrapper").remove()});g.val("")}}}).on("paste",function(A){var z=$(this).closest(".menu-v").find(n).first().data("parent-id");var y=this;setTimeout(function(){var B=g.val().split(/\n/);var E=[];if(B.length>1){for(var D=0;D<B.length;D++){var C=$.trim(B[D]);if(C){E.push({name:C,parent_id:z})}}i.call(y,E)}},100)});q.on("mouseenter",n+" > .pl-item",function(A){A.stopPropagation();var y=$(this);if(!y.find(x).length){var z=y.closest(n).find(".menu-v");if(z.length){z.find(".pl-item").first().before(w.show())}else{y.after(w.show())}}}).on("mouseleave",function(y){w.detach()});w.on("click",function(y){w.after(x);w.detach();x.slideDown(200);g.focus()});m.on("change",".pl-is-selected",function(C){var B=$(this),y=$("#pl-item-details"),z=y.is(":visible"),A=B.closest(".pl-item"),E=A.closest(n),D=A.hasClass("pl-item-selected");C.preventDefault();if(!E.find("#pl-item-add").length){if(!z&&!D){y.hide();m.find(".pl-item").removeClass("pl-item-selected");A.addClass("pl-item-selected");B.prop("checked",true)}else{if(!z){y.html(s).show();$.post("?module=item&action=details",{id:parseInt(E.data("id"))},function(F){y.html(F);t(y)});B.prop("checked",true)}else{y.hide().empty();m.find(".pl-item").removeClass("pl-item-selected");B.prop("checked",false)}}}});m.on("change",".pl-done",function(B){var A=$(this),z=A.closest(n),C=parseInt(z.data("id")),y=A.is(":checked")?1:0;z.find("ul.menu-v .pl-done").prop("checked",y);a.call(z,C,y,function(){A.prop("disabled",false);z.slideToggle(200,function(){z.show();if(y){b.append(z)}else{q.append(z);e.call(z)}})})});$(document).on("keydown",function(z){switch(z.which){case 39:r.call(this);break;case 9:if(z.shiftKey){h.call(this)}else{r.call(this)}break;case 37:h.call(this);break;case 27:if($("#pl-list-details").is(":visible")){$("#pl-list-details").hide().empty();$(".pl-list-title").removeData("pl-clicked")}if($("#pl-item-details").is(":visible")){$("#pl-item-details").hide().empty();var y=m.find(".pl-item-selected");y.removeClass("pl-item-selected").prop("checked",false)}break}});l();var t=function(z){var B=0;var A=function(){var C={changeMonth:true,changeYear:true,shortYearCutoff:2,dateShowWeek:false,showOtherMonths:true,selectOtherMonths:true,stepMonths:1,numberOfMonths:1,gotoCurrent:true,constrainInput:false,minDate:new Date()};z.find("#pl-item-due-datetime").datepicker(C);y();B=parseInt(z.find('input[name="item[id]"]').val())};var y=function(){z.on("submit","form",function(D){D.preventDefault();var C=$(this);C.find("#pl-item-details-save").after(s);$.post("?module=item&action=data",C.serialize(),function(E){s.remove();m.find('[data-id="'+B+'"] .pl-item').first().replaceWith($(E).addClass("pl-item-selected"))});return false});z.on("click","#pl-item-details-cancel",function(C){C.preventDefault();z.hide().empty();$(".pl-list-title").removeData("pl-clicked")});z.on("click","#pl-item-priority a",function(C){C.preventDefault();$("#pl-item-priority").find("input").val($(this).data("pl-item-priority"));$(this).addClass("selected").siblings().removeClass("selected")});z.on("click",'[data-pl-action="item-delete"]',function(C){C.preventDefault();$("#pl-dialog-delete-confirm").waDialog({height:"150px","min-height":"150px",width:"400px",onLoad:function(){var D=$(this)},onSubmit:function(D){$.post("?module=item&action=delete",{id:B,list_id:v},function(E){if(E.status==="ok"){m.find('[data-id="'+E.data.id+'"]').remove();z.find("#pl-item-details-cancel").trigger("click");D.trigger("close")}else{}},"json");return false}})})};A()};$(".pl-list-title").on("click",function(B){var y=$("#pl-list-details"),A=$(this),z=A.data("pl-clicked");if(z==1){y.html(s).show();A.data("pl-clicked",2);$.post("?module=list&action=details",{id:parseInt($("#pl-list-id").val())},function(C){y.html(C);j(y)})}else{if(z==2){A.removeData("pl-clicked");y.hide().empty()}else{A.data("pl-clicked",1)}}});var j=function(B){var D=0;var A=B.find("#pl-list-icon-dialog").find("ul").data("pl-icons-path");var C=function(){z();D=parseInt(B.find('input[name="list[id]"]').val())};var z=function(){B.on("submit","form",function(F){F.preventDefault();var E=$(this);E.find("#pl-list-details-save").after(s);$.post("?module=list&action=save",E.serialize(),function(G){s.remove();if(G.status==="ok"){y();B.find(".success").show().delay(3000).hide()}else{B.find(".error").show().delay(3000).hide()}},"json");return false});B.on("click","#pl-list-details-cancel",function(E){E.preventDefault();B.hide().empty()});B.on("click","#pl-list-color a",function(E){E.preventDefault();$("#pl-list-color").find("input").val($(this).data("pl-list-color"));$(this).addClass("selected").siblings().removeClass("selected")});B.on("click","#pl-list-icon-change a",function(F){F.preventDefault();var E=$(this);$("#pl-list-icon-dialog").waDialog({height:"450px",width:"600px",onLoad:function(){var G=$(this);$("#pl-list-icon-dialog").on("click","a[data-pl-list-icon]",function(H){H.preventDefault();$(this).closest("ul").find("a[data-pl-list-icon]").removeClass("selected");$(this).addClass("selected");B.find("#pl-list-icon-change").find("input").val($(this).data("pl-list-icon"))})},onSubmit:function(I){var G=$("#pl-list-icon-dialog").find("a[data-pl-list-icon].selected"),H=G.data("pl-list-icon");E.find("input").val(H);B.find("#pl-list-icon-change .listicon48").css("background-image","url("+A+H+")");I.trigger("close");return false}})})};var y=function(){var F=B.find('input[name="list[name]"]').val(),E=B.find("[data-pl-list-color].selected").data("pl-list-color"),G=B.find('input[name="list[icon]"]').val();$("#pl-list-name").text(F);$("#pl-lists").find('[data-pl-list-id="'+D+'"]').removeClass().addClass("pl-"+E).find(".pl-list-name").text(F).end().find(".listicon48").css("background-image","url("+A+G+")");$(".pl-items").removeClass().addClass("pl-items pl-"+E)};C()};$(".pl-items").on("click",'[data-pl-action="list-delete"]',function(y){y.preventDefault();$("#pl-dialog-delete-confirm").waDialog({height:"150px","min-height":"150px",width:"400px",onLoad:function(){var z=$(this)},onSubmit:function(z){$.post("?module=list&action=delete",{list_id:v},function(A){if(A.status==="ok"){z.trigger("close");$.wa.setHash("#/pocket/1/")}else{}},"json");return false}})});$(".pl-items").on("click",'[data-pl-action="list-archive"]',function(y){y.preventDefault();$.post("?module=list&action=archive",{list_id:v,archive:1},function(z){if(z.status==="ok"){d.trigger("close");$.wa.setHash("#/pocket/1/")}else{}},"json")});$("#pl-list-complete").on("click",function(y){y.stopPropagation();alert("waDialog с предложением либо зачекать все айтемы как выполненные с дополнительным чекбоксом “отправить этот список в архив”")});$("#pl-complete-log-link").click(function(){$("#pl-complete-log").slideDown(200);$(this).slideUp(200);return false})}());