(function(b){b.pocketlists.List=function(i){var f=i.find("#pl-new-list-input"),g=parseInt(i.find("#pl-list-id").val()),n=parseInt(b("#pl-pocket-id").val()),c=b("#pl-dialog-delete-confirm"),d=b("#pl-dialog-list-archive-complete-all");var m=(function(u){var t=null;var q=function(){b.pocketlists.scrollToTop(200,80);u.html(b.pocketlists.$loading).show();a();b.post("?module=list&action=details",{id:g},function(x){u.html(x);w()})};var s=function(){u.hide().empty()};var r=function(x){i.find("#pl-list-name").text(x.name);if(x.due_date||x.due_datetime){var y="pl-due-someday";if(x.calc_priority==1){y="pl-due-tomorrow"}else{if(x.calc_priority==2){y="pl-due-today"}else{if(x.calc_priority==3){y="pl-due-overdue"}}}i.find(".pl-list-due").removeClass().addClass("pl-list-due "+y).text(x.due_datetime?x.due_datetime:x.due_date).show()}else{i.find(".pl-list-due").hide()}b("#pl-lists").find('[data-pl-list-id="'+g+'"]').removeClass().addClass("pl-"+x.color).find(".pl-list-name").text(x.name).end().find(".listicon48").css("background-image","url("+t+x.icon+")");b(".pl-items").removeClass().addClass("pl-items pl-"+x.color)};var w=function(){var x={changeMonth:true,changeYear:true,shortYearCutoff:2,dateShowWeek:false,showOtherMonths:true,selectOtherMonths:true,stepMonths:1,numberOfMonths:1,gotoCurrent:true,constrainInput:false};u.find("#pl-list-due-datetime").datepicker(x);t=u.find("#pl-list-icon-dialog").find("ul").data("pl-icons-path")};var v=function(){if(u.data("pl-ListDetails")){return}u.data("pl-ListDetails",true);u.on("submit","form",function(y){y.preventDefault();var x=b(this);x.find("#pl-list-details-save").after(b.pocketlists.$loading);b.post("?module=list&action=save",x.serialize(),function(z){b.pocketlists.$loading.remove();if(z.status==="ok"){r(z.data);s()}else{u.find(".error").show().delay(3000).hide()}},"json");return false}).on("click","#pl-list-details-cancel",function(x){x.preventDefault();s()}).on("click","#pl-list-color a",function(x){x.preventDefault();b("#pl-list-color").find("input").val(b(this).data("pl-list-color"));b(this).addClass("selected").siblings().removeClass("selected")}).on("click","#pl-list-due-datetime-set",function(y){y.preventDefault();var x=b(this);x.hide().siblings().show().filter("select").prop("disabled",false)}).on("click","#pl-list-due-datetime-clear",function(y){y.preventDefault();var x=b(this);x.hide().siblings().show().filter("select").hide().prop("disabled",true)}).on("click","#pl-list-icon-change a",function(x){x.preventDefault();b("#pl-list-icon-dialog").waDialog({onLoad:function(){var y=b(this);b("#pl-list-icon-dialog").on("click","a[data-pl-list-icon]",function(B){B.preventDefault();var z=b(this).data("pl-list-icon"),A=b(this);u.find("#pl-list-icon-change").find("input").val(b(this).data("pl-list-icon"));A.find("input").val(z);u.find("#pl-list-icon-change .listicon48").css("background-image","url("+t+z+")");y.trigger("close");return false})}})}).on("show.pl2",q).on("hide.pl2",s);b(window).scroll(function(){a()})};v();return{$el:u,trigger:function(x,y){this.$el&&this.$el.trigger(x,y)},isVisible:function(){return this.$el?this.$el.is(":visible"):false}}}(b("#pl-list-details")));var p=function(r){var q={name:f.val().trim(),type:"checklist",pocket_id:n};if(q.name){b.post("?module=list&action=update",{data:q,id:r},function(s){if(s.status==="ok"){if(g===-1){b.wa.setHash("#/pocket/"+n+"/list/"+s.data.id+"/")}}else{}},"json")}};var k=function(){var q=i.find('[class*="star"]');b.post("?module=list&action=favorite",{id:g,status:q.hasClass("star-empty")?1:0},function(s){if(s.status==="ok"){q.toggleClass("star-empty star")}else{alert(s.errors)}},"json")};var l=function(){c.waDialog({height:"150px","min-height":"150px",width:"400px",onLoad:function(){},onSubmit:function(q){b.post("?module=list&action=delete",{list_id:g},function(s){if(s.status==="ok"){q.trigger("close");b.wa.setHash("#/pocket/1/")}else{}},"json");return false}})};var e=function(){b.post("?module=list&action=archive",{list_id:g,archive:1},function(q){if(q.status==="ok"){b.wa.setHash("#/pocket/1/")}else{}},"json")};var j=function(){b.post("?module=list&action=sort",{list_id:g},function(q){if(q.status==="ok"){b.pocketlists_routing.redispatch()}else{}},"json")};var h=function(){i.removeData("pl-clicked")};var o=function(){if(f.length){f.focus();f.on("keydown",function(q){if(q.which===13){q.preventDefault();p(g)}})}i.on("click",function(r){var q=i.data("pl-clicked");if(b(r.target).closest(".pl-done-label").length){return}if(q==1){i.data("pl-clicked",2);b.pocketlists.scrollToTop(200,80);m.trigger("show.pl2")}else{if(q==2){m.trigger("hide.pl2");h()}else{i.data("pl-clicked",1)}}}).on("click",'[data-pl-action="list-delete"]',function(q){q.preventDefault();l()}).on("click",'[data-pl-action="list-archive"]',function(q){q.preventDefault();e()}).on("click",'[data-pl-action="list-sort"]',function(q){q.preventDefault();j()}).on("click",'[data-pl-action="list-favorite"]',function(q){q.preventDefault();k()}).on("click","#pl-list-complete",function(q){q.stopPropagation();d.waDialog({height:"150px","min-height":"150px",width:"400px",onLoad:function(){var r=b(this);r.on("click","[data-pl-action]",function(u){u.preventDefault();var t=b(this),s=t.data("pl-action");t.after(b.pocketlists.$loading);if(s==="list-complete-all"){b.post("?module=list&action=complete",{list_id:g,status:1},function(v){if(v.status==="ok"){r.trigger("close");b.pocketlists_routing.redispatch()}else{}},"json")}else{if(s==="list-archive"){b.post("?module=list&action=archive",{list_id:g,archive:1},function(v){if(v.status==="ok"){r.trigger("close");b.wa.setHash("#/pocket/"+n)}else{}},"json")}else{if(s==="cancel"){b("#pl-list-complete").prop("checked",false);r.trigger("close");b.pocketlists.$loading.remove()}}}})}})}).on("deleteList.pl2",l).on("deselectList.pl2",h);b(document).on("keydown",function(q){switch(q.which){case 27:m.isVisible()&&m.trigger("hide.pl2");break}})};o();return{$el:i,list_details:m,list_id:g,pocket_id:n}};b.pocketlists.Items=function(s,k){var w=s.find("#pl-undone-items > ul.menu-v"),x=b("#pl-undone-items ul.menu-v"),L=s.find("#pl-complete-log"),f=L.find("ul.menu-v").first(),I=b("#pl-item-add").detach(),l=I.find("textarea"),G=b('<div id="pl-item-add-wrapper-hover" style="display: none;">'),t="[data-parent-id]",p=b("#pl-item-add-link"),F=b("#pl-complete-log-link"),c=s.find("#pl-empty-list-msg"),H=null,q={enableAddLinkOnHover:true,enableChangeLevel:true,enableSortItems:true,list:null,assignUser:null,showMessageOnEmptyList:false},v={};var e=function(){if(v.enableSortItems){x.sortable({item:t,connectWith:"ul.menu-v",placeholder:"pl-item-placeholder",tolerance:"pointer",stop:function(M,O){var o=O.item.parents(t).first(),N=o.length?parseInt(o.data("id")):0;O.item.data("parent-id",N);g(parseInt(O.item.data("id")))}})}};var E=function(o,N){var M=b(this);M.closest(".pl-item").find(".pl-done-label span").html(b.pocketlists.$loading);b.post("?module=item&action=create",{list_id:v.list?v.list.list_id:0,data:o,assigned_contact_id:v.assignUser?v.assignUser:false},function(P){var Q=M.closest(t);var O=b(""+P+"");l.data("can_blur",false);if(Q.length){if(!Q.parents(t).length||I.prev(".pl-item").length){Q.after(O)}else{Q.before(O)}}else{w.prepend(O)}O.filter(t).last().find(".pl-item").first().after(I);b.pocketlists.$loading.remove();l.val("").trigger("focus").css("height","auto").data("can_blur",true);b.isFunction(N)&&N.call(M);h();j();g()})};var d=function(){var o=[];w.find(t).each(function(M){var N=b(this);o.push({id:N.data("id"),parent_id:N.data("parent-id"),sort:M,has_children:N.find(t).length?1:0})});return o};var g=function(o){if(v.enableSortItems&&v.list){b.post("?module=item&action=sort",{list_id:v.list.list_id,item_id:o?o:0,data:d()},function(M){if(M.status==="ok"){e()}else{alert(M.errors)}},"json")}};var J=function(M,o,O){var N=parseInt(M.data("id"));M.prop("disabled",true);b.post("?module=item&action=complete",{id:N,status:o},function(P){if(P.status==="ok"){b.pocketlists.updateAppCounter();M.find("ul.menu-v").find(":checkbox").prop("checked",o);M.find(".pl-done").prop("disabled",false);M.find(".pl-item-name").toggleClass("gray");setTimeout(function(){M.slideToggle(200,function(){M.show();if(o){f.append(M)}else{w.append(M);g()}j();b("#pl-complete-log-link").find("i").text($_("Show all "+f.find("[data-id]").length+" completed to-dos"));m();O&&b.isFunction(O)&&O.call(M)})},800)}else{alert(P.errors)}b.pocketlists.$loading.remove()},"json")};var B=function(o){if(v.enableChangeLevel&&H){o.preventDefault();o.stopPropagation();H.each(function(){var O=b(this),N=O.prev(t);if(N.length){var P=parseInt(N.data("id"));O.data("parent-id",P);var M=N.find("ul.menu-v").first();if(M.length){M.append(O)}else{N.append(b('<ul class="menu-v">').html(O))}g(parseInt(O.data("id")))}})}};var A=function(o){if(v.enableChangeLevel&&H){o.preventDefault();o.stopPropagation();H.each(function(){var N=b(this),M=N.parents(t).first();if(M.length){var P=parseInt(M.data("parent-id"));N.data("parent-id",P);var O=N.nextAll(),Q=N.find("ul.menu-v");if(!Q.length){Q=b('<ul class="menu-v">');N.append(Q)}Q.append(O);M.after(N);g(parseInt(N.data("id")))}})}};var C=function(o){var M=o.find('[class*="star"]'),N=parseInt(o.data("id"));b.post("?module="+type+"&action=favorite",{id:N,status:M.hasClass("star-empty")?1:0},function(O){if(O.status==="ok"){M.toggleClass("star-empty star")}else{alert(O.errors)}},"json")};var n=function(o){H=o;if(H){var M=H.find(".pl-item").first();s.find(".pl-item").removeClass("pl-item-selected");M.addClass("pl-item-selected");H.prop("checked",true)}};var r=function(){if(H){s.find(".pl-item").removeClass("pl-item-selected");H.prop("checked",false);H=null}};var K=function(o){s.find('[data-id="'+o+'"]').remove()};var z=function(o){if(H){H.find(".pl-item").first().replaceWith(b(o).addClass("pl-item-selected"))}};var j=function(){if(v.list&&v.list.list_id){b("#pl-lists").find('[data-pl-list-id="'+v.list.list_id+'"]').find(".count").text(w.find("[data-id]").length)}};var i=function(){return !d().length};var m=function(){i()&&v.showMessageOnEmptyList&&c.show()};var h=function(){v.showMessageOnEmptyList&&c.hide()};var u=function(){var M=function(){l.css("height","auto");l.css("height",(l.get(0).scrollHeight-parseInt(l.css("padding-top"))-parseInt(l.css("padding-bottom")))+"px")};var o=function(){I.slideUp(200,function(){I.detach();b(".pl-new-item-wrapper").remove();l.val("");m()})};var N=function(){p.on("click",function(Q){Q.preventDefault();Q.stopPropagation();function P(){h();I.prependTo(w).slideDown(200,function(){l.focus()}).wrap('<li class="pl-new-item-wrapper">')}if(I.is(":visible")){I.slideUp(200,function(){I.detach();b(".pl-new-item-wrapper").remove();P()})}else{P()}});if(i()&&!v.showMessageOnEmptyList){p.trigger("click")}l.on("change cut keydown drop paste",function(){window.setTimeout(M,0)}).on("keydown",function(S){var R=b(this);R.data("can_blur",true);if(!S.shiftKey&&S.which===13){S.preventDefault();var Q=R.closest(".menu-v").find(t).first().data("parent-id"),P=R.val().trim();if(P){E.call(this,[{name:P,parent_id:Q}])}}else{if(S.which===27){o()}}}).on("paste",function(){var P=this,Q=b(this).closest(".menu-v").find(t).first().data("parent-id");if(!b(this).val().length){setTimeout(function(){var R=l.val().split(/\n/);var U=[];if(R.length>1){for(var T=0;T<R.length;T++){var S=b.trim(R[T]);if(S){U.push({name:S,parent_id:Q})}}E.call(P,U)}},100)}}).on("blur",function(){var S=b(this),R=S.closest(".menu-v").find(t).first().data("parent-id"),Q=S.val().trim(),P=S.data("can_blur");if(P){if(Q){E.call(this,[{name:Q,parent_id:R}],o)}else{o()}}});var O=null;if(v.enableAddLinkOnHover){w.on("mouseenter",t+" > .pl-item",function(Q){Q.stopPropagation();var P=b(this);O=setTimeout(function(){if(!P.find(I).length){P.find(".pl-select-label").append(G.show())}},500)}).on("mouseleave",t+" > .pl-item",function(){clearTimeout(O);G.detach()});G.on("click",function(){var P=b(this);var Q=P.closest(t).find(".menu-v");l.data("can_blur",false);if(Q.length){Q.find(".pl-item").first().before(I)}else{P.closest(t).find(".pl-item").first().after(I)}G.detach();I.slideDown(200);l.focus();l.data("can_blur",true)})}};N()};var y=(function(O){var R=0,o=b("#pl-dialog-delete-confirm");var N=function(){O.hide().empty();R=0;s.trigger("deselectItem.pl2")};var M=function(S){R=S;O.html(b.pocketlists.$loading).show();a();b.post("?module=item&action=details",{id:R},function(T){O.html(T);Q()})};var Q=function(){var S={changeMonth:true,changeYear:true,shortYearCutoff:2,dateShowWeek:false,showOtherMonths:true,selectOtherMonths:true,stepMonths:1,numberOfMonths:1,gotoCurrent:true,constrainInput:false};O.find("#pl-item-due-datetime").datepicker(S)};var P=function(){if(O.data("pl-ListDetails")){return}O.data("pl-ListDetails",true);O.on("submit","form",function(T){T.preventDefault();var S=b(this);S.find("#pl-item-details-save").after(b.pocketlists.$loading);b.post("?module=item&action=data",S.serialize(),function(U){b.pocketlists.updateAppCounter();b.pocketlists.$loading.remove();s.trigger("replaceSelectedItem.pl2",[U]);N()});return false}).on("click","#pl-item-details-cancel",function(S){S.preventDefault();N()}).on("click","#pl-item-priority a",function(S){S.preventDefault();b("#pl-item-priority").find("input").val(b(this).data("pl-item-priority"));b(this).addClass("selected").siblings().removeClass("selected")}).on("click","#pl-item-due-datetime-set",function(T){T.preventDefault();var S=b(this);S.hide().siblings().show().filter("select").prop("disabled",false)}).on("click","#pl-item-due-datetime-clear",function(T){T.preventDefault();var S=b(this);S.hide().siblings().show().filter("select").hide().prop("disabled",true)}).on("click",'[data-pl-action="item-delete"]',function(S){S.preventDefault();o.waDialog({height:"150px","min-height":"150px",width:"400px",onLoad:function(){},onSubmit:function(T){b.post("?module=item&action=delete",{id:R,list_id:list.list_id},function(U){if(U.status==="ok"){s.trigger("deselectItem.pl2",[U.data.id]);N();T.trigger("close")}else{}},"json");return false}})}).on("change","#pl-assigned-contact select",function(){var S=b(this).val();b("#pl-assigned-contact").find('[data-pl-contact-id="'+S+'"]').show().siblings().hide()}).on("show.pl2",function(S,T){M(T)}).on("hide.pl2",N);b(window).scroll(function(){a()})};P();return{$el:O,trigger:function(S,T){this.$el&&this.$el.trigger(S,T)},isVisible:function(){return this.$el?this.$el.is(":visible"):false}}}(b("#pl-item-details")));var D=function(){v=b.extend({},q,k);if(b.pocketlists_routing.getHash()=="#/todo/"&&b.pocketlists_routing.getHash().indexOf("/team/")>0){I.prependTo(w).slideDown(200).wrap('<li class="pl-new-item-wrapper">');l.focus()}m();e();p.length&&new u();s.on("change",".pl-done",function(){var N=b(this),M=N.closest(t),o=N.is(":checked")?1:0;J(M,o)}).on("change",".pl-is-selected",function(N){var M=b(this),o=M.closest(t),O=(H&&H.data("id")==o.data("id"))?true:false;N.preventDefault();if(!o.find("#pl-item-add").length){if(!y.isVisible()&&!O){y.trigger("hide.pl2");n(o)}else{if(!y.isVisible()){y.trigger("show.pl2",[parseInt(o.data("id"))]);n(o)}else{y.trigger("hide.pl2");r()}}}}).on("click",".pl-favorite",function(N){N.preventDefault();var M=b(this),o=M.closest(t);C(o)}).on("increaseSelectedItem.pl2",function(o){B(o)}).on("decreaseSelectedItem.pl2",function(o){A(o)}).on("deselectItem.pl2",r).on("removeItem.pl2",function(o,M){K(M)}).on("replaceSelectedItem.pl2",function(M,o){z(o)});b(document).on("keydown",function(o){switch(o.which){case 9:if(!(v.list&&v.list.list_details.isVisible())&&!y.isVisible()){if(o.shiftKey){A(o)}else{B(o)}}break;case 27:y.isVisible()&&y.trigger("hide.pl2");break}});F.click(function(){L.slideDown(200);b(this).slideUp(200);return false})};D();return{$el:s,trigger:function(o,M){this.$el&&this.$el.trigger(o,M)}}};function a(){var f=b("#pl-list-content").offset().top;var e=b(window).scrollTop();var c=b(window).height();if(b(".pl-details .fields form").height()>c){return}if(e>f){b(".pl-details").addClass("sticky");var d=b(document).height()-c-e;b(".pl-details").css("bottom",Math.max(0,16-d)+"px")}else{b(".pl-details").removeClass("sticky")}}}(jQuery));